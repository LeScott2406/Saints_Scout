<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saints Scout ¬∑ Southampton FC</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  :root {
    --red: #D71920; --dark-red: #9E1117; --black: #111111; --surface: #1C1C1C;
    --surface2: #252525; --border: #2E2E2E; --text: #F0F0F0; --muted: #888888;
    --green: #3CB371; --amber: #E8A020; --crimson: #E05050; --white: #FFFFFF;
    --pos-defender:#8B5CF6; --pos-fullback:#3B82F6; --pos-midfielder:#10B981; --pos-winger:#F59E0B; --pos-striker:#EF4444;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--black); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  header { background: linear-gradient(135deg, var(--dark-red) 0%, var(--red) 50%, #B01018 100%); border-bottom: 3px solid rgba(255,255,255,0.2); position: relative; overflow: hidden; }
  header::before { content:''; position:absolute; top:-60px; right:-60px; width:220px; height:220px; border:40px solid rgba(255,255,255,0.06); border-radius:50%; }
  header::after  { content:''; position:absolute; bottom:-40px; left:30%; width:140px; height:140px; border:25px solid rgba(255,255,255,0.04); border-radius:50%; }
  .header-inner { max-width:1400px; margin:0 auto; padding:1.6rem 2rem; display:flex; align-items:center; justify-content:space-between; position:relative; z-index:1; }
  .brand { display:flex; align-items:center; gap:1rem; }
  .brand-icon { width:52px; height:52px; background:rgba(255,255,255,0.15); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; border:2px solid rgba(255,255,255,0.25); }
  .brand-name { font-family:'Bebas Neue',sans-serif; font-size:2.4rem; color:white; letter-spacing:4px; line-height:1; }
  .brand-sub { font-size:0.7rem; color:rgba(255,255,255,0.65); letter-spacing:2px; text-transform:uppercase; font-weight:300; }
  .header-status { font-size:0.8rem; color:rgba(255,255,255,0.7); text-align:right; font-weight:300; }
  #status-text { color:white; font-weight:500; }

  nav { background:var(--surface); border-bottom:1px solid var(--border); }
  .nav-inner { max-width:1400px; margin:0 auto; padding:0 2rem; display:flex; }
  .nav-btn { font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:2px; color:var(--muted); background:none; border:none; border-bottom:3px solid transparent; padding:0.9rem 1.8rem; cursor:pointer; transition:color 0.2s,border-color 0.2s; }
  .nav-btn:hover { color:var(--text); }
  .nav-btn.active { color:white; border-bottom-color:var(--red); }

  main { max-width:1400px; margin:0 auto; padding:2rem; }
  .page { display:none; } .page.active { display:block; }

  /* HOME */
  .upload-zone { border:2px dashed var(--border); border-radius:6px; padding:3rem; text-align:center; background:var(--surface); cursor:pointer; transition:border-color 0.2s,background 0.2s; margin-bottom:2rem; }
  .upload-zone:hover,.upload-zone.drag-over { border-color:var(--red); background:rgba(215,25,32,0.05); }
  .upload-icon { font-size:3rem; margin-bottom:0.75rem; }
  .upload-title { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; letter-spacing:2px; color:white; margin-bottom:0.4rem; }
  .upload-sub { color:var(--muted); font-size:0.88rem; }
  #file-input { display:none; }
  .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:2rem; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-top:3px solid var(--red); border-radius:4px; padding:1.2rem; text-align:center; }
  .stat-value { font-family:'Bebas Neue',sans-serif; font-size:2.2rem; color:var(--red); line-height:1; }
  .stat-label { font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:1.5px; margin-top:0.3rem; }
  .tools-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  .tool-card { background:var(--surface); border:1px solid var(--border); border-left:4px solid var(--red); border-radius:4px; padding:1.5rem; cursor:pointer; transition:border-color 0.2s,background 0.2s; }
  .tool-card:hover { border-left-color:white; background:var(--surface2); }
  .tool-card-icon { font-size:1.8rem; margin-bottom:0.6rem; }
  .tool-card-title { font-family:'Bebas Neue',sans-serif; font-size:1.3rem; letter-spacing:2px; color:var(--red); margin-bottom:0.4rem; }
  .tool-card-desc { color:var(--muted); font-size:0.88rem; line-height:1.6; }

  .section-header { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; letter-spacing:3px; color:white; border-left:4px solid var(--red); padding-left:0.75rem; margin-bottom:1.5rem; }

  /* FILTERS */
  .filter-panel { background:var(--surface); border:1px solid var(--border); border-radius:4px; padding:1.25rem 1.5rem; margin-bottom:1.5rem; }
  .filter-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:1rem; align-items:end; }
  .filter-group { display:flex; flex-direction:column; gap:0.35rem; }
  .filter-label { font-size:0.72rem; text-transform:uppercase; letter-spacing:1.5px; color:var(--muted); font-weight:500; }
  select, input[type=number], textarea { background:var(--surface2); border:1px solid var(--border); color:var(--text); border-radius:3px; padding:0.5rem 0.75rem; font-family:'DM Sans',sans-serif; font-size:0.88rem; width:100%; appearance:none; transition:border-color 0.2s; }
  select { cursor:pointer; }
  select:focus, input[type=number]:focus, textarea:focus { outline:none; border-color:var(--red); }
  .range-row { display:flex; gap:0.5rem; }
  .range-row input { flex:1; }

  /* MULTI-LEAGUE DROPDOWN */
  .league-dropdown { position:relative; }
  .league-trigger {
    background:var(--surface2); border:1px solid var(--border); border-radius:3px;
    padding:0.5rem 0.75rem; font-family:'DM Sans',sans-serif; font-size:0.88rem;
    color:var(--muted); cursor:pointer; width:100%; text-align:left;
    display:flex; align-items:center; justify-content:space-between;
    transition:border-color 0.2s; user-select:none; white-space:nowrap; overflow:hidden;
  }
  .league-trigger.has-selection { color:var(--text); }
  .league-trigger:hover, .league-trigger.open { border-color:var(--red); }
  .league-trigger-arrow { font-size:0.65rem; flex-shrink:0; margin-left:0.4rem; color:var(--muted); transition:transform 0.15s; }
  .league-trigger.open .league-trigger-arrow { transform:rotate(180deg); }
  .league-trigger-text { overflow:hidden; text-overflow:ellipsis; }
  .league-panel {
    display:none; position:absolute; top:calc(100% + 4px); left:0; right:0;
    background:var(--surface2); border:1px solid var(--red); border-radius:3px;
    z-index:100; max-height:200px; overflow-y:auto;
    box-shadow:0 8px 24px rgba(0,0,0,0.5);
  }
  .league-panel.open { display:block; }
  .league-option { display:flex; align-items:center; gap:0.5rem; padding:0.4rem 0.75rem; cursor:pointer; font-size:0.84rem; transition:background 0.1s; }
  .league-option:hover { background:rgba(215,25,32,0.12); }
  .league-option input[type=checkbox] { width:13px; height:13px; accent-color:var(--red); flex-shrink:0; cursor:pointer; appearance:auto; }
  .league-summary { font-size:0.74rem; color:var(--red); margin-top:0.25rem; min-height:1em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* BUTTONS */
  .btn { font-family:'Bebas Neue',sans-serif; letter-spacing:2px; font-size:0.95rem; background:var(--red); color:white; border:none; border-radius:3px; padding:0.55rem 1.5rem; cursor:pointer; transition:background 0.2s; white-space:nowrap; }
  .btn:hover { background:var(--dark-red); }
  .btn-outline { background:transparent; border:1px solid var(--red); color:var(--red); }
  .btn-outline:hover { background:var(--red); color:white; }
  .btn-sm { font-size:0.75rem; padding:0.3rem 0.75rem; letter-spacing:1px; }

  .results-bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.75rem; flex-wrap:wrap; gap:0.5rem; }
  .results-count { font-size:0.85rem; color:var(--muted); }
  .results-count strong { color:white; } .results-count em { color:var(--red); font-style:normal; }

  /* TABLE */
  .table-wrap { overflow-x:auto; border-radius:4px; border:1px solid var(--border); }
  table { width:100%; border-collapse:collapse; font-size:0.84rem; }
  thead { background:var(--surface2); position:sticky; top:44px; z-index:2; }
  th { padding:0.7rem 0.9rem; text-align:left; font-size:0.7rem; text-transform:uppercase; letter-spacing:1.5px; color:var(--muted); font-weight:600; white-space:nowrap; border-bottom:2px solid var(--border); cursor:pointer; user-select:none; }
  th:hover { color:white; } th.sorted { color:var(--red); }
  th .sort-arrow { margin-left:4px; opacity:0.5; font-size:0.65rem; }
  th.sorted .sort-arrow { opacity:1; }
  tbody tr { border-bottom:1px solid var(--border); transition:background 0.15s; cursor:pointer; }
  tbody tr:hover { background:rgba(215,25,32,0.08); }
  td { padding:0.65rem 0.9rem; white-space:nowrap; color:var(--text); }
  td.player-name { font-weight:500; color:white; }
  td.muted { color:var(--muted); font-size:0.8rem; }
  .rank-badge { display:inline-block; font-weight:700; font-size:0.88rem; min-width:40px; text-align:center; }
  .rank-high { color:var(--green); } .rank-mid { color:var(--amber); } .rank-low { color:var(--crimson); }
  .has-note::after { content:'üìù'; font-size:0.7rem; margin-left:5px; opacity:0.8; }
  .has-report::before { content:'üìã'; font-size:0.65rem; margin-right:4px; opacity:0.85; }
  .note-preview-row { background:rgba(255,255,255,0.02); }
  .note-preview-row:hover { background:rgba(215,25,32,0.05); }

  .summary-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-top:1.5rem; }
  /* EMPTY STATES */
  .empty-state { text-align:center; padding:4rem 2rem; color:var(--muted); }
  .empty-icon { font-size:3rem; margin-bottom:1rem; opacity:0.4; }
  .empty-title { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:2px; color:var(--muted); }
  .empty-svg-wrap { margin:0 auto 1.25rem; opacity:0.35; }
  .empty-state p { font-size:0.85rem; margin-top:0.5rem; color:var(--muted); }

  /* STICKY FILTER PANEL */
  .filter-panel-sticky {
    position:sticky; top:0; z-index:50;
    background:var(--surface); border:1px solid var(--border); border-radius:0 0 4px 4px;
    padding:0.9rem 1.5rem; margin-bottom:1.5rem;
    box-shadow:0 4px 16px rgba(0,0,0,0.4);
    border-top:none;
  }
  .filter-panel { background:var(--surface); border:1px solid var(--border); border-radius:4px; padding:1.25rem 1.5rem; margin-bottom:0; }
  .filter-sticky-outer { position:sticky; top:0; z-index:50; margin-bottom:1.5rem; }
  .filter-sticky-outer .filter-panel { border-radius:4px; box-shadow:0 4px 20px rgba(0,0,0,0.45); }

  /* POSITION BADGES */
  .pos-badge { display:inline-block; font-size:0.68rem; font-weight:600; letter-spacing:0.8px; text-transform:uppercase; padding:0.15rem 0.45rem; border-radius:3px; }
  .pos-striker  { background:rgba(215,25,32,0.2);  color:#F27070; border:1px solid rgba(215,25,32,0.35); }
  .pos-winger   { background:rgba(232,160,32,0.2); color:#E8B84A; border:1px solid rgba(232,160,32,0.35); }
  .pos-midfielder{ background:rgba(60,180,130,0.2);color:#5ECBA1; border:1px solid rgba(60,180,130,0.35); }
  .pos-fullback { background:rgba(80,140,220,0.2); color:#7DB8F0; border:1px solid rgba(80,140,220,0.35); }
  .pos-defender { background:rgba(140,100,220,0.2);color:#B090E8; border:1px solid rgba(140,100,220,0.35); }
  .pos-unknown  { background:rgba(136,136,136,0.15);color:var(--muted); border:1px solid var(--border); }

  /* SCATTER ANIMATION */
  @keyframes dotIn { from { opacity:0; transform:scale(0); } to { opacity:1; transform:scale(1); } }
  .scatter-dot-animated { animation: dotIn 0.4s cubic-bezier(0.34,1.56,0.64,1) both; }

  .pagination { display:flex; align-items:center; justify-content:center; gap:0.5rem; margin-top:1rem; }
  .page-btn { font-family:'Bebas Neue',sans-serif; font-size:0.9rem; letter-spacing:1px; background:var(--surface2); border:1px solid var(--border); color:var(--muted); border-radius:3px; padding:0.3rem 0.75rem; cursor:pointer; transition:all 0.15s; }
  .page-btn:hover,.page-btn.active { background:var(--red); color:white; border-color:var(--red); }
  .page-info { font-size:0.8rem; color:var(--muted); padding:0 0.5rem; }
  .divider { border:none; border-top:1px solid var(--border); margin:1.5rem 0; }

  /* MODAL */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:flex-start; justify-content:center; padding:2rem 1rem; overflow-y:auto; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:6px; width:100%; max-width:900px; position:relative; animation:slideUp 0.2s ease; margin:auto; }
  @keyframes slideUp { from{transform:translateY(16px);opacity:0} to{transform:translateY(0);opacity:1} }
  .modal-header { background:linear-gradient(135deg,var(--dark-red),var(--red)); padding:1.5rem; border-radius:6px 6px 0 0; display:flex; align-items:flex-start; justify-content:space-between; }
  .modal-player-name { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:3px; color:white; line-height:1; }
  .modal-player-meta { font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:0.3rem; letter-spacing:1px; }
  .modal-close { background:rgba(255,255,255,0.15); border:none; color:white; font-size:1.1rem; width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .modal-close:hover { background:rgba(255,255,255,0.3); }
  .modal-nav-btn { background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.15); color:white; font-size:1rem; width:30px; height:30px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:background 0.15s; }
  .modal-nav-btn:hover { background:rgba(255,255,255,0.25); }
  .modal-nav-btn:disabled { opacity:0.2; cursor:default; }
  .modal-body { padding:1.5rem; }
  .modal-section-title { font-family:'Bebas Neue',sans-serif; font-size:0.9rem; letter-spacing:2px; color:var(--muted); margin-bottom:0.75rem; margin-top:1.5rem; padding:0.3rem 0 0.3rem 0.7rem; border-left:3px solid var(--red); background:rgba(215,25,32,0.05); border-radius:0 3px 3px 0; }
  .modal-section-title:first-child { margin-top:0; }
  /* Position-coloured elements */
  .pos-col-Defender   { color:var(--pos-defender)!important; border-color:var(--pos-defender)!important; }
  .pos-col-Fullback   { color:var(--pos-fullback)!important; border-color:var(--pos-fullback)!important; }
  .pos-col-Midfielder { color:var(--pos-midfielder)!important; border-color:var(--pos-midfielder)!important; }
  .pos-col-Winger     { color:var(--pos-winger)!important; border-color:var(--pos-winger)!important; }
  .pos-col-Striker    { color:var(--pos-striker)!important; border-color:var(--pos-striker)!important; }

  /* Profile key stats */
  .profile-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:0.6rem; }
  .profile-stat { background:var(--surface2); border:1px solid var(--border); border-top:3px solid var(--border); border-radius:4px; padding:0.7rem; text-align:center; transition:border-color 0.2s; }
  .profile-stat-val { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; color:white; line-height:1; }
  .profile-stat-lbl { font-size:0.65rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-top:0.2rem; }

  /* Model rank rows */
  .model-ranks-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.4rem; }
  .model-rank-row { display:flex; align-items:center; gap:0.6rem; background:var(--surface2); border:1px solid var(--border); border-radius:3px; padding:0.4rem 0.65rem; font-size:0.8rem; }
  .model-rank-name { flex:1; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .model-rank-bar-wrap { width:60px; height:4px; background:var(--border); border-radius:2px; flex-shrink:0; }
  .model-rank-bar { height:4px; border-radius:2px; background:var(--red); transition:width 0.4s; }

  /* Position bar charts */
  .pbar-section { margin-bottom:1.25rem; }
  .pbar-section-title { font-family:'Bebas Neue',sans-serif; font-size:0.82rem; letter-spacing:2px; color:var(--muted); margin-bottom:0.5rem; padding-bottom:0.35rem; border-bottom:1px solid var(--border); text-transform:uppercase; }
  .pbar-row { display:grid; grid-template-columns:160px 52px 1fr 36px; align-items:center; gap:0.5rem; padding:0.28rem 0; }
  .pbar-label { font-size:0.76rem; color:var(--text); text-align:right; line-height:1.3; }
  .pbar-raw { font-size:0.72rem; color:var(--muted); text-align:right; font-variant-numeric:tabular-nums; }
  .pbar-track { height:10px; background:rgba(255,255,255,0.07); border-radius:5px; overflow:hidden; position:relative; }
  .pbar-fill { height:100%; border-radius:5px; transition:width 0.5s cubic-bezier(0.4,0,0.2,1); }
  .pbar-pct { font-size:0.72rem; font-weight:700; font-variant-numeric:tabular-nums; }
  /* Traffic light colours matching the reference charts */
  .pbar-green  { background:linear-gradient(90deg,#7bbf7b,#5ba85b); }
  .pbar-yellow { background:linear-gradient(90deg,#c8b84a,#b0a030); }
  .pbar-orange { background:linear-gradient(90deg,#e0945a,#c87840); }
  .pbar-red    { background:linear-gradient(90deg,#d06060,#b84040); }
  .pbar-green-txt  { color:#7bbf7b; }
  .pbar-yellow-txt { color:#c8c060; }
  .pbar-orange-txt { color:#e0945a; }
  .pbar-red-txt    { color:#d07070; }
  .pbar-low-sample { font-size:0.62rem; color:var(--amber); opacity:0.8; margin-left:0.2rem; vertical-align:middle; cursor:help; }
  .pbar-sample-banner { display:flex; align-items:center; gap:0.4rem; background:rgba(232,160,32,0.1); border:1px solid rgba(232,160,32,0.3); border-radius:4px; padding:0.35rem 0.7rem; margin-bottom:0.75rem; font-size:0.75rem; color:var(--amber); }

  /* Compare bar charts side-by-side */
  .compare-bars-grid { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
  .compare-bars-col-header { font-weight:600; color:white; font-size:0.92rem; margin-bottom:0.15rem; }
  .compare-bars-col-meta { font-size:0.72rem; color:var(--muted); margin-bottom:0.9rem; }
  .compare-bars-section-title { font-family:'Bebas Neue',sans-serif; font-size:0.78rem; letter-spacing:2px; color:var(--muted); margin:0.75rem 0 0.35rem; padding-bottom:0.25rem; border-bottom:1px solid var(--border); text-transform:uppercase; }
  .compare-pbar-row { display:grid; grid-template-columns:130px 42px 1fr 32px; align-items:center; gap:0.4rem; padding:0.22rem 0; }
  .compare-pbar-label { font-size:0.7rem; color:var(--text); text-align:right; line-height:1.2; }
  .compare-pbar-raw { font-size:0.66rem; color:var(--muted); text-align:right; }
  .compare-pbar-track { height:8px; background:rgba(255,255,255,0.07); border-radius:4px; overflow:hidden; }
  .compare-pbar-fill { height:100%; border-radius:4px; }
  .compare-pbar-pct { font-size:0.68rem; font-weight:700; }

  /* Best archetype badge */
  .archetype-badge { display:inline-flex; align-items:center; gap:0.4rem; padding:0.3rem 0.85rem; border-radius:20px; font-size:0.78rem; font-weight:700; letter-spacing:0.5px; }
  .archetype-badge-label { font-size:0.62rem; text-transform:uppercase; letter-spacing:1.5px; opacity:0.7; margin-right:0.1rem; }
  .arch-Defender   { background:rgba(140,100,220,0.2); color:#C4A8F5; border:1px solid rgba(140,100,220,0.4); }
  .arch-Fullback   { background:rgba(80,140,220,0.2);  color:#7DB8F0; border:1px solid rgba(80,140,220,0.4); }
  .arch-Midfielder { background:rgba(60,180,130,0.2);  color:#5ECBA1; border:1px solid rgba(60,180,130,0.4); }
  .arch-Winger     { background:rgba(232,160,32,0.2);  color:#E8B84A; border:1px solid rgba(232,160,32,0.4); }
  .arch-Striker    { background:rgba(215,25,32,0.2);   color:#F07070; border:1px solid rgba(215,25,32,0.4); }
  .arch-Unknown    { background:rgba(136,136,136,0.15);color:var(--muted); border:1px solid var(--border); }

  /* Similar players */
  .similar-list { display:flex; flex-direction:column; gap:0.4rem; }
  .similar-row { display:flex; align-items:center; justify-content:space-between; background:var(--surface2); border:1px solid var(--border); border-radius:3px; padding:0.5rem 0.75rem; font-size:0.83rem; cursor:pointer; transition:background 0.15s,border-color 0.15s; }
  .similar-row:hover { background:rgba(215,25,32,0.1); border-color:var(--red); }
  .similar-name { color:white; font-weight:500; }
  .similar-meta { color:var(--muted); font-size:0.76rem; }

  /* Notes */
  .notes-area { min-height:80px; resize:vertical; line-height:1.5; }
  .notes-actions { display:flex; align-items:center; gap:0.75rem; margin-top:0.5rem; }
  .notes-saved { font-size:0.78rem; color:var(--green); opacity:0; transition:opacity 0.3s; }
  .notes-saved.show { opacity:1; }

  input[type=text] { background:var(--surface2); border:1px solid var(--border); color:var(--text); border-radius:3px; padding:0.5rem 0.75rem; font-family:'DM Sans',sans-serif; font-size:0.88rem; width:100%; transition:border-color 0.2s; }
  input[type=text]:focus { outline:none; border-color:var(--red); }
  .search-bar-wrap { position:relative; margin-bottom:1.5rem; }
  .search-bar-wrap input { padding-left:2.2rem; font-size:1rem; height:42px; }
  .search-icon { position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); color:var(--muted); font-size:0.95rem; pointer-events:none; }

  /* SHORTLIST */
  .nav-badge { background:var(--red); color:white; font-size:0.6rem; font-family:'DM Sans',sans-serif; font-weight:700; border-radius:10px; padding:0.1rem 0.4rem; margin-left:0.35rem; vertical-align:middle; display:none; }
  .nav-badge.visible { display:inline-block; }
  .shortlist-empty { text-align:center; padding:2rem; color:var(--muted); font-size:0.88rem; }
  .shortlist-row { display:flex; align-items:center; justify-content:space-between; background:var(--surface2); border:1px solid var(--border); border-radius:3px; padding:0.55rem 0.85rem; font-size:0.84rem; cursor:pointer; transition:background 0.15s; gap:0.75rem; }
  .shortlist-row:hover { background:rgba(215,25,32,0.08); }
  .shortlist-row-info { flex:1; min-width:0; }
  .shortlist-row-name { color:white; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .shortlist-row-meta { color:var(--muted); font-size:0.76rem; margin-top:0.1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .shortlist-remove { color:var(--muted); background:none; border:none; cursor:pointer; font-size:1rem; flex-shrink:0; padding:0.1rem 0.3rem; border-radius:3px; }
  .shortlist-remove:hover { color:var(--crimson); background:rgba(224,80,80,0.1); }
  .shortlist-actions { display:flex; gap:0.75rem; margin-bottom:1rem; align-items:center; flex-wrap:wrap; }
  /* Position filter tabs */
  .sl-pos-tabs { display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom:1.25rem; }
  .sl-pos-tab { font-family:'Bebas Neue',sans-serif; font-size:0.78rem; letter-spacing:1px; padding:0.3rem 0.85rem; border-radius:3px; border:1px solid var(--border); background:var(--surface2); color:var(--muted); cursor:pointer; transition:all 0.15s; }
  .sl-pos-tab:hover { border-color:var(--red); color:var(--text); }
  .sl-pos-tab.active { background:var(--red); border-color:var(--red); color:white; }
  /* Shortlist section headers (per-position) */
  .sl-section-title { font-family:'Bebas Neue',sans-serif; font-size:0.88rem; letter-spacing:2px; color:var(--red); margin:1.25rem 0 0.5rem; padding-bottom:0.35rem; border-bottom:1px solid var(--border); }
  .sl-section-title:first-child { margin-top:0; }
  /* Watchlist row accent */
  .watchlist-row { background:rgba(232,160,32,0.06); border-color:rgba(232,160,32,0.2); }
  .watchlist-row:hover { background:rgba(232,160,32,0.12); }
  /* Watchlist button in modal */
  .btn-watchlist { border-color:var(--amber); color:var(--amber); }
  .btn-watchlist.added { background:rgba(232,160,32,0.15); border-color:var(--amber); color:var(--amber); }
  .shortlist-list { display:flex; flex-direction:column; gap:0.4rem; }

  /* ADD TO SHORTLIST btn in modal */
  .btn-shortlist { background:transparent; border:1px solid var(--green); color:var(--green); }
  .btn-shortlist:hover { background:var(--green); color:white; }
  .btn-shortlist.added { background:var(--green); color:white; border-color:var(--green); }

  /* COMPARE MODAL */
  .compare-grid { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
  .compare-col-header { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; color:white; margin-bottom:0.75rem; padding-bottom:0.5rem; border-bottom:2px solid var(--red); display:flex; align-items:center; justify-content:space-between; }
  .compare-col-meta { font-size:0.75rem; color:var(--muted); font-family:'DM Sans',sans-serif; font-weight:400; letter-spacing:0; }
  .compare-stat-row { display:flex; align-items:center; justify-content:space-between; padding:0.35rem 0; border-bottom:1px solid rgba(255,255,255,0.04); font-size:0.82rem; gap:0.5rem; }
  .compare-stat-label { color:var(--muted); flex:1; font-size:0.78rem; }
  .compare-stat-val { font-weight:600; min-width:48px; text-align:right; }
  .compare-stat-val.better { color:var(--green); }
  .compare-stat-val.worse  { color:var(--crimson); }
  .compare-stat-val.equal  { color:var(--text); }
  .compare-bar-wrap { flex:1; height:4px; background:var(--border); border-radius:2px; margin:0 0.5rem; overflow:hidden; }
  .compare-bar { height:4px; border-radius:2px; transition:width 0.4s ease; }
  .compare-bar-right { height:4px; border-radius:2px; transition:width 0.4s ease; margin-left:auto; }
  .compare-search-wrap { display:flex; gap:0.5rem; margin-bottom:1rem; }
  .compare-suggestions { background:var(--surface2); border:1px solid var(--red); border-radius:3px; max-height:160px; overflow-y:auto; margin-top:0.25rem; display:none; }
  .compare-sugg-item { padding:0.4rem 0.75rem; cursor:pointer; font-size:0.84rem; }
  .compare-sugg-item:hover { background:rgba(215,25,32,0.12); }
  .preset-tag { display:inline-flex; align-items:center; gap:0.3rem; background:var(--surface2); border:1px solid var(--border); border-radius:3px; padding:0.25rem 0.6rem; font-size:0.8rem; cursor:pointer; transition:border-color 0.15s; }
  .preset-tag:hover { border-color:var(--red); color:var(--red); }
  .scatter-layout { display:grid; grid-template-columns:280px 1fr; gap:1.5rem; align-items:start; }
  .scatter-controls { display:flex; flex-direction:column; gap:1rem; }
  .scatter-control-card { background:var(--surface); border:1px solid var(--border); border-radius:4px; padding:1rem 1.25rem; }
  .scatter-control-title { font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:2px; color:var(--red); margin-bottom:0.75rem; }
  .scatter-chart-wrap { background:var(--surface); border:1px solid var(--border); border-radius:4px; padding:1rem; position:relative; }
  #scatter-svg { width:100%; display:block; }
  .scatter-tooltip { position:absolute; background:rgba(15,15,15,0.96); border:1px solid var(--red); border-radius:4px; padding:0.6rem 0.85rem; font-size:0.8rem; pointer-events:none; opacity:0; transition:opacity 0.15s; z-index:50; max-width:210px; line-height:1.6; white-space:nowrap; }
  .scatter-tooltip strong { color:white; display:block; }
  .scatter-tooltip span { color:var(--muted); font-size:0.75rem; }
  .highlight-tags-wrap { display:flex; flex-wrap:wrap; gap:0.35rem; margin-top:0.5rem; min-height:24px; }
  .highlight-tag { display:inline-flex; align-items:center; gap:0.3rem; background:var(--surface2); border:1px solid var(--border); border-radius:3px; padding:0.2rem 0.5rem; font-size:0.78rem; color:var(--text); }
  .highlight-tag button { background:none; border:none; color:var(--muted); cursor:pointer; font-size:0.9rem; padding:0; line-height:1; }
  .highlight-tag button:hover { color:var(--crimson); }
  .scatter-export-bar { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.75rem; }

  /* SCROLLBAR STYLING */
  ::-webkit-scrollbar { width:5px; height:5px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:10px; }
  ::-webkit-scrollbar-thumb:hover { background:#444; }
  * { scrollbar-width:thin; scrollbar-color:var(--border) transparent; }

  /* AUTO-SAVE INDICATOR */
  .autosave-indicator { font-size:0.75rem; opacity:0; transition:opacity 0.25s; display:flex; align-items:center; gap:0.35rem; }
  .autosave-indicator.unsaved { opacity:1; color:var(--amber); }
  .autosave-indicator.saved   { opacity:1; color:var(--green); }
  .autosave-indicator.saving  { opacity:1; color:var(--muted); }
  @keyframes fadeOut { 0%{opacity:1} 70%{opacity:1} 100%{opacity:0} }
  .autosave-indicator.saved { animation: fadeOut 2.5s forwards; }

  /* PIN BUTTON */
  .pin-btn { background:none; border:none; cursor:pointer; font-size:0.9rem; padding:0.1rem 0.2rem; opacity:0.35; transition:opacity 0.15s, transform 0.15s; line-height:1; flex-shrink:0; }
  .pin-btn:hover { opacity:0.8; transform:scale(1.15); }
  .pin-btn.pinned { opacity:1; filter:drop-shadow(0 0 4px rgba(232,160,32,0.6)); }

  /* KEYBOARD SHORTCUT TOAST */
  #kbd-toast { position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(8px); background:rgba(28,28,28,0.96); border:1px solid var(--border); border-radius:6px; padding:0.5rem 1rem; font-size:0.78rem; color:var(--muted); white-space:nowrap; z-index:9999; opacity:0; transition:opacity 0.2s, transform 0.2s; pointer-events:none; }
  #kbd-toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
  #kbd-toast kbd { background:var(--surface2); border:1px solid var(--border); border-radius:3px; padding:0.1rem 0.4rem; font-size:0.72rem; color:var(--text); font-family:'DM Sans',sans-serif; margin:0 0.15rem; }
  .report-list-panel { background:var(--surface); border:1px solid var(--border); border-radius:4px; overflow:hidden; }
  .report-list-header { padding:0.85rem 1rem; background:var(--surface2); border-bottom:1px solid var(--border); font-family:'Bebas Neue',sans-serif; font-size:0.9rem; letter-spacing:2px; color:var(--red); display:flex; align-items:center; justify-content:space-between; }
  .report-list-search { padding:0.6rem 0.75rem; border-bottom:1px solid var(--border); }
  .report-list-search input { width:100%; background:var(--black); border:1px solid var(--border); color:var(--text); border-radius:3px; padding:0.4rem 0.65rem; font-family:'DM Sans',sans-serif; font-size:0.82rem; }
  .report-list-search input:focus { outline:none; border-color:var(--red); }
  .report-list-items { max-height:calc(100vh - 260px); overflow-y:auto; }
  .report-list-item { padding:0.7rem 1rem; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
  .report-list-item:hover { background:rgba(215,25,32,0.07); }
  .report-list-item.active { background:rgba(215,25,32,0.13); border-left:3px solid var(--red); }
  .report-list-item.active { padding-left:calc(1rem - 3px); }
  .report-item-name { color:white; font-weight:500; font-size:0.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .report-item-meta { color:var(--muted); font-size:0.74rem; margin-top:0.15rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .report-item-conclusion { color:var(--amber); font-size:0.74rem; margin-top:0.2rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-style:italic; }
  .report-empty-list { padding:2rem 1rem; text-align:center; color:var(--muted); font-size:0.84rem; }
  .report-editor { background:var(--surface); border:1px solid var(--border); border-radius:4px; overflow:hidden; }
  .report-editor-header { padding:1rem 1.25rem; background:var(--surface2); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:1rem; }
  .report-editor-name { font-family:'Bebas Neue',sans-serif; font-size:1.3rem; letter-spacing:2px; color:white; }
  .report-editor-meta { font-size:0.78rem; color:var(--muted); margin-top:0.1rem; }
  .report-editor-body { padding:1.25rem; display:flex; flex-direction:column; gap:1rem; }
  .report-section { display:flex; flex-direction:column; gap:0.4rem; }
  .report-section-label { font-family:'Bebas Neue',sans-serif; font-size:0.85rem; letter-spacing:2px; color:var(--red); }
  .report-section-hint { font-size:0.72rem; color:var(--muted); margin-top:-0.15rem; }
  .report-textarea { background:var(--surface2); border:1px solid var(--border); color:var(--text); border-radius:3px; padding:0.65rem 0.85rem; font-family:'DM Sans',sans-serif; font-size:0.85rem; width:100%; line-height:1.65; resize:vertical; min-height:100px; transition:border-color 0.2s; }
  .report-textarea:focus { outline:none; border-color:var(--red); }
  .report-conclusion-input { background:var(--surface2); border:1px solid var(--amber); color:var(--amber); border-radius:3px; padding:0.6rem 0.85rem; font-family:'DM Sans',sans-serif; font-size:0.88rem; width:100%; font-style:italic; transition:border-color 0.2s; }
  .report-conclusion-input::placeholder { color:rgba(232,160,32,0.4); }
  .report-conclusion-input:focus { outline:none; border-color:var(--amber); box-shadow:0 0 0 2px rgba(232,160,32,0.1); }
  .report-actions { display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; padding:1rem 1.25rem; border-top:1px solid var(--border); background:var(--surface2); }
  .report-saved-msg { font-size:0.78rem; color:var(--green); opacity:0; transition:opacity 0.3s; }
  .report-saved-msg.show { opacity:1; }
  .report-new-panel { padding:1.25rem; }
  .report-new-search-wrap { position:relative; }
  .report-new-suggestions { position:absolute; top:100%; left:0; right:0; background:var(--surface2); border:1px solid var(--red); border-radius:0 0 3px 3px; max-height:200px; overflow-y:auto; z-index:20; display:none; }
  .report-new-sugg-item { padding:0.5rem 0.85rem; cursor:pointer; font-size:0.84rem; border-bottom:1px solid var(--border); transition:background 0.1s; }
  .report-new-sugg-item:hover { background:rgba(215,25,32,0.1); }
  .report-new-sugg-name { color:white; font-weight:500; }
  .report-new-sugg-meta { color:var(--muted); font-size:0.76rem; margin-left:0.5rem; }
  /* TRACKING STAGE */
  .stage-pill { display:inline-flex; align-items:center; gap:0.3rem; font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; padding:0.18rem 0.55rem; border-radius:20px; white-space:nowrap; }
  .stage-Track        { background:rgba(136,136,136,0.15); color:#999; border:1px solid rgba(136,136,136,0.3); }
  .stage-Video\ Scout { background:rgba(80,140,220,0.15); color:#7DB8F0; border:1px solid rgba(80,140,220,0.3); }
  .stage-Senior\ Viewing { background:rgba(232,160,32,0.15); color:#E8B84A; border:1px solid rgba(232,160,32,0.3); }
  .stage-Shortlist    { background:rgba(60,180,130,0.15); color:#5ECBA1; border:1px solid rgba(60,180,130,0.3); }
  .stage-Push         { background:rgba(215,25,32,0.18); color:#F05060; border:1px solid rgba(215,25,32,0.35); }

  /* REPORTS SUMMARY VIEW */
  .report-view-toggle { display:flex; gap:0; border:1px solid var(--border); border-radius:3px; overflow:hidden; }
  .report-view-btn { background:none; border:none; color:var(--muted); padding:0.35rem 0.7rem; cursor:pointer; font-size:0.9rem; transition:background 0.15s,color 0.15s; }
  .report-view-btn.active { background:var(--red); color:white; }
  .report-summary-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1rem; }
  .report-card { background:var(--surface); border:1px solid var(--border); border-radius:4px; overflow:hidden; cursor:pointer; transition:border-color 0.2s,transform 0.15s; }
  .report-card:hover { border-color:var(--red); transform:translateY(-2px); }
  .report-card-top { padding:0.85rem 1rem 0.7rem; border-bottom:1px solid var(--border); }
  .report-card-name { font-weight:600; color:white; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:0.2rem; }
  .report-card-meta { color:var(--muted); font-size:0.74rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .report-card-body { padding:0.65rem 1rem; }
  .report-card-conclusion { font-style:italic; color:var(--amber); font-size:0.78rem; line-height:1.5; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:2.4em; }
  .report-card-footer { display:flex; align-items:center; justify-content:space-between; padding:0.55rem 1rem; background:var(--surface2); gap:0.5rem; }
  .report-card-date { color:var(--muted); font-size:0.7rem; }
  .report-stage-select { background:none; border:none; font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; cursor:pointer; border-radius:20px; padding:0.18rem 0.55rem; appearance:none; -webkit-appearance:none; }

  /* STAGE FILTER TABS */
  .stage-filter-wrap { display:flex; gap:0.35rem; flex-wrap:wrap; margin-bottom:1.25rem; align-items:center; }
  .stage-filter-btn { font-size:0.75rem; font-weight:600; letter-spacing:0.6px; text-transform:uppercase; padding:0.3rem 0.85rem; border-radius:20px; border:1px solid var(--border); background:none; color:var(--muted); cursor:pointer; transition:all 0.15s; }
  .stage-filter-btn:hover { border-color:var(--red); color:var(--text); }
  .stage-filter-btn.active { background:var(--red); border-color:var(--red); color:white; }

  .has-report::before { content:'üìã'; font-size:0.7rem; margin-right:4px; opacity:0.9; }

  @media (max-width:768px) {
    .stats-grid,.summary-grid { grid-template-columns:repeat(2,1fr); }
    .tools-grid { grid-template-columns:1fr; }
    .header-inner { flex-direction:column; gap:0.75rem; text-align:center; }
    .profile-grid { grid-template-columns:repeat(2,1fr); }
    .model-ranks-grid { grid-template-columns:1fr; }
  }

  /* PIPELINE BOARD */
  .pipeline-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; }
  .pipeline-title { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; letter-spacing:3px; color:white; }
  .pipeline-meta { font-size:0.78rem; color:var(--muted); }
  .pipeline-board { display:grid; grid-template-columns:repeat(5,1fr); gap:1rem; align-items:start; min-height:70vh; }
  .pipeline-col { background:var(--surface); border:1px solid var(--border); border-radius:6px; overflow:hidden; }
  .pipeline-col-header { padding:0.75rem 1rem; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .pipeline-col-title { font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:2px; }
  .pipeline-col-count { font-size:0.72rem; font-weight:700; background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:0.1rem 0.5rem; color:var(--muted); }
  .pipeline-col-body { padding:0.6rem; min-height:120px; display:flex; flex-direction:column; gap:0.5rem; }
  .pipeline-col-body.drag-over { background:rgba(215,25,32,0.06); outline:2px dashed var(--red); outline-offset:-4px; border-radius:4px; }
  .pipeline-card { background:var(--surface2); border:1px solid var(--border); border-radius:4px; padding:0.65rem 0.75rem; cursor:grab; transition:transform 0.15s, border-color 0.15s, box-shadow 0.15s; user-select:none; }
  .pipeline-card:hover { border-color:var(--red); transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.4); }
  .pipeline-card.dragging { opacity:0.4; cursor:grabbing; }
  .pipeline-card-name { font-weight:600; font-size:0.85rem; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:0.2rem; }
  .pipeline-card-meta { font-size:0.7rem; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:0.4rem; }
  .pipeline-card-footer { display:flex; align-items:center; justify-content:space-between; gap:0.4rem; }
  .pipeline-card-pos { font-size:0.65rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--muted); }
  .pipeline-card-age { font-size:0.65rem; color:var(--muted); }
  .pipeline-card-pin { font-size:0.7rem; opacity:0.6; }
  .pipeline-card-open { font-size:0.65rem; color:var(--red); cursor:pointer; text-decoration:underline; opacity:0.8; }
  .pipeline-card-open:hover { opacity:1; }
  .pipeline-empty { text-align:center; padding:1.5rem 0.5rem; color:var(--muted); font-size:0.75rem; opacity:0.5; }
  .pipeline-summary { display:grid; grid-template-columns:repeat(5,1fr); gap:1rem; margin-bottom:1.25rem; }
  .pipeline-summary-card { background:var(--surface); border:1px solid var(--border); border-radius:4px; padding:0.85rem 1rem; text-align:center; border-top:3px solid; cursor:pointer; transition:background 0.15s, border-color 0.15s; }
  .pipeline-summary-card:hover { background:var(--surface2); }
  .pipeline-summary-card.active { background:var(--surface2); border-color: var(--red); outline: 1px solid var(--red); }
  .pipeline-summary-num { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; line-height:1; }
  .pipeline-summary-lbl { font-size:0.65rem; color:var(--muted); text-transform:uppercase; letter-spacing:1.5px; margin-top:0.2rem; }

  /* Stage accent colours */
  .pipe-col-Track          { border-top:3px solid #888; }
  .pipe-col-Track .pipeline-col-title { color:#999; }
  .pipe-col-Video\ Scout   { border-top:3px solid #5B8FD4; }
  .pipe-col-Video\ Scout .pipeline-col-title { color:#7DB8F0; }
  .pipe-col-Senior\ Viewing{ border-top:3px solid #C89020; }
  .pipe-col-Senior\ Viewing .pipeline-col-title { color:#E8B84A; }
  .pipe-col-Shortlist      { border-top:3px solid #3CB371; }
  .pipe-col-Shortlist .pipeline-col-title { color:#5ECBA1; }
  .pipe-col-Push           { border-top:3px solid var(--red); }
  .pipe-col-Push .pipeline-col-title { color:#F05060; }

  /* RANK TABLE */
  .rank-table { width:100%; border-collapse:collapse; font-size:0.83rem; }
  .rank-table th { font-family:'Bebas Neue',sans-serif; font-size:0.72rem; letter-spacing:1.5px; color:var(--muted); text-align:left; padding:0.5rem 0.75rem; border-bottom:1px solid var(--border); white-space:nowrap; }
  .rank-table th.num { text-align:right; }
  .rank-table td { padding:0.55rem 0.75rem; border-bottom:1px solid rgba(255,255,255,0.04); vertical-align:middle; }
  .rank-table tr:last-child td { border-bottom:none; }
  .rank-table tbody tr:hover td { background:rgba(255,255,255,0.03); cursor:pointer; }
  .rank-num { font-family:'Bebas Neue',sans-serif; font-size:1rem; color:var(--muted); width:2.2rem; text-align:center; }
  .rank-num.top3 { color:var(--red); }
  .rank-player-name { font-weight:600; color:var(--text); font-size:0.85rem; white-space:nowrap; }
  .rank-player-name.highlighted { color:white; }
  .rank-player-meta { font-size:0.72rem; color:var(--muted); margin-top:1px; white-space:nowrap; }
  .rank-age { color:var(--muted); font-size:0.82rem; text-align:right; white-space:nowrap; }
  .rank-comp { color:var(--muted); font-size:0.78rem; text-align:center; white-space:nowrap; }
  .rank-mins { color:var(--muted); font-size:0.82rem; text-align:right; white-space:nowrap; }
  .rank-val-cell { text-align:right; white-space:nowrap; min-width:90px; }
  .rank-val-num { font-weight:700; font-size:0.88rem; color:var(--text); }
  .rank-val-bar { height:3px; border-radius:2px; margin-top:3px; margin-left:auto; }
  .rank-table-header { display:flex; align-items:baseline; justify-content:space-between; margin-bottom:0.75rem; flex-wrap:wrap; gap:0.5rem; }
  .rank-table-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; color:var(--text); }
  .rank-table-sub { font-size:0.72rem; color:var(--muted); }
  .rank-table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:6px; overflow:hidden; }

  /* MODAL TABS */
  .modal-tabs { display:flex; gap:0; border-bottom:1px solid var(--border); margin-bottom:1.25rem; background:var(--surface2); border-radius:0; }
  .modal-tab { font-family:'Bebas Neue',sans-serif; font-size:0.78rem; letter-spacing:1.5px; color:var(--muted); background:none; border:none; border-bottom:2px solid transparent; padding:0.65rem 1.1rem; cursor:pointer; transition:color 0.15s,border-color 0.15s; white-space:nowrap; }
  .modal-tab:hover { color:var(--text); }
  .modal-tab.active { color:white; border-bottom-color:var(--red); }
  .modal-tab-panel { display:none; }
  .modal-tab-panel.active { display:block; }
  /* MODAL STICKY FOOTER */
  .modal-sticky-footer { position:sticky; bottom:0; background:var(--surface); border-top:1px solid var(--border); padding:0.65rem 1.5rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; z-index:10; border-radius:0 0 6px 6px; }
  /* SCATTER PERSISTENT INFO PANEL */
  .scatter-info-panel { background:var(--surface2); border:1px solid var(--border); border-radius:4px; padding:0.65rem 0.85rem; font-size:0.8rem; min-height:72px; margin-bottom:0.75rem; transition:border-color 0.2s; }
  .scatter-info-panel.has-data { border-color:var(--red); }
  .scatter-info-name { font-weight:600; color:white; font-size:0.9rem; margin-bottom:0.2rem; }
  .scatter-info-meta { color:var(--muted); font-size:0.75rem; margin-bottom:0.4rem; }
  .scatter-info-vals { color:var(--text); font-size:0.78rem; line-height:1.7; }
  .scatter-info-empty { color:var(--muted); font-size:0.78rem; padding-top:0.5rem; }

  /* SHORTLIST/WATCHLIST TAB TOGGLE */
  .sl-view-tabs { display:flex; gap:0; border-bottom:1px solid var(--border); margin-bottom:1.25rem; }
  .sl-view-tab { font-family:'Bebas Neue',sans-serif; font-size:0.82rem; letter-spacing:1.5px; color:var(--muted); background:none; border:none; border-bottom:2px solid transparent; padding:0.55rem 1.1rem; cursor:pointer; transition:color 0.15s,border-color 0.15s; }
  .sl-view-tab:hover { color:var(--text); }
  .sl-view-tab.active { color:white; border-bottom-color:var(--red); }

  /* AGE CURVE */
  #modal-age-curve { margin-bottom:1.25rem; }
  .age-curve-wrap { background:var(--surface2); border:1px solid var(--border); border-radius:4px; padding:0.75rem 0.5rem 0.5rem; position:relative; }
  .age-curve-wrap svg { display:block; width:100%; overflow:visible; }
  .age-curve-tooltip { position:absolute; background:var(--surface); border:1px solid var(--border); border-radius:3px; padding:0.3rem 0.6rem; font-size:0.75rem; color:var(--text); pointer-events:none; white-space:nowrap; opacity:0; transition:opacity 0.15s; z-index:10; }
  .age-curve-legend { display:flex; gap:1rem; margin-top:0.5rem; padding:0 0.5rem; font-size:0.7rem; color:var(--muted); flex-wrap:wrap; }
  .age-curve-legend-item { display:flex; align-items:center; gap:0.3rem; }
  .age-curve-legend-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

  /* TARGET POSITIONS */
  .targets-layout { display:grid; grid-template-columns:300px 1fr; gap:1.5rem; align-items:start; }
  .targets-sidebar { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:1.25rem; position:sticky; top:1rem; }
  .targets-sidebar-title { font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:2px; color:white; margin-bottom:1rem; }
  .target-need-form { display:flex; flex-direction:column; gap:0.6rem; }
  .target-need-form select, .target-need-form input { width:100%; }
  .target-form-row { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; }
  .targets-needs-list { margin-top:1.1rem; display:flex; flex-direction:column; gap:0.5rem; }
  .targets-needs-empty { font-size:0.78rem; color:var(--muted); text-align:center; padding:0.75rem 0; }
  .target-need-pill { display:flex; align-items:flex-start; justify-content:space-between; background:var(--surface2); border:1px solid var(--border); border-left:3px solid var(--red); border-radius:4px; padding:0.5rem 0.65rem; gap:0.5rem; }
  .target-need-pill-info { flex:1; }
  .target-need-pill-archetype { font-size:0.82rem; font-weight:600; color:white; }
  .target-need-pill-meta { font-size:0.68rem; color:var(--muted); margin-top:0.1rem; }
  .target-need-remove { background:none; border:none; color:var(--muted); cursor:pointer; font-size:1rem; flex-shrink:0; }
  .target-need-remove:hover { color:var(--crimson); }
  .targets-results { display:flex; flex-direction:column; gap:1.5rem; }
  .target-result-block { background:var(--surface); border:1px solid var(--border); border-radius:6px; overflow:hidden; }
  .target-result-header { display:flex; align-items:center; justify-content:space-between; padding:0.8rem 1.1rem; background:var(--surface2); border-bottom:1px solid var(--border); }
  .target-result-title { font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:2px; color:white; }
  .target-result-sub { font-size:0.72rem; color:var(--muted); }
  .target-players-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
  .target-player-card { padding:0.85rem 1rem; border-right:1px solid var(--border); border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; position:relative; }
  .target-player-card:hover { background:rgba(215,25,32,0.07); }
  .target-rank-badge { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; color:var(--red); float:right; line-height:1; margin-left:0.4rem; }
  .target-player-name { font-weight:600; font-size:0.86rem; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .target-player-meta { font-size:0.7rem; color:var(--muted); margin:0.15rem 0 0.5rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .target-score-bar { height:4px; background:var(--border); border-radius:2px; }
  .target-score-fill { height:4px; border-radius:2px; }
  .target-already-tracked { position:absolute; top:0.5rem; right:0.5rem; font-size:0.6rem; background:rgba(232,160,32,0.15); color:var(--amber); border:1px solid rgba(232,160,32,0.3); border-radius:10px; padding:0.1rem 0.4rem; }
  .target-no-data { padding:3rem; text-align:center; color:var(--muted); font-size:0.85rem; }
  .target-empty-results { padding:2rem; text-align:center; color:var(--muted); font-size:0.82rem; }


</style>
</head>
<body>



<header>
  <div class="header-inner">
    <div class="brand">
      <div class="brand-icon">‚öΩ</div>
      <div class="brand-text">
        <div class="brand-name">Saints Scout</div>
        <div class="brand-sub">Southampton FC ¬∑ Player Intelligence ¬∑ Powered by Statsbomb</div>
      </div>
    </div>
    <div class="header-status"><div id="status-text">No data loaded</div><div>Upload CSV to begin</div></div>
  </div>
</header>

<nav>
  <div class="nav-inner">
    <button class="nav-btn active" onclick="showPage('home')">üè† Home</button>
    <button class="nav-btn" onclick="showPage('scout')">üîç Player Scout</button>
    <button class="nav-btn" onclick="showPage('obv')">üìä Touch &amp; OBV</button>
    <button class="nav-btn" onclick="showPage('scatter')">üìà Scatter Chart</button>
    <button class="nav-btn" onclick="showPage('reports')">üìã Reports<span class="nav-badge" id="reports-badge">0</span></button>
    <button class="nav-btn" onclick="showPage('pipeline')">üóÇ Pipeline<span class="nav-badge" id="pipeline-badge">0</span></button>
    <button class="nav-btn" onclick="showPage('targets')">üéØ Targets<span class="nav-badge" id="targets-badge">0</span></button>
    <button class="nav-btn" onclick="showPage('shortlist')">‚≠ê Shortlist<span class="nav-badge" id="shortlist-badge">0</span></button>
    <span id="sync-status" style="margin-left:auto;align-self:center;font-size:0.72rem;padding-right:1rem;font-family:'DM Sans',sans-serif;transition:color 0.3s;color:transparent;"></span>
  </div>
</nav>

<main>

  <!-- HOME -->
  <div id="page-home" class="page active">
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div class="upload-icon">üìÇ</div>
      <div class="upload-title">Upload player-stats.csv</div>
      <div class="upload-sub">Click to browse or drag &amp; drop your Statsbomb CSV file here</div>
      <input type="file" id="file-input" accept=".csv">
    </div>
    <div id="home-stats" style="display:none">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="stat-records">‚Äî</div><div class="stat-label">Player Records</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-players">‚Äî</div><div class="stat-label">Unique Players</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-leagues">‚Äî</div><div class="stat-label">Leagues</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-models">‚Äî</div><div class="stat-label">Scout Archetypes</div></div>
      </div>
    </div>
    <div class="tools-grid">
      <div class="tool-card" onclick="showPage('scout')">
        <div class="tool-card-icon">üîç</div>
        <div class="tool-card-title">Player Scout</div>
        <div class="tool-card-desc">Search and filter players by position, league, age and usage. Rank candidates against 25 bespoke scouting models ‚Äî from Dominant Defender to Advanced Striker ‚Äî benchmarked within competition and position.</div>
      </div>
      <div class="tool-card" onclick="showPage('obv')">
        <div class="tool-card-icon">üìä</div>
        <div class="tool-card-title">Touch &amp; OBV Analysis</div>
        <div class="tool-card-desc">Analyse players through the lens of on-ball volume and value. Explore Touches per 90, OBV, Pass OBV, Dribble &amp; Carry OBV and Shot OBV ‚Äî all benchmarked against peers in the same competition and position group.</div>
      </div>
    </div>
  </div>

  <!-- PLAYER SCOUT -->
  <div id="page-scout" class="page">
    <div class="section-header">PLAYER SCOUT</div>
    <div id="scout-no-data" class="empty-state">
      <div class="empty-svg-wrap">
        <svg width="120" height="100" viewBox="0 0 120 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="10" y="20" width="100" height="65" rx="4" stroke="#D71920" stroke-width="1.5" stroke-dasharray="4 3"/>
          <rect x="20" y="32" width="38" height="6" rx="2" fill="#2E2E2E"/>
          <rect x="20" y="44" width="55" height="6" rx="2" fill="#2E2E2E"/>
          <rect x="20" y="56" width="44" height="6" rx="2" fill="#2E2E2E"/>
          <rect x="20" y="68" width="60" height="6" rx="2" fill="#2E2E2E"/>
          <circle cx="92" cy="28" r="14" stroke="#D71920" stroke-width="1.5"/>
          <line x1="102" y1="38" x2="112" y2="48" stroke="#D71920" stroke-width="2" stroke-linecap="round"/>
          <circle cx="92" cy="28" r="5" fill="#D71920" opacity="0.4"/>
        </svg>
      </div>
      <div class="empty-title">No Data Loaded</div>
      <p>Upload your CSV on the Home page to get started</p>
    </div>
    <div id="scout-content" style="display:none">
      <div class="filter-sticky-outer">
      <div class="filter-panel">
        <div class="filter-grid">
          <div class="filter-group">
            <label class="filter-label">Position</label>
            <select id="f-position"><option value="">All Positions</option></select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Leagues</label>
            <div class="league-dropdown">
              <div class="league-trigger" id="f-league-trigger" onclick="toggleLeague('f')">
                <span class="league-trigger-text" id="f-league-trigger-text">All Leagues</span>
                <span class="league-trigger-arrow">‚ñº</span>
              </div>
              <div class="league-panel" id="f-league-list"></div>
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Season</label>
            <select id="f-season"><option value="">All Seasons</option></select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Age (Min ‚Äì Max)</label>
            <div class="range-row">
              <input type="number" id="f-age-min" placeholder="Min">
              <input type="number" id="f-age-max" placeholder="Max">
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Min Usage %</label>
            <input type="number" id="f-usage" value="20" min="0" max="100">
          </div>
          <div class="filter-group">
            <label class="filter-label">Min 90s (for Bar Rankings)</label>
            <input type="number" id="f-min90s" value="5" min="1" max="38" style="width:100%;">
          </div>
          <div class="filter-group">
            <label class="filter-label">Rank by Archetype</label>
            <select id="f-archetype"></select>
          </div>
          <div class="filter-group">
            <label class="filter-label">&nbsp;</label>
            <div style="display:flex;gap:0.5rem;">
              <button class="btn btn-outline" onclick="clearScoutFilters()" style="flex:1;">‚úï Clear</button>
              <button class="btn" onclick="applyScoutFilters()" style="flex:2;">Apply</button>
            </div>
          </div>
        </div>
      </div>
      </div><!-- /filter-sticky-outer -->
      <div class="search-bar-wrap" style="display:flex;gap:0.75rem;">
        <div style="display:flex;align-items:center;flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0 0.75rem;">
          <span class="search-icon">üîç</span>
          <input type="text" id="f-name-search" placeholder="Search by player name..." oninput="applyScoutFilters()" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-size:0.88rem;padding:0.6rem 0.5rem;">
        </div>
        <div style="display:flex;align-items:center;flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0 0.75rem;">
          <span class="search-icon">üèü</span>
          <input type="text" id="f-team-search" placeholder="Search by team..." oninput="applyScoutFilters()" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-size:0.88rem;padding:0.6rem 0.5rem;">
        </div>
      </div>
      <div class="results-bar">
        <div class="results-count">Showing <strong id="scout-count">0</strong> players ¬∑ Ranked by <em id="scout-archetype-label">‚Äî</em></div>
        <button class="btn btn-outline" onclick="exportCSV('scout')">‚¨á Export CSV</button>
      </div>
      <div class="table-wrap"><table><thead id="scout-thead"></thead><tbody id="scout-tbody"></tbody></table></div>
      <div class="pagination" id="scout-pagination"></div>
    </div>
  </div>

  <!-- TOUCH & OBV -->
  <div id="page-obv" class="page">
    <div class="section-header">TOUCH &amp; OBV ANALYSIS</div>
    <div id="obv-no-data" class="empty-state">
      <div class="empty-svg-wrap">
        <svg width="120" height="100" viewBox="0 0 120 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <polyline points="10,80 30,55 50,65 70,35 90,45 110,20" stroke="#D71920" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="5 3"/>
          <circle cx="30" cy="55" r="4" fill="#D71920" opacity="0.5"/>
          <circle cx="70" cy="35" r="4" fill="#D71920" opacity="0.5"/>
          <circle cx="110" cy="20" r="4" fill="#D71920" opacity="0.8"/>
          <line x1="10" y1="85" x2="110" y2="85" stroke="#2E2E2E" stroke-width="1.5"/>
          <line x1="10" y1="85" x2="10" y2="15" stroke="#2E2E2E" stroke-width="1.5"/>
          <rect x="20" y="88" width="12" height="5" rx="1" fill="#2E2E2E"/>
          <rect x="48" y="88" width="12" height="5" rx="1" fill="#2E2E2E"/>
          <rect x="76" y="88" width="12" height="5" rx="1" fill="#2E2E2E"/>
        </svg>
      </div>
      <div class="empty-title">No Data Loaded</div>
      <p>Upload your CSV on the Home page to get started</p>
    </div>
    <div id="obv-content" style="display:none">
      <div class="filter-sticky-outer">
      <div class="filter-panel">
        <div class="filter-grid">
          <div class="filter-group">
            <label class="filter-label">Position</label>
            <select id="o-position"><option value="">All Positions</option></select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Leagues</label>
            <div class="league-dropdown">
              <div class="league-trigger" id="o-league-trigger" onclick="toggleLeague('o')">
                <span class="league-trigger-text" id="o-league-trigger-text">All Leagues</span>
                <span class="league-trigger-arrow">‚ñº</span>
              </div>
              <div class="league-panel" id="o-league-list"></div>
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Age (Min ‚Äì Max)</label>
            <div class="range-row">
              <input type="number" id="o-age-min" placeholder="Min">
              <input type="number" id="o-age-max" placeholder="Max">
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Min Usage %</label>
            <input type="number" id="o-usage" value="20" min="0" max="100">
          </div>
          <div class="filter-group">
            <label class="filter-label">Sort by</label>
            <select id="o-sort">
              <option value="OBV Rank">OBV Rank</option>
              <option value="Pass OBV Rank">Pass OBV Rank</option>
              <option value="Dribble & Carry OBV Rank">Dribble &amp; Carry OBV Rank</option>
              <option value="Shot OBV Rank">Shot OBV Rank</option>
              <option value="Touches per 90">Touches per 90</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">&nbsp;</label>
            <div style="display:flex;gap:0.5rem;">
              <button class="btn btn-outline" onclick="clearOBVFilters()" style="flex:1;">‚úï Clear</button>
              <button class="btn" onclick="applyOBVFilters()" style="flex:2;">Apply</button>
            </div>
          </div>
        </div>
      </div>
      </div><!-- /filter-sticky-outer -->
      <div class="search-bar-wrap" style="display:flex;gap:0.75rem;">
        <div style="display:flex;align-items:center;flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0 0.75rem;">
          <span class="search-icon">üîç</span>
          <input type="text" id="o-name-search" placeholder="Search by player name..." oninput="applyOBVFilters()" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-size:0.88rem;padding:0.6rem 0.5rem;">
        </div>
        <div style="display:flex;align-items:center;flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0 0.75rem;">
          <span class="search-icon">üèü</span>
          <input type="text" id="o-team-search" placeholder="Search by team..." oninput="applyOBVFilters()" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-size:0.88rem;padding:0.6rem 0.5rem;">
        </div>
      </div>
      <div class="results-bar">
        <div class="results-count">Showing <strong id="obv-count">0</strong> players ¬∑ Sorted by <em id="obv-sort-label">OBV Rank</em></div>
        <button class="btn btn-outline" onclick="exportCSV('obv')">‚¨á Export CSV</button>
      </div>
      <div class="table-wrap"><table><thead id="obv-thead"></thead><tbody id="obv-tbody"></tbody></table></div>
      <div class="pagination" id="obv-pagination"></div>
      <hr class="divider">
      <div class="section-header" style="font-size:1.2rem;">FILTERED SUMMARY</div>
      <div class="summary-grid">
        <div class="stat-card"><div class="stat-value" id="sum-touches">‚Äî</div><div class="stat-label">Avg Touches p90</div></div>
        <div class="stat-card"><div class="stat-value" id="sum-obv">‚Äî</div><div class="stat-label">Avg OBV Rank</div></div>
        <div class="stat-card"><div class="stat-value" id="sum-pass">‚Äî</div><div class="stat-label">Avg Pass OBV Rank</div></div>
        <div class="stat-card"><div class="stat-value" id="sum-shot">‚Äî</div><div class="stat-label">Avg Shot OBV Rank</div></div>
      </div>
    </div>
  </div>

  <!-- SCATTER CHART -->
  <div id="page-scatter" class="page">
    <div class="section-header">SCATTER CHART</div>
    <div id="scatter-no-data" class="empty-state">
      <div class="empty-svg-wrap">
        <svg width="120" height="100" viewBox="0 0 120 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <line x1="12" y1="88" x2="112" y2="88" stroke="#2E2E2E" stroke-width="1.5"/>
          <line x1="12" y1="88" x2="12" y2="12" stroke="#2E2E2E" stroke-width="1.5"/>
          <circle cx="35" cy="70" r="5" fill="#D71920" opacity="0.25"/>
          <circle cx="52" cy="58" r="5" fill="#D71920" opacity="0.25"/>
          <circle cx="48" cy="75" r="5" fill="#D71920" opacity="0.25"/>
          <circle cx="70" cy="42" r="5" fill="#D71920" opacity="0.25"/>
          <circle cx="65" cy="60" r="5" fill="#D71920" opacity="0.25"/>
          <circle cx="85" cy="30" r="5" fill="#D71920" opacity="0.25"/>
          <circle cx="92" cy="50" r="5" fill="#D71920" opacity="0.25"/>
          <circle cx="78" cy="55" r="7" fill="white" stroke="#D71920" stroke-width="1.5" opacity="0.8"/>
          <circle cx="55" cy="38" r="7" fill="white" stroke="#D71920" stroke-width="1.5" opacity="0.8"/>
          <line x1="65" y1="88" x2="65" y2="12" stroke="#D71920" stroke-width="1" stroke-dasharray="4 3" opacity="0.4"/>
          <line x1="12" y1="55" x2="112" y2="55" stroke="#D71920" stroke-width="1" stroke-dasharray="4 3" opacity="0.4"/>
        </svg>
      </div>
      <div class="empty-title">No Data Loaded</div>
      <p>Upload your CSV on the Home page to get started</p>
    </div>
    <div id="scatter-content" style="display:none">
      <div class="scatter-layout">

        <!-- Controls -->
        <div class="scatter-controls">

          <!-- Presets -->
          <div class="scatter-control-card">
            <div class="scatter-control-title">CHART PRESETS</div>
            <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
              <select id="sc-preset-select" style="flex:1;"><option value="">‚Äî Load a preset ‚Äî</option></select>
              <button class="btn btn-sm" onclick="loadPreset()">Load</button>
            </div>
            <div style="display:flex;gap:0.5rem;">
              <input type="text" id="sc-preset-name" placeholder="Preset name..." style="flex:1;">
              <button class="btn btn-sm" onclick="savePreset()">Save</button>
              <button class="btn btn-sm btn-outline" onclick="deletePreset()" title="Delete selected preset">‚úï</button>
            </div>
          </div>

          <!-- Axes + Size -->
          <div class="scatter-control-card">
            <div class="scatter-control-title">AXES</div>
            <div class="filter-group" style="margin-bottom:0.75rem;">
              <label class="filter-label">X Axis</label>
              <select id="sc-x"></select>
            </div>
            <div class="filter-group" style="margin-bottom:0.75rem;">
              <label class="filter-label">Y Axis</label>
              <select id="sc-y"></select>
            </div>
            <div class="filter-group" style="margin-bottom:0.75rem;">
              <label class="filter-label">Dot Size (optional 3rd variable)</label>
              <select id="sc-size"><option value="">Fixed size</option></select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Chart Title</label>
              <input type="text" id="sc-title" placeholder="e.g. U21 Midfielders: Styles">
            </div>
          </div>

          <!-- Quadrant labels -->
          <div class="scatter-control-card">
            <div class="scatter-control-title">QUADRANT LABELS</div>
            <div class="filter-group" style="margin-bottom:0.5rem;">
              <label class="filter-label">Top Left</label>
              <input type="text" id="sc-q-tl" placeholder="e.g. pass first, prefer to duel">
            </div>
            <div class="filter-group" style="margin-bottom:0.5rem;">
              <label class="filter-label">Top Right</label>
              <input type="text" id="sc-q-tr" placeholder="e.g. carry first, prefer to duel">
            </div>
            <div class="filter-group" style="margin-bottom:0.5rem;">
              <label class="filter-label">Bottom Left</label>
              <input type="text" id="sc-q-bl" placeholder="e.g. pass first, defend better">
            </div>
            <div class="filter-group">
              <label class="filter-label">Bottom Right</label>
              <input type="text" id="sc-q-br" placeholder="e.g. carry first, defend better">
            </div>
          </div>

          <!-- Population filters -->
          <div class="scatter-control-card">
            <div class="scatter-control-title">POPULATION FILTERS</div>
            <div class="filter-group" style="margin-bottom:0.75rem;">
              <label class="filter-label">Position</label>
              <select id="sc-position"><option value="">All Positions</option></select>
            </div>
            <div class="filter-group" style="margin-bottom:0.75rem;">
              <label class="filter-label">Age (Min ‚Äì Max)</label>
              <div class="range-row">
                <input type="number" id="sc-age-min" placeholder="Min">
                <input type="number" id="sc-age-max" placeholder="Max">
              </div>
            </div>
            <div class="filter-group" style="margin-bottom:0.75rem;">
              <label class="filter-label">Min Usage %</label>
              <input type="number" id="sc-usage" value="20" min="0" max="100">
            </div>
            <div class="filter-group">
              <label class="filter-label">Leagues</label>
              <div class="league-dropdown">
                <div class="league-trigger" id="sc-league-trigger" onclick="toggleLeague('sc')">
                  <span class="league-trigger-text" id="sc-league-trigger-text">All Leagues</span>
                  <span class="league-trigger-arrow">‚ñº</span>
                </div>
                <div class="league-panel" id="sc-league-list"></div>
              </div>
            </div>
          </div>

          <!-- Highlight players -->
          <div class="scatter-control-card">
            <div class="scatter-control-title">HIGHLIGHT PLAYERS</div>
            <label style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;cursor:pointer;font-size:0.84rem;color:var(--text);">
              <input type="checkbox" id="sc-u23-toggle" style="width:14px;height:14px;accent-color:var(--red);appearance:auto;flex-shrink:0;">
              Auto-highlight U23 players (age ‚â§ 23)
            </label>
            <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
              <input type="text" id="sc-highlight-input" placeholder="Search player name..." style="flex:1;" oninput="scHighlightSearch()">
            </div>
            <div id="sc-highlight-suggestions" style="display:none;background:var(--surface2);border:1px solid var(--red);border-radius:3px;max-height:140px;overflow-y:auto;margin-bottom:0.5rem;"></div>
            <div class="highlight-tags-wrap" id="sc-highlight-tags"></div>
          </div>

          <button class="btn" onclick="scatterView==='table'?drawRankTable():drawScatter()" style="width:100%;">Draw Chart</button>
        </div>

        <!-- Chart / Table -->
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;">
            <div class="report-view-toggle">
              <button class="report-view-btn active" id="sc-view-scatter" onclick="setScatterView('scatter')" title="Scatter chart">‚äπ Scatter</button>
              <button class="report-view-btn" id="sc-view-table" onclick="setScatterView('table')" title="Rank table">‚ò∞ Table</button>
            </div>
            <div style="display:flex;gap:0.5rem;align-items:center;">
              <button class="btn btn-outline btn-sm" id="sc-table-png-btn" onclick="exportRankTablePNG()" style="display:none;">‚¨á Save PNG</button>
              <button class="btn btn-outline btn-sm" id="sc-export-btn" onclick="exportScatterPNG()">‚¨á Export PNG</button>
            </div>
          </div>
          <div id="scatter-chart-panel">
            <div class="scatter-info-panel" id="scatter-info-panel">
              <div class="scatter-info-empty">Hover over a dot to see player details</div>
            </div>
            <div class="scatter-chart-wrap">
              <div class="scatter-tooltip" id="scatter-tooltip" style="display:none"></div>
              <svg id="scatter-svg"></svg>
            </div>
          </div>
          <div id="scatter-table-panel" style="display:none;"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- REPORTS -->
  <div id="page-reports" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
      <div class="section-header" style="margin-bottom:0;">SCOUT REPORTS</div>
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <div class="report-view-toggle">
          <button class="report-view-btn active" id="view-btn-cards" onclick="setReportView('cards')" title="Card view">‚äû</button>
          <button class="report-view-btn" id="view-btn-list" onclick="setReportView('list')" title="List view">‚ò∞</button>
        </div>
        <button class="btn" onclick="showNewReportPanel()">+ New Report</button>
      </div>
    </div>

    <!-- Stage filter tabs -->
    <div class="stage-filter-wrap" id="stage-filter-wrap">
      <span style="font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-right:0.25rem;">Stage:</span>
      <button class="stage-filter-btn active" onclick="setStageFilter('')">All</button>
      <button class="stage-filter-btn" onclick="setStageFilter('Track')">Track</button>
      <button class="stage-filter-btn" onclick="setStageFilter('Video Scout')">Video Scout</button>
      <button class="stage-filter-btn" onclick="setStageFilter('Senior Viewing')">Senior Viewing</button>
      <button class="stage-filter-btn" onclick="setStageFilter('Shortlist')">Shortlist</button>
      <button class="stage-filter-btn" onclick="setStageFilter('Push')">Push</button>
    </div>

    <!-- Recommendation filter tabs -->
    <div class="stage-filter-wrap" id="rec-filter-wrap" style="margin-top:0.5rem;">
      <span style="font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-right:0.25rem;">Verdict:</span>
      <button class="stage-filter-btn active" onclick="setRecFilter('')">All</button>
      <button class="stage-filter-btn" onclick="setRecFilter('Recommended')" style="--rec-col:var(--green)">‚úì Recommended</button>
      <button class="stage-filter-btn" onclick="setRecFilter('Monitor')" style="--rec-col:var(--amber)">~ Monitor</button>
      <button class="stage-filter-btn" onclick="setRecFilter('Not Recommended')" style="--rec-col:var(--crimson)">‚úó Not Recommended</button>
      <button class="stage-filter-btn" onclick="setRecFilter('__none__')" style="--rec-col:var(--muted)">No verdict</button>
    </div>

    <!-- Search + position filter row -->
    <div style="display:flex;gap:0.75rem;margin-bottom:1.25rem;flex-wrap:wrap;">
      <input type="text" id="report-list-filter" placeholder="Search player or team..." oninput="renderReportList()" style="flex:1;min-width:180px;">
      <select id="report-pos-filter" onchange="renderReportList()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:3px;padding:0.5rem 0.75rem;font-family:'DM Sans',sans-serif;font-size:0.85rem;min-width:140px;">
        <option value="">All Positions</option>
        <option>1</option><option>2a</option><option>2b</option><option>3</option>
        <option>4</option><option>5a</option><option>5b</option><option>6</option>
        <option>8a</option><option>8b</option><option>7a</option><option>7b</option>
        <option>11a</option><option>11b</option><option>10</option><option>9a</option><option>9b</option>
      </select>
      <div style="font-size:0.78rem;color:var(--muted);align-self:center;white-space:nowrap;">
        <span id="report-count-label">0 reports</span>
      </div>
    </div>

    <!-- Card / list output -->
    <div id="report-main-view"></div>

    <!-- New report panel -->
    <div id="new-report-panel" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1.25rem;margin-bottom:1.5rem;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:0.95rem;letter-spacing:2px;color:var(--red);margin-bottom:0.75rem;">NEW REPORT</div>
      <div class="report-new-search-wrap">
        <input type="text" id="new-report-search" placeholder="Search player from loaded CSV..." oninput="newReportSearch()" style="width:100%;">
        <div class="report-new-suggestions" id="new-report-suggestions"></div>
      </div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.5rem;">Or enter a name and create manually.</div>
      <div style="display:flex;gap:0.5rem;margin-top:0.75rem;">
        <button class="btn btn-sm" onclick="createManualReport()">Create manually</button>
        <button class="btn btn-sm btn-outline" onclick="document.getElementById('new-report-panel').style.display='none'">Cancel</button>
      </div>
    </div>

    <!-- Report editor (shown below grid when a card is clicked) -->
    <div id="report-editor-wrap"></div>
  </div>

  <!-- TARGET POSITIONS -->
  <div id="page-targets" class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
      <div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:3px;color:white;">üéØ Target Positions</div>
        <div style="font-size:0.78rem;color:var(--muted);margin-top:0.2rem;">Define recruitment needs and surface the best candidates automatically</div>
      </div>
    </div>
    <div id="targets-no-data" class="target-no-data" style="display:none;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;margin-bottom:0.5rem;">NO DATA LOADED</div>
      <div>Upload your CSV on the Home page to use Target Positions</div>
    </div>
    <div id="targets-content" style="display:none;">
      <div class="targets-layout">
        <!-- Sidebar: need builder -->
        <div class="targets-sidebar">
          <div class="targets-sidebar-title">ADD A NEED</div>
          <div class="target-need-form">
            <div>
              <label class="filter-label">Position</label>
              <select id="t-position" onchange="updateTargetArchetypes()">
                <option value="">Select position...</option>
                <option>Defender</option>
                <option>Fullback</option>
                <option>Midfielder</option>
                <option>Winger</option>
                <option>Striker</option>
              </select>
            </div>
            <div>
              <label class="filter-label">Archetype</label>
              <select id="t-archetype">
                <option value="">Select position first...</option>
              </select>
            </div>
            <div>
              <label class="filter-label">League (optional)</label>
              <select id="t-league">
                <option value="">Any League</option>
              </select>
            </div>
            <div class="target-form-row">
              <div>
                <label class="filter-label">Min Age</label>
                <input type="number" id="t-age-min" placeholder="e.g. 18" min="15" max="40">
              </div>
              <div>
                <label class="filter-label">Max Age</label>
                <input type="number" id="t-age-max" placeholder="e.g. 26" min="15" max="40">
              </div>
            </div>
            <div>
              <label class="filter-label">Min 90s Played</label>
              <input type="number" id="t-min90s" placeholder="e.g. 5" min="1" value="5">
            </div>
            <button class="btn" onclick="addTargetNeed()" style="margin-top:0.25rem;">+ Add Need</button>
          </div>

          <div style="border-top:1px solid var(--border);margin-top:1.25rem;padding-top:1rem;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:1.5px;color:var(--muted);margin-bottom:0.6rem;">CURRENT NEEDS</div>
            <div class="targets-needs-list" id="targets-needs-list">
              <div class="targets-needs-empty">No needs defined yet</div>
            </div>
            <button class="btn btn-outline" onclick="clearTargetNeeds()" style="width:100%;margin-top:0.75rem;font-size:0.78rem;">‚úï Clear All</button>
          </div>
        </div>

        <!-- Results panel -->
        <div class="targets-results" id="targets-results">
          <div class="target-empty-results" style="padding:4rem;color:var(--muted);">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;margin-bottom:0.5rem;">NO NEEDS DEFINED</div>
            <div style="font-size:0.82rem;">Use the panel on the left to define a recruitment need. The top candidates will appear here automatically.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PIPELINE BOARD -->
  <div id="page-pipeline" class="page">
    <div class="pipeline-header">
      <div>
        <div class="pipeline-title">üóÇ Recruitment Pipeline</div>
        <div class="pipeline-meta" id="pipeline-meta">Drag cards between columns to update a player's stage</div>
      </div>
    </div>
    <!-- Filter / sort bar -->
    <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;">
      <span style="font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Verdict:</span>
      <button class="stage-filter-btn active" id="pipe-rec-all"    onclick="setPipelineRec('')">All</button>
      <button class="stage-filter-btn" id="pipe-rec-yes"           onclick="setPipelineRec('Recommended')">‚úì Recommended</button>
      <button class="stage-filter-btn" id="pipe-rec-mon"           onclick="setPipelineRec('Monitor')">~ Monitor</button>
      <button class="stage-filter-btn" id="pipe-rec-no"            onclick="setPipelineRec('Not Recommended')">‚úó Not Recommended</button>
      <button class="stage-filter-btn" id="pipe-rec-none"          onclick="setPipelineRec('__none__')">No verdict</button>
      <div style="flex:1"></div>
      <span style="font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Sort:</span>
      <select id="pipe-sort-select" onchange="setPipelineSort(this.value)"
        style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:3px;padding:0.28rem 0.6rem;font-size:0.78rem;font-family:'DM Sans',sans-serif;cursor:pointer;">
        <option value="updated">Recently Updated</option>
        <option value="days_asc">Longest in Stage</option>
        <option value="days_desc">Newest in Stage</option>
        <option value="name">Name A‚ÄìZ</option>
      </select>
    </div>
    <div class="pipeline-summary" id="pipeline-summary"></div>
    <div class="pipeline-board" id="pipeline-board"></div>
  </div>

  <!-- SHORTLIST -->
  <div id="page-shortlist" class="page">
    <div class="section-header">MY SHORTLIST</div>
    <div id="shortlist-no-data" class="empty-state">
      <div class="empty-svg-wrap">
        <svg width="120" height="100" viewBox="0 0 120 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <polygon points="60,18 67,40 92,40 72,54 79,76 60,62 41,76 48,54 28,40 53,40" stroke="#D71920" stroke-width="1.5" stroke-linejoin="round" fill="none" stroke-dasharray="5 3"/>
          <polygon points="60,28 65,42 80,42 68,51 72,65 60,57 48,65 52,51 40,42 55,42" fill="#D71920" opacity="0.15"/>
        </svg>
      </div>
      <div class="empty-title">Shortlist Empty</div>
      <p>Open a player profile and tap <strong style="color:var(--text)">Add to Shortlist</strong> to begin</p>
    </div>
    <div id="shortlist-content" style="display:none">
      <div class="shortlist-actions">
        <button class="btn btn-outline" onclick="exportShortlist()">‚¨á Export Shortlist CSV</button>
        <button class="btn" onclick="printSquadReport()">üñ® Print Squad Report</button>
        <button class="btn btn-outline" onclick="exportNotesFile()" style="border-color:var(--muted);color:var(--muted);">üíæ Save Notes File</button>
        <label class="btn btn-outline" style="border-color:var(--muted);color:var(--muted);cursor:pointer;">
          üìÇ Load Notes File<input type="file" id="notes-file-input" accept=".json" style="display:none" onchange="loadNotesFile(event)">
        </label>
      </div>
      <!-- View tabs: Shortlist / Watchlist -->
      <div class="sl-view-tabs">
        <button class="sl-view-tab active" id="slvtab-shortlist" onclick="setSlViewTab('shortlist')">‚≠ê Shortlist <span id="slvtab-sl-count" style="font-size:0.7rem;opacity:0.7"></span></button>
        <button class="sl-view-tab" id="slvtab-watchlist" onclick="setSlViewTab('watchlist')">üëÅ Watchlist <span id="slvtab-wl-count" style="font-size:0.7rem;opacity:0.7"></span></button>
      </div>
      <!-- Shortlist panel -->
      <div id="sl-panel-shortlist">
        <div class="sl-pos-tabs" id="sl-pos-tabs"></div>
        <div class="shortlist-list" id="shortlist-list"></div>
      </div>
      <!-- Watchlist panel -->
      <div id="sl-panel-watchlist" style="display:none;">
        <div class="shortlist-list" id="watchlist-list"></div>
      </div>
    </div>
  </div>

</main>

<!-- PLAYER PROFILE MODAL -->
<div class="modal-overlay" id="profile-modal" onclick="handleModalClick(event)">
  <div class="modal" id="profile-modal-inner">
    <div class="modal-header">
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <button class="modal-nav-btn" id="modal-prev-btn" onclick="navigateProfile(-1)" title="Previous player (‚Üê)">&#8592;</button>
        <button class="modal-nav-btn" id="modal-next-btn" onclick="navigateProfile(1)"  title="Next player (‚Üí)">&#8594;</button>
        <span id="modal-nav-pos" style="font-size:0.7rem;color:rgba(255,255,255,0.35);font-family:'DM Sans',sans-serif;letter-spacing:0.5px;min-width:40px;"></span>
      </div>
      <div style="flex:1;min-width:0;padding:0 0.75rem;">
        <div class="modal-player-name" id="modal-name">‚Äî</div>
        <div class="modal-player-meta" id="modal-meta">‚Äî</div>
        <div id="modal-archetype-badge-wrap" style="margin-top:0.5rem;"></div>
      </div>
      <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Tab nav -->
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="showModalTab('stats')" id="mtab-stats">üìä Stats</button>
        <button class="modal-tab" onclick="showModalTab('profile')" id="mtab-profile">üìà Profile</button>
        <button class="modal-tab" onclick="showModalTab('curve')" id="mtab-curve">üìâ Age Curve</button>
        <button class="modal-tab" onclick="showModalTab('similar')" id="mtab-similar">üîç Similar</button>
        <button class="modal-tab" onclick="showModalTab('notes')" id="mtab-notes">üìù Notes</button>
      </div>

      <!-- Tab: Stats -->
      <div class="modal-tab-panel active" id="mtabp-stats">
        <div class="modal-section-title" id="modal-stats-section-title">KEY STATS</div>
        <div class="profile-grid" id="modal-stats"></div>
        <div id="modal-conclusion-wrap" style="display:none;margin-top:1.25rem;">
          <div class="modal-section-title">SCOUT CONCLUSION</div>
          <div id="modal-conclusion" style="background:rgba(232,160,32,0.08);border:1px solid rgba(232,160,32,0.3);border-radius:4px;padding:0.75rem 1rem;font-size:0.88rem;color:var(--amber);font-style:italic;line-height:1.55;"></div>
        </div>
      </div>

      <!-- Tab: Profile -->
      <div class="modal-tab-panel" id="mtabp-profile">
        <div class="modal-section-title">PLAYER PROFILE</div>
        <div id="modal-position-bars"></div>
        <div class="modal-section-title" style="margin-top:1.5rem;">ARCHETYPE RANKS</div>
        <div class="model-ranks-grid" id="modal-model-ranks"></div>
      </div>

      <!-- Tab: Age Curve -->
      <div class="modal-tab-panel" id="mtabp-curve">
        <div class="modal-section-title">AGE CURVE</div>
        <div id="age-curve-metric-list" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.75rem;"></div>
        <div id="modal-age-curve"></div>
      </div>

      <!-- Tab: Similar -->
      <div class="modal-tab-panel" id="mtabp-similar">
        <div class="modal-section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;">
          <span>SIMILAR PLAYERS</span>
          <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.72rem;color:var(--muted);font-family:'DM Sans',sans-serif;font-weight:400;letter-spacing:0;cursor:pointer;">
            <input type="checkbox" id="similar-u23-toggle" onchange="refreshSimilarPlayers()" style="width:12px;height:12px;accent-color:var(--red);appearance:auto;">
            U23 only
          </label>
        </div>
        <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.5rem;">Same position ¬∑ position-relevant models ¬∑ min ${minNineties} 90s</div>
        <div class="similar-list" id="modal-similar"></div>
      </div>

      <!-- Tab: Notes -->
      <div class="modal-tab-panel" id="mtabp-notes">
        <div class="modal-section-title">SCOUT NOTES</div>
        <textarea class="notes-area" id="modal-notes" placeholder="Add your scouting notes here..." style="min-height:180px;"></textarea>
      </div>
    </div>

    <!-- Sticky action footer -->
    <div class="modal-sticky-footer">
      <button class="btn btn-sm" onclick="saveNote()">Save Note</button>
      <button class="btn btn-sm btn-shortlist" id="modal-shortlist-btn" onclick="toggleShortlist()">‚≠ê Add to Shortlist</button>
      <button class="btn btn-sm btn-outline btn-watchlist" id="modal-watchlist-btn" onclick="toggleWatchlist()">üëÅ Watchlist</button>
      <button class="btn btn-sm btn-outline" onclick="openCompare()">‚öñ Compare</button>
      <button class="btn btn-sm btn-outline" id="modal-report-btn" onclick="openReportFromModal()">üìã Report</button>
      <button class="btn btn-sm btn-outline" onclick="printProfile()">üñ® Print</button>
      <button class="btn btn-sm btn-outline" onclick="exportProfilePNG()" title="Save profile as PNG">‚¨á PNG</button>
      <span class="notes-saved" id="notes-saved-msg">‚úì Saved</span>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rawData = [], scoutFiltered = [], obvFiltered = [];
let scoutPage = 1, obvPage = 1;
const PAGE_SIZE = 50;
let scoutSort = { col: null, dir: 'desc' };
let obvSort   = { col: null, dir: 'desc' };
let notes     = JSON.parse(localStorage.getItem('saints_scout_notes') || '{}');
let shortlist = JSON.parse(localStorage.getItem('saints_scout_shortlist') || '[]');
let watchlist = JSON.parse(localStorage.getItem('saints_scout_watchlist') || '[]');
let reports   = JSON.parse(localStorage.getItem('saints_scout_reports') || '{}');

// ‚îÄ‚îÄ SUPABASE SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL = 'https://kddkmupckjglnhmouzph.supabase.co';
const SUPABASE_KEY = 'sb_publishable_BoJ05QkKxyte5nHPfVOevA_M_Og6Uw9';
const STORE_ID     = 'saints_scout_v1'; // single row that holds all app data
let   sbClient     = null;
let   syncTimer    = null;
let   syncStatus   = 'idle'; // idle | saving | saved | error | offline

function initSupabase() {
  try {
    sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    loadFromSupabase();
  } catch(e) {
    console.warn('Supabase init failed, running offline:', e);
    setSyncStatus('offline');
  }
}

function setSyncStatus(status, msg) {
  syncStatus = status;
  const el = document.getElementById('sync-status');
  if (!el) return;
  const icons = { idle:'', saving:'‚è≥', saved:'‚úì Synced', error:'‚ö† Sync failed', offline:'üì¥ Offline', loading:'‚è≥ Loading‚Ä¶' };
  const cols  = { saving:'var(--muted)', saved:'var(--green)', error:'var(--crimson)', offline:'var(--amber)', loading:'var(--muted)' };
  el.textContent = icons[status] || '';
  el.style.color = cols[status] || 'transparent';
}

async function loadFromSupabase() {
  if (!sbClient) return;
  setSyncStatus('loading');
  try {
    const { data, error } = await sbClient
      .from('scout_data')
      .select('payload')
      .eq('store_id', STORE_ID)
      .single();

    if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows, first run

    if (data?.payload) {
      const p = data.payload;
      if (p.notes)     { notes     = p.notes;     localStorage.setItem('saints_scout_notes',     JSON.stringify(notes)); }
      if (p.shortlist) { shortlist = p.shortlist; localStorage.setItem('saints_scout_shortlist', JSON.stringify(shortlist)); }
      if (p.watchlist) { watchlist = p.watchlist; localStorage.setItem('saints_scout_watchlist', JSON.stringify(watchlist)); }
      if (p.reports)   { reports   = p.reports;   localStorage.setItem('saints_scout_reports',   JSON.stringify(reports)); }
      // Refresh any live UI that's already rendered
      updateShortlistBadge();
      updateReportsBadge();
      if (document.getElementById('page-shortlist').classList.contains('active')) renderShortlist();
      if (document.getElementById('page-reports').classList.contains('active'))   renderReportList();
      if (document.getElementById('page-pipeline').classList.contains('active'))  renderPipeline();
    }
    setSyncStatus('saved');
  } catch(e) {
    console.warn('Supabase load failed:', e);
    setSyncStatus('offline');
  }
}

async function saveToSupabase() {
  if (!sbClient) return;
  setSyncStatus('saving');
  try {
    const payload = { notes, shortlist, watchlist, reports };
    const { error } = await sbClient
      .from('scout_data')
      .upsert({ store_id: STORE_ID, payload, updated_at: new Date().toISOString() }, { onConflict: 'store_id' });
    if (error) throw error;
    // Also keep localStorage as offline cache
    localStorage.setItem('saints_scout_notes',     JSON.stringify(notes));
    localStorage.setItem('saints_scout_shortlist', JSON.stringify(shortlist));
    localStorage.setItem('saints_scout_watchlist', JSON.stringify(watchlist));
    localStorage.setItem('saints_scout_reports',   JSON.stringify(reports));
    setSyncStatus('saved');
    setTimeout(() => setSyncStatus('idle'), 3000);
  } catch(e) {
    console.warn('Supabase save failed:', e);
    setSyncStatus('error');
    // Still save to localStorage as fallback
    localStorage.setItem('saints_scout_notes',     JSON.stringify(notes));
    localStorage.setItem('saints_scout_shortlist', JSON.stringify(shortlist));
    localStorage.setItem('saints_scout_watchlist', JSON.stringify(watchlist));
    localStorage.setItem('saints_scout_reports',   JSON.stringify(reports));
  }
}

// Debounced save ‚Äî batches rapid changes into one network call
function scheduleSave() {
  clearTimeout(syncTimer);
  syncTimer = setTimeout(saveToSupabase, 1200);
}

function persistNotes()     { localStorage.setItem('saints_scout_notes',     JSON.stringify(notes));     scheduleSave(); }
function persistShortlist() { localStorage.setItem('saints_scout_shortlist', JSON.stringify(shortlist)); scheduleSave(); }
function persistWatchlist() { localStorage.setItem('saints_scout_watchlist', JSON.stringify(watchlist)); scheduleSave(); }
function persistReports()   { localStorage.setItem('saints_scout_reports',   JSON.stringify(reports));   updateReportsBadge(); updatePipelineBadge(); scheduleSave(); }

let currentProfileKey = null;
let currentProfileList = []; // the filtered list active when profile was opened ‚Äî for prev/next nav
let minNineties = 5;

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentModalTab = 'stats';
function showModalTab(tab) {
  currentModalTab = tab;
  document.querySelectorAll('.modal-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.modal-tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('mtab-' + tab).classList.add('active');
  document.getElementById('mtabp-' + tab).classList.add('active');
  // Draw age curve lazily when tab is first opened
  if (tab === 'curve') drawAgeCurve();
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const navIdx = {home:0,scout:1,obv:2,scatter:3,reports:4,pipeline:5,targets:6,shortlist:7}[name];
  document.querySelectorAll('.nav-btn')[navIdx].classList.add('active');
  if (name === 'shortlist') renderShortlist();
  if (name === 'scatter' && rawData.length) drawScatter();
  if (name === 'reports') renderReportList();
  if (name === 'pipeline') renderPipeline();
  if (name === 'targets') showTargetsPage();
}

// ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('file-input').addEventListener('change', e => loadFile(e.target.files[0]));
const uploadZone = document.getElementById('upload-zone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('drag-over'); if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]); });

// Initialise Supabase sync on page load
initSupabase();

function loadFile(file) {
  if (!file) return;
  uploadZone.innerHTML = '<div class="upload-icon">‚è≥</div><div class="upload-title">Processing...</div><div class="upload-sub">Calculating archetypes and rankings ‚Äî this may take a moment</div>';
  setTimeout(() => {
    Papa.parse(file, { header: true, skipEmptyLines: true, dynamicTyping: true, complete: r => processData(r.data) });
  }, 50);
}

// ‚îÄ‚îÄ MAPPINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LEAGUE_MAP = {
  1002:"England 1",1003:"England 2",1004:"England 3",1005:"England 4",
  1006:"Netherlands 1",1007:"France 1",1008:"France 2",1009:"Germany 1",
  1010:"Germany 2",1011:"Spain 1",1012:"Italy 1",1013:"Portugal 1",
  1038:"Poland",1042:"Spain 2",1046:"Belgium 1",1047:"Austria",
  1051:"Scotland",1060:"Greece",1063:"Netherlands 2",1073:"Mexico",
  1074:"Colombia",1076:"Czechia",1077:"Denmark",1078:"Croatia",
  1079:"Serbia",1080:"Switzerland",1081:"Argentina",1084:"Italy 2",
  1085:"Turkey 1",1093:"Australia",1103:"Chile",1107:"Ireland",
  1108:"Japan",1109:"Korea",1111:"Uruguay",1124:"Slovakia",
  1129:"France 3",1132:"Ukraine",1179:"Germany 3",1194:"Saudi Arabia",
  1227:"Egypt",1349:"Romania",2035:"Belgium 2",2037:"Turkey 2",
  2408:"Spain 3",2522:"Hungary",2714:"Slovenia",1044:"MLS",
  1128:"Russia",1071:"Brazil",1075:"Sweden",1088:"Norway",
  2211:"Israel",2281:"Brazil 2",1177:"Switzerland 2",1357:"Portugal 2",2865:"Bulgaria 1"
};

const MODELS = {
  // ‚îÄ‚îÄ DEFENDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Dominant Defender: aerial dominance + defensive duels ‚Äî unchanged, well differentiated
  "Dominant Defender":    [["Defensive Action OBV",0.30],["Aerial Win%",0.15],["Aerial Wins",0.15],["Tack/Dribbled Past%",0.20],["PAdj Tackles & Interceptions",0.20]],

  // Ball Playing Defender: FIX overlap with DLP ‚Äî stronger defensive anchor, remove Deep Completions (midfielder metric)
  // Added Defensive Action OBV 20% to clearly separate from DLP; Pressured Pass% stays as BPD-specific signal
  "Ball Playing Defender":[["Pass OBV",0.30],["Pressured Pass%",0.20],["Defensive Action OBV",0.20],["Tack/Dribbled Past%",0.15],["xGBuildup",0.15]],

  // Wide Defender: FIX ‚Äî add Pass OBV to capture ball-playing wide CB; reduce Ball Recoveries
  "Wide Defender":        [["Defensive Action OBV",0.25],["Tack/Dribbled Past%",0.20],["Opp Half Recovery%",0.20],["Dribble & Carry OBV",0.15],["Pass OBV",0.10],["Ball Recoveries",0.10]],

  // ‚îÄ‚îÄ FULLBACKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  "Defensive Fullback":   [["Defensive Action OBV",0.30],["Tack/Dribbled Past%",0.20],["PAdj Tackles & Interceptions",0.25],["Pressure Regains",0.15],["Open Play xG Assisted",0.10]],

  // Attacking Fullback: FIX overlap with Crossing FB ‚Äî drop Deep Completions, add Dribble% for carry quality
  // Pure overlapping runner ‚Äî carries into space, combines, assists
  "Attacking Fullback":   [["Dribble & Carry OBV",0.35],["Open Play xG Assisted",0.25],["Pass OBV",0.20],["Dribble%",0.10],["Successful Dribbles",0.10]],

  // Crossing Fullback: FIX overlap ‚Äî exclusively about delivery, remove Pass OBV entirely
  "Crossing Fullback":    [["Successful Crosses",0.40],["Open Play xG Assisted",0.30],["Deep Completions",0.20],["Dribble & Carry OBV",0.10]],

  // ‚îÄ‚îÄ MIDFIELDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  "Holding Midfielder":   [["Defensive Action OBV",0.25],["Tack/Dribbled Past%",0.15],["PAdj Tackles & Interceptions",0.25],["Pressured Pass%",0.20],["Opp Half Recovery%",0.15]],

  // Ball Progressor: unchanged ‚Äî well differentiated with Dribble & Carry OBV included
  "Ball Progressor":      [["Pass OBV",0.25],["xGBuildup",0.20],["Deep Completions",0.20],["Dribble & Carry OBV",0.15],["Open Play xG Assisted",0.10],["Pass Forward%",0.10]],

  // Number 10: FIX overlap with Creative Striker ‚Äî defined by receiving in dangerous areas and key pass creation
  // Remove Pass OBV (shared with Creative Striker), add Shot OBV to reward goal threat
  "Number 10":            [["LBP Received F3",0.35],["Open Play Key Passes",0.30],["xGBuildup",0.20],["Shot OBV",0.15]],

  // Box Crasher: FIX overlap with Advanced Striker/Production ‚Äî volume over quality
  // Remove xG/Shot entirely (quality metric), emphasise shot volume and box arrivals
  "Box Crasher":          [["Shots",0.30],["xG",0.25],["Shot OBV",0.25],["Key Passes",0.20]],

  // Deep Lying Playmaker: FIX 100% overlap with Possession ‚Äî remove Pass Forward% and Open Play Passes
  // DLP is about quality and composure under pressure, not volume or direction
  "Deep Lying Playmaker": [["Pass OBV",0.40],["Pressured Pass%",0.35],["xGBuildup",0.25]],

  // Mezzala: late runs, box arrivals, carrying from midfield ‚Äî McTominay/Milinkovic type
  "Mezzala":              [["Dribble & Carry OBV",0.30],["xG",0.25],["Shot OBV",0.25],["Open Play xG Assisted",0.10],["LBP Received F3",0.10]],

  // High Press Midfielder: pure pressing intensity model
  "High Press Midfielder":[["PAdj Pressures",0.35],["Pressure Regains",0.30],["Counterpressures",0.20],["Ball Recoveries",0.15]],

  // ‚îÄ‚îÄ WINGERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  "Half Space Creator":   [["Dribble & Carry OBV",0.30],["Successful Crosses",0.20],["xGBuildup",0.15],["LBP Received F3",0.15],["Open Play Key Passes",0.20]],

  // Inverted Winger: FIX ‚Äî add Dribble% for take-on quality, not just volume
  "Inverted Winger":      [["Shot OBV",0.25],["Dribble & Carry OBV",0.20],["xG/Shot",0.15],["xG",0.15],["Dribble%",0.15],["PAdj Pressures",0.10]],

  "Creative Winger":      [["Dribble & Carry OBV",0.35],["xGBuildup",0.20],["Successful Crosses",0.25],["Deep Completions",0.10],["Carries",0.10]],
  "Game Breaker":         [["xG/Shot",0.20],["xG",0.15],["Shot OBV",0.20],["Shots",0.15],["LBP Received F3",0.15],["Open Play xG Assisted",0.10],["Successful Dribbles",0.05]],
  "Flyer":                [["Dribble & Carry OBV",0.30],["PAdj Tackles & Interceptions",0.20],["Open Play xG Assisted",0.20],["Open Play Key Passes",0.15],["Deep Completions",0.15]],

  // ‚îÄ‚îÄ STRIKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Advanced Striker: FIX overlap with Production ‚Äî remove Shots (volume), keep quality metrics
  // Clinical finisher: finishing above xG, shot quality, shot OBV value
  "Advanced Striker":     [["Over/Underperformance",0.30],["xG/Shot",0.25],["Shot OBV",0.25],["xG",0.20]],

  // Physical Striker: FIX ‚Äî reduce aerial dominance, add Dribble & Carry OBV + Successful Dribbles
  // Modern physical striker is powerful with the ball, not just aerial
  "Physical Striker":     [["Aerial Win%",0.15],["Aerial Wins",0.10],["Pressure Regains",0.20],["Shot OBV",0.20],["Dribble & Carry OBV",0.20],["Successful Dribbles",0.15]],

  // Creative Striker: FIX overlap with Number 10 ‚Äî emphasise xGBuildup (dropping deep) over receiving
  "Creative Striker":     [["xGBuildup",0.30],["Open Play xG Assisted",0.25],["Pass OBV",0.20],["Open Play Key Passes",0.15],["Shot OBV",0.10]],

  // Zone Mover: FIX ‚Äî add Dribble% for take-on quality, reduce raw Dribbles count
  "Zone Mover":           [["Dribble & Carry OBV",0.30],["Shot OBV",0.20],["Open Play Key Passes",0.20],["xG",0.15],["Dribble%",0.15]],

  // Press Forward: striker presser ‚Äî xG keeps striker identity distinct from High Press Midfielder
  "Press Forward":        [["PAdj Pressures",0.25],["Pressure Regains",0.20],["xG",0.25],["Ball Recoveries",0.15],["xG/Shot",0.15]],

  // Target Man: NEW ‚Äî hold-up, aerial, link-up. Giroud/Wood/Carroll type invisible in other models
  "Target Man":           [["xGBuildup",0.30],["Aerial Wins",0.25],["Open Play xG Assisted",0.20],["Pressured Pass%",0.15],["Successful Dribbles",0.10]],

  // ‚îÄ‚îÄ CROSS-POSITION ANALYTICAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Disruptor: FIX overlap with High Press ‚Äî remove pressing metrics, focus on positional defending
  "Disruptor":            [["Defensive Action OBV",0.35],["Tack/Dribbled Past%",0.25],["Defensive Action Regains",0.25],["PAdj Tackles & Interceptions",0.15]],

  "Ground Eaters":        [["Deep Completions",0.20],["xGBuildup",0.20],["Successful Dribbles",0.20],["Ball Recoveries",0.20],["PAdj Pressures",0.20]],
  "Prevention":           [["Defensive Action Regains",0.20],["Defensive Action OBV",0.20],["Aerial Wins",0.20],["Tack/Dribbled Past%",0.20],["Ball Recoveries",0.20]],

  // Possession: FIX overlap with DLP/Progression ‚Äî volume recycler, not a progressor
  // Weight Open Play Passes heavily ‚Äî this is about keeping the ball, not moving it forward
  "Possession":           [["Open Play Passes",0.35],["Pressured Pass%",0.30],["Pass OBV",0.20],["Pass Forward%",0.15]],

  // Progression: FIX overlap with DLP/Ball Progressor ‚Äî forward ball movement only
  "Progression":          [["Deep Completions",0.35],["Pass Forward%",0.25],["xGBuildup",0.25],["LBP Received F3",0.15]],

  "Penetration":          [["Deep Completions",0.15],["LBP Received F3",0.15],["Dribble & Carry OBV",0.15],["Carries",0.10],["Open Play Key Passes",0.15],["Dribbles",0.10],["Open Play xG Assisted",0.10],["xGBuildup",0.10]],

  // Production: FIX overlap with Advanced Striker/Box Crasher ‚Äî pure output model, all positions
  // Distinct from Advanced Striker: includes Non-Penalty Goals (actual output) not just quality
  "Production":           [["Non-Penalty Goals",0.25],["Shot OBV",0.20],["xG",0.20],["Shots",0.20],["Over/Underperformance",0.15]],

  // Pressure: FIX overlap with High Press Midfielder ‚Äî add Defensive Action Regains, remove Counterpressures
  // Cross-position pressing model ‚Äî broader than midfielder-specific High Press
  "Pressure":             [["PAdj Pressures",0.25],["Ball Recoveries",0.25],["Pressure Regains",0.25],["Defensive Action Regains",0.25]],
};

// ‚îÄ‚îÄ POSITION ‚Üí ARCHETYPE MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const POSITION_ARCHETYPES = {
  'Defender':   ['Dominant Defender', 'Ball Playing Defender', 'Wide Defender'],
  'Fullback':   ['Defensive Fullback', 'Attacking Fullback', 'Crossing Fullback', 'Zone Mover', 'Ground Eaters', 'Flyer'],
  'Midfielder': ['Holding Midfielder', 'Deep Lying Playmaker', 'High Press Midfielder', 'Ball Progressor', 'Mezzala', 'Number 10', 'Box Crasher', 'Game Breaker', 'Ground Eaters', 'Disruptor'],
  'Winger':     ['Flyer', 'Half Space Creator', 'Creative Winger', 'Game Breaker', 'Inverted Winger'],
  'Striker':    ['Advanced Striker', 'Physical Striker', 'Target Man', 'Creative Striker', 'Press Forward', 'Zone Mover', 'Game Breaker'],
};

// ‚îÄ‚îÄ POSITION BAR CHART METRIC DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NOTE: All stat columns in this CSV are already stored as per-90 rates.
// per90: true is kept as a display hint only (adds "p90" to label context)
// invert: true = lower raw value is better (rank will be flipped)
// pct: true = column stored as 0-1 decimal, multiply by 100 for display
// decimals: display decimal places for raw value
const POSITION_BARS = {
  Fullback: [
    { section: 'Pass Creation', metrics: [
      { label: 'Expected Assists p90',       col: 'Open Play xG Assisted', decimals: 3 },
      { label: 'OP Pass xT p90',             col: 'Pass OBV',              decimals: 3 },
      { label: 'Progressive Passes p90',     col: 'Deep Completions',      decimals: 1 },
      { label: 'Forward Pass Rate %',        col: 'Pass Forward%',         decimals: 0, pct: true },
      { label: 'Avg Pass Distance (ft)',     col: 'Average Pass Distance', decimals: 1 },
      { label: 'Successful Crosses p90',     col: 'Successful Crosses',    decimals: 2 },
      { label: 'Pass Received xT p90',       col: 'LBP Received F3',       decimals: 3 },
    ]},
    { section: 'Ball Carrying', metrics: [
      { label: 'Take On Attempts p90',        col: 'Dribbles',              decimals: 2 },
      { label: 'Dribble & Carry xT p90',     col: 'Dribble & Carry OBV',   decimals: 3 },
      { label: 'Pressured Ball Retention %', col: 'Pressured Pass%',       decimals: 0, pct: true },
    ]},
    { section: 'Aerial Play', metrics: [
      { label: 'Aerials Won %',              col: 'Aerial Win%',           decimals: 0, pct: true },
    ]},
    { section: 'Defensive Actions', metrics: [
      { label: 'Pressures OTA',              col: 'PAdj Pressures',        decimals: 1 },
      { label: 'Tackles + Interceptions OTA',col: 'PAdj Tackles & Interceptions', decimals: 1 },
      { label: 'Regains OTA',                col: 'Defensive Action Regains', decimals: 1 },
      { label: 'Def Actions xT p90',         col: 'Defensive Action OBV',  decimals: 3 },
      { label: 'Opp Half Recovery %',        col: 'Opp Half Recovery%',    decimals: 0, pct: true },
      { label: 'Crosses Allowed %',          col: 'Crossing%',             decimals: 0, pct: true, invert: true },
      { label: 'Def Ground Duel %',          col: 'Tack/Dribbled Past%',   decimals: 0, pct: true },
    ]},
  ],
  Defender: [
    { section: 'Possession', metrics: [
      { label: 'OP Pass xT p90',             col: 'Pass OBV',              decimals: 3 },
      { label: 'Progressive Passes p90',     col: 'Deep Completions',      decimals: 1 },
      { label: 'Forward Pass Rate %',        col: 'Pass Forward%',         decimals: 0, pct: true },
      { label: 'Avg Pass Distance (ft)',     col: 'Average Pass Distance', decimals: 1 },
      { label: 'Pressured Ball Retention %', col: 'Pressured Pass%',       decimals: 0, pct: true },
      { label: 'Dribble & Carry xT p90',     col: 'Dribble & Carry OBV',   decimals: 3 },
    ]},
    { section: 'Aerial Play', metrics: [
      { label: 'Aerials Won p90',            col: 'Aerial Wins',           decimals: 1 },
      { label: 'Aerials Won %',              col: 'Aerial Win%',           decimals: 0, pct: true },
    ]},
    { section: 'Defensive Actions', metrics: [
      { label: '% of Opp Shots Blocked',     col: 'Blocks/Shot',           decimals: 2 },
      { label: 'Pressures OTA',              col: 'PAdj Pressures',        decimals: 1 },
      { label: 'Tackles + Interceptions OTA',col: 'PAdj Tackles & Interceptions', decimals: 1 },
      { label: 'Regains OTA',                col: 'Defensive Action Regains', decimals: 1 },
      { label: 'Def Actions xT p90',         col: 'Defensive Action OBV',  decimals: 3 },
      { label: 'Opp Half Recovery %',        col: 'Opp Half Recovery%',    decimals: 0, pct: true },
      { label: 'Def Ground Duel %',          col: 'Tack/Dribbled Past%',   decimals: 0, pct: true },
    ]},
  ],
  Midfielder: [
    { section: 'Goal Production', metrics: [
      { label: 'NP xG p90',                  col: 'xG',                    decimals: 3 },
      { label: 'Shots p90',                  col: 'Shots',                 decimals: 2 },
    ]},
    { section: 'Pass Creation', metrics: [
      { label: 'Expected Assists p90',        col: 'Open Play xG Assisted', decimals: 3 },
      { label: 'Progressive Passes p90',      col: 'Deep Completions',      decimals: 1 },
      { label: 'Forward Pass Rate %',         col: 'Pass Forward%',         decimals: 0, pct: true },
      { label: 'Avg Pass Distance (ft)',      col: 'Average Pass Distance', decimals: 1 },
      { label: 'Key Passes p90',              col: 'Key Passes',            decimals: 2 },
      { label: 'Own Half Pass xT p90',        col: 'xGBuildup',             decimals: 3 },
      { label: 'OP Pass xT p90',              col: 'Pass OBV',              decimals: 3 },
      { label: 'Pass Received xT p90',        col: 'LBP Received F3',       decimals: 3 },
    ]},
    { section: 'Ball Carrying', metrics: [
      { label: 'Take On Attempts p90',        col: 'Dribbles',              decimals: 2 },
      { label: 'Dribble & Carry xT p90',      col: 'Dribble & Carry OBV',   decimals: 3 },
      { label: 'Pressured Ball Retention %',  col: 'Pressured Pass%',       decimals: 0, pct: true },
    ]},
    { section: 'Aerial Play', metrics: [
      { label: 'Aerials Won %',               col: 'Aerial Win%',           decimals: 0, pct: true },
    ]},
    { section: 'Defensive Actions', metrics: [
      { label: 'Pressures OTA',               col: 'PAdj Pressures',        decimals: 1 },
      { label: 'Counter Pressures OTA',       col: 'Counterpressures',      decimals: 1 },
      { label: 'Tackles + Interceptions OTA', col: 'PAdj Tackles & Interceptions', decimals: 1 },
      { label: 'Regains OTA',                 col: 'Defensive Action Regains', decimals: 1 },
      { label: 'Def Actions xT p90',          col: 'Defensive Action OBV',  decimals: 3 },
      { label: 'Def Ground Duel %',           col: 'Tack/Dribbled Past%',   decimals: 0, pct: true },
    ]},
  ],
  Winger: [
    { section: 'Goal Production', metrics: [
      { label: 'NP Goals p90',               col: 'Non-Penalty Goals',     decimals: 2 },
      { label: 'NP xG p90',                  col: 'xG',                    decimals: 3 },
      { label: 'Shots p90',                  col: 'Shots',                 decimals: 2 },
      { label: 'OP xG per Shot',             col: 'xG/Shot',               decimals: 3 },
    ]},
    { section: 'Pass Creation', metrics: [
      { label: 'Expected Assists p90',        col: 'Open Play xG Assisted', decimals: 3 },
      { label: 'OP Pass xT p90',              col: 'Pass OBV',              decimals: 3 },
      { label: 'Successful Crosses p90',      col: 'Successful Crosses',    decimals: 2 },
      { label: 'Non-Cross Key Passes p90',    col: 'Open Play Key Passes',  decimals: 2 },
      { label: 'Pass Received xT p90',        col: 'LBP Received F3',       decimals: 3 },
    ]},
    { section: 'Ball Carrying', metrics: [
      { label: 'Take On Attempts p90',        col: 'Dribbles',              decimals: 2 },
      { label: 'Successful Take Ons p90',     col: 'Successful Dribbles',   decimals: 2 },
      { label: 'Take On %',                   col: 'Dribble%',              decimals: 0, pct: true },
      { label: 'Dribble & Carry xT p90',      col: 'Dribble & Carry OBV',   decimals: 3 },
    ]},
    { section: 'Defensive Actions', metrics: [
      { label: 'Pressures OTA',               col: 'PAdj Pressures',        decimals: 1 },
      { label: 'Counter Pressures OTA',       col: 'Counterpressures',      decimals: 1 },
      { label: 'Pressure Regains OTA',        col: 'Pressure Regains',      decimals: 1 },
      { label: 'Tackles + Interceptions OTA', col: 'PAdj Tackles & Interceptions', decimals: 1 },
    ]},
  ],
  Striker: [
    { section: 'Goal Production', metrics: [
      { label: 'NP Goals p90',               col: 'Non-Penalty Goals',     decimals: 2 },
      { label: 'NP xG p90',                  col: 'xG',                    decimals: 3 },
      { label: 'Shots p90',                  col: 'Shots',                 decimals: 2 },
      { label: 'OP xG per Shot',             col: 'xG/Shot',               decimals: 3 },
      { label: 'Finishing xG Added p90',     col: 'Over/Underperformance', decimals: 3 },
    ]},
    { section: 'Creation', metrics: [
      { label: 'Expected Assists p90',        col: 'Open Play xG Assisted', decimals: 3 },
      { label: 'OP Pass xT p90',              col: 'Pass OBV',              decimals: 3 },
      { label: 'Dribble & Carry xT p90',      col: 'Dribble & Carry OBV',   decimals: 3 },
    ]},
    { section: 'Attacking 1v1s', metrics: [
      { label: 'Successful Take Ons p90',     col: 'Successful Dribbles',   decimals: 2 },
      { label: 'Take On %',                   col: 'Dribble%',              decimals: 0, pct: true },
    ]},
    { section: 'Hold Up Play', metrics: [
      { label: 'Pressured Ball Retention %',  col: 'Pressured Pass%',       decimals: 0, pct: true },
    ]},
    { section: 'Aerial Play', metrics: [
      { label: 'Aerials Won p90',             col: 'Aerial Wins',           decimals: 1 },
      { label: 'Aerials Won %',               col: 'Aerial Win%',           decimals: 0, pct: true },
    ]},
    { section: 'Defensive Actions', metrics: [
      { label: 'Pressures OTA',               col: 'PAdj Pressures',        decimals: 1 },
      { label: 'Counter Pressures OTA',       col: 'Counterpressures',      decimals: 1 },
      { label: 'Pressure Regains OTA',        col: 'Pressure Regains',      decimals: 1 },
      { label: 'Tackles + Interceptions OTA', col: 'PAdj Tackles & Interceptions', decimals: 1 },
    ]},
  ],
};
function num(v) { return (v === null || v === undefined || v === '' || isNaN(v)) ? 0 : +v; }
function playerKey(r) { return `${r['Player Name']}|||${r['Team']}|||${r['Competition']}`; }

function assignPosition(pos) {
  if (!pos) return "Unknown";
  const s = new Set(["Centre Forward","Left Centre Forward","Right Centre Forward"]);
  const w = new Set(["Left Attacking Midfielder","Left Midfielder","Right Attacking Midfielder","Right Midfielder","Left Wing","Right Wing"]);
  const m = new Set(["Right Defensive Midfielder","Left Defensive Midfielder","Right Centre Midfielder","Left Centre Midfielder","Centre Defensive Midfielder","Centre Attacking Midfielder"]);
  const f = new Set(["Left Back","Left Wing Back","Right Back","Right Wing Back"]);
  const d = new Set(["Centre Back","Left Centre Back","Right Centre Back"]);
  if (s.has(pos)) return "Striker"; if (w.has(pos)) return "Winger"; if (m.has(pos)) return "Midfielder";
  if (f.has(pos)) return "Fullback"; if (d.has(pos)) return "Defender"; return "Unknown";
}

function groupZScore(data, groupKeys, valueKey) {
  const groups = {};
  data.forEach((row, i) => { const k = groupKeys.map(gk => row[gk]).join('|||'); if (!groups[k]) groups[k] = []; groups[k].push({ i, v: num(row[valueKey]) }); });
  const result = new Array(data.length).fill(0);
  Object.values(groups).forEach(grp => {
    const vals = grp.map(x => x.v);
    const mean = vals.reduce((a, b) => a + b, 0) / vals.length;
    const std  = Math.sqrt(vals.reduce((a, b) => a + (b - mean) ** 2, 0) / vals.length);
    grp.forEach(({ i, v }) => { result[i] = std > 0 ? +( ((v - mean) / std) * 100 ).toFixed(2) : 0; });
  });
  return result;
}

function normalizeToRank(arr) {
  const min = Math.min(...arr), max = Math.max(...arr);
  if (max === min) return arr.map(() => 50);
  return arr.map(v => +( (v - min) / (max - min) * 100 ).toFixed(1));
}

// ‚îÄ‚îÄ DATA PROCESSING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildLeagueMatchMap(rows) {
  const maxApps = {};
  rows.forEach(row => {
    const league = LEAGUE_MAP[+row['Competition Id']] || '';
    if (!league) return;
    const apps = num(row['Appearances']);
    if (!maxApps[league] || apps > maxApps[league]) maxApps[league] = apps;
  });
  return maxApps;
}

function processData(rows) {
  rows.forEach(row => {
    row['League'] = LEAGUE_MAP[+row['Competition Id']] || '';
    row['Minutes Played'] = Math.round(num(row['Minutes Played']));
  });

  const leagueMatchMap = buildLeagueMatchMap(rows);
  rows.forEach(row => {
    const maxApps = leagueMatchMap[row['League']] || 0;
    row['Available Minutes'] = maxApps * 90;
    row['Usage'] = row['Available Minutes'] > 0 ? +((row['Minutes Played'] / row['Available Minutes']) * 100).toFixed(2) : 0;
    row['Position'] = assignPosition(row['Primary Position']);
    row['Touches per 90'] = +(num(row['Open Play Passes']) + num(row['Carries']) + num(row['Dribbles']) + num(row['Shots'])).toFixed(2);
    // Derived: opposition half recovery rate
    const totalRec = num(row['Ball Recoveries']);
    row['Opp Half Recovery%'] = totalRec > 0 ? +(num(row['Opposition Half Ball Recoveries']) / totalRec).toFixed(4) : 0;
  });

  Object.entries(MODELS).forEach(([model, features]) => {
    rows.forEach(row => { row[model] = features.reduce((s, [col, w]) => s + num(row[col]) * w, 0); });
    const zs = groupZScore(rows, ['Competition', 'Position'], model);
    const rs = normalizeToRank(zs);
    rows.forEach((row, i) => { row[`${model} ZScore`] = zs[i]; row[`${model} Rank`] = rs[i]; });
  });

  ['OBV', 'Pass OBV', 'Dribble & Carry OBV', 'Shot OBV'].forEach(m => {
    if (rows[0] && !(m in rows[0])) rows.forEach(r => r[m] = 0);
    const zs = groupZScore(rows, ['Competition', 'Position'], m);
    const rs = normalizeToRank(zs);
    rows.forEach((row, i) => { row[`${m} ZScore`] = zs[i]; row[`${m} Rank`] = rs[i]; });
  });

  // ‚îÄ‚îÄ POSITION BAR METRICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // All stat columns are already per-90 rates ‚Äî no division needed.
  // Only players with >= minNineties 90s are used in the ranking pool.
  // Low-sample players are interpolated against the qualifying pool and flagged.
  const barMetricSet = new Map();
  Object.values(POSITION_BARS).forEach(sections => {
    sections.forEach(({ metrics }) => {
      metrics.forEach(m => {
        const key = m.col + (m.invert ? '_inv' : '');
        if (!barMetricSet.has(key)) barMetricSet.set(key, m);
      });
    });
  });

  barMetricSet.forEach((m, key) => {
    const groups = {};
    rows.forEach((row, i) => {
      const gk = `${row['Position']}|||${row['League']}`;
      if (!groups[gk]) groups[gk] = [];
      groups[gk].push({ i, v: num(row[m.col]), n: num(row['90s Played']) });
    });

    const result = new Array(rows.length).fill(50);
    Object.values(groups).forEach(grp => {
      const pool = grp.filter(x => x.n >= minNineties);
      if (pool.length < 2) { grp.forEach(({i}) => result[i] = 50); return; }

      const vals = pool.map(x => x.v);
      const mean = vals.reduce((a,b) => a+b,0) / vals.length;
      const std  = Math.sqrt(vals.reduce((a,b) => a+(b-mean)**2,0) / vals.length);
      const zs   = vals.map(v => std>0 ? (v-mean)/std : 0);
      const mn = Math.min(...zs), mx = Math.max(...zs);

      // Rank qualifying players
      pool.forEach(({i},j) => {
        let rank = mx>mn ? (zs[j]-mn)/(mx-mn)*100 : 50;
        if (m.invert) rank = 100-rank;
        result[i] = +rank.toFixed(1);
      });

      // Interpolate non-qualifying players against same pool stats
      grp.filter(x => x.n < minNineties).forEach(({i,v}) => {
        const z = std>0 ? (v-mean)/std : 0;
        let rank = mx>mn ? Math.max(0,Math.min(100,(z-mn)/(mx-mn)*100)) : 50;
        if (m.invert) rank = 100-rank;
        result[i] = +rank.toFixed(1);
      });
    });

    rows.forEach((row,i) => { row[`${key}_BarRank`] = result[i]; });
  });

  rawData = rows;
  onDataLoaded();
}

function recomputeBarRanks() {
  const barMetricSet = new Map();
  Object.values(POSITION_BARS).forEach(sections => {
    sections.forEach(({ metrics }) => {
      metrics.forEach(m => {
        const key = m.col + (m.invert ? '_inv' : '');
        if (!barMetricSet.has(key)) barMetricSet.set(key, m);
      });
    });
  });

  barMetricSet.forEach((m, key) => {
    const groups = {};
    rawData.forEach((row, i) => {
      const gk = `${row['Position']}|||${row['League']}`;
      if (!groups[gk]) groups[gk] = [];
      groups[gk].push({ i, v: num(row[m.col]), n: num(row['90s Played']) });
    });

    const result = new Array(rawData.length).fill(50);
    Object.values(groups).forEach(grp => {
      const pool = grp.filter(x => x.n >= minNineties);
      if (pool.length < 2) { grp.forEach(({i}) => result[i] = 50); return; }
      const vals = pool.map(x => x.v);
      const mean = vals.reduce((a,b) => a+b,0) / vals.length;
      const std  = Math.sqrt(vals.reduce((a,b) => a+(b-mean)**2,0) / vals.length);
      const zs   = vals.map(v => std>0 ? (v-mean)/std : 0);
      const mn = Math.min(...zs), mx = Math.max(...zs);
      pool.forEach(({i},j) => {
        let rank = mx>mn ? (zs[j]-mn)/(mx-mn)*100 : 50;
        if (m.invert) rank = 100-rank;
        result[i] = +rank.toFixed(1);
      });
      grp.filter(x => x.n < minNineties).forEach(({i,v}) => {
        const z = std>0 ? (v-mean)/std : 0;
        let rank = mx>mn ? Math.max(0,Math.min(100,(z-mn)/(mx-mn)*100)) : 50;
        if (m.invert) rank = 100-rank;
        result[i] = +rank.toFixed(1);
      });
    });
    rawData.forEach((row,i) => { row[`${key}_BarRank`] = result[i]; });
  });
}

function onDataLoaded() {
  document.getElementById('status-text').textContent = `${rawData.length.toLocaleString()} records loaded`;
  const uPlayers = new Set(rawData.map(r => r['Player Name'])).size;
  const uLeagues = new Set(rawData.map(r => r['League']).filter(Boolean)).size;
  document.getElementById('stat-records').textContent = rawData.length.toLocaleString();
  document.getElementById('stat-players').textContent = uPlayers.toLocaleString();
  document.getElementById('stat-leagues').textContent = uLeagues;
  document.getElementById('stat-models').textContent  = Object.keys(MODELS).length;
  document.getElementById('home-stats').style.display = 'block';
  uploadZone.innerHTML = `<div class="upload-icon">‚úÖ</div><div class="upload-title">Data Loaded</div><div class="upload-sub">${rawData.length.toLocaleString()} records ¬∑ Click to reload a different file</div><input type="file" id="file-input" accept=".csv">`;
  document.getElementById('file-input').addEventListener('change', e => loadFile(e.target.files[0]));
  populateFilters();
  ['scout-no-data','obv-no-data'].forEach(id => document.getElementById(id).style.display = 'none');
  ['scout-content','obv-content'].forEach(id => document.getElementById(id).style.display = 'block');
  applyScoutFilters();
  applyOBVFilters();
  updateShortlistBadge();
  updateReportsBadge();
  updateTargetsBadge();
  initScatter();
}




function buildLeagueCheckboxes(containerId, prefix) {
  const leagues = [...new Set(rawData.map(r => r['League']).filter(Boolean))].sort();
  document.getElementById(containerId).innerHTML = leagues.map(l =>
    `<label class="league-option">
      <input type="checkbox" value="${l}" onchange="updateLeagueTrigger('${prefix}')">
      ${l}
    </label>`
  ).join('');
}

function toggleLeague(prefix) {
  const panel   = document.getElementById(`${prefix}-league-list`);
  const trigger = document.getElementById(`${prefix}-league-trigger`);
  const isOpen  = panel.classList.contains('open');
  // Close all panels first
  document.querySelectorAll('.league-panel').forEach(p => p.classList.remove('open'));
  document.querySelectorAll('.league-trigger').forEach(t => t.classList.remove('open'));
  if (!isOpen) { panel.classList.add('open'); trigger.classList.add('open'); }
}

function updateLeagueTrigger(prefix) {
  const checked = getCheckedLeagues(`${prefix}-league-list`);
  const trigger = document.getElementById(`${prefix}-league-trigger`);
  const textEl  = document.getElementById(`${prefix}-league-trigger-text`);
  if (checked.length === 0) {
    textEl.textContent = 'All Leagues';
    trigger.classList.remove('has-selection');
  } else if (checked.length === 1) {
    textEl.textContent = checked[0];
    trigger.classList.add('has-selection');
  } else {
    textEl.textContent = `${checked.length} leagues selected`;
    trigger.classList.add('has-selection');
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.league-dropdown')) {
    document.querySelectorAll('.league-panel').forEach(p => p.classList.remove('open'));
    document.querySelectorAll('.league-trigger').forEach(t => t.classList.remove('open'));
  }
});

function updateLeagueSummary(containerId, summaryId) {
  const checked = getCheckedLeagues(containerId);
  const el = document.getElementById(summaryId);
  el.textContent = checked.length === 0 ? '' : checked.length === 1 ? checked[0] : `${checked.length} leagues selected`;
}

function getCheckedLeagues(containerId) {
  return [...document.querySelectorAll(`#${containerId} input:checked`)].map(cb => cb.value);
}

function clearLeagues(containerId, prefix) {
  document.querySelectorAll(`#${containerId} input`).forEach(cb => cb.checked = false);
  updateLeagueTrigger(prefix);
}

function populateFilters() {
  const positions = [...new Set(rawData.map(r => r['Position']).filter(Boolean))].sort();
  const seasons   = [...new Set(rawData.map(r => r['Season']).filter(Boolean))].sort();

  const fill = (id, opts) => {
    const el = document.getElementById(id), first = el.options[0];
    el.innerHTML = ''; el.appendChild(first);
    opts.forEach(o => { const opt = document.createElement('option'); opt.value = opt.textContent = o; el.appendChild(opt); });
  };
  fill('f-position', positions); fill('f-season', seasons); fill('o-position', positions);
  fill('sc-position', positions);
  buildLeagueCheckboxes('f-league-list', 'f');
  buildLeagueCheckboxes('o-league-list', 'o');
  buildLeagueCheckboxes('sc-league-list', 'sc');

  const modelSel = document.getElementById('f-archetype');
  modelSel.innerHTML = '';
  Object.keys(MODELS).forEach(m => { const o = document.createElement('option'); o.value = o.textContent = m; modelSel.appendChild(o); });

  const ages = rawData.map(r => num(r['Age'])).filter(a => a > 0);
  const minA = Math.min(...ages), maxA = Math.max(...ages);
  document.getElementById('f-age-min').value = minA; document.getElementById('f-age-max').value = maxA;
  document.getElementById('o-age-min').value = minA; document.getElementById('o-age-max').value = maxA;
  document.getElementById('sc-age-min').value = minA; document.getElementById('sc-age-max').value = maxA;
}

// ‚îÄ‚îÄ FILTERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterData(posId, leagueListId, seasonId, ageMinId, ageMaxId, usageId, nameSearchId, teamSearchId) {
  const pos     = document.getElementById(posId)?.value || '';
  const leagues = getCheckedLeagues(leagueListId);
  const season  = seasonId ? document.getElementById(seasonId)?.value || '' : '';
  const ageMin  = document.getElementById(ageMinId).value !== '' ? +document.getElementById(ageMinId).value : 0;
  const ageMax  = document.getElementById(ageMaxId).value !== '' ? +document.getElementById(ageMaxId).value : 999;
  const usage   = document.getElementById(usageId).value  !== '' ? +document.getElementById(usageId).value  : 0;
  const name    = nameSearchId ? (document.getElementById(nameSearchId)?.value || '').toLowerCase().trim() : '';
  const team    = teamSearchId ? (document.getElementById(teamSearchId)?.value || '').toLowerCase().trim() : '';
  return rawData.filter(r => {
    if (pos && r['Position'] !== pos) return false;
    if (leagues.length && !leagues.includes(r['League'])) return false;
    if (season && String(r['Season']) !== String(season)) return false;
    if (num(r['Age']) < ageMin || num(r['Age']) > ageMax) return false;
    if (num(r['Usage']) < usage) return false;
    if (name && !(r['Player Name'] || '').toLowerCase().includes(name)) return false;
    if (team && !(r['Team'] || '').toLowerCase().includes(team)) return false;
    return true;
  });
}

function applyScoutFilters() {
  const model = document.getElementById('f-archetype').value;
  const rankCol = `${model} Rank`;

  // Re-run bar chart rankings if min90s threshold has changed
  const newMin90s = Math.max(1, +(document.getElementById('f-min90s')?.value || 5));
  if (newMin90s !== minNineties && rawData.length) {
    minNineties = newMin90s;
    recomputeBarRanks();
  }

  let filtered = filterData('f-position','f-league-list','f-season','f-age-min','f-age-max','f-usage','f-name-search','f-team-search');
  filtered = filtered.sort((a, b) => num(b[rankCol]) - num(a[rankCol]));
  scoutFiltered = filtered; scoutPage = 1; scoutSort = { col: rankCol, dir: 'desc' };
  document.getElementById('scout-count').textContent = filtered.length.toLocaleString();
  document.getElementById('scout-archetype-label').textContent = model;
  renderScoutTable();
}

function clearScoutFilters() {
  document.getElementById('f-position').value = '';
  clearLeagues('f-league-list','f');
  document.getElementById('f-season').value = '';
  const ages = rawData.map(r => num(r['Age'])).filter(a => a > 0);
  document.getElementById('f-age-min').value = Math.min(...ages);
  document.getElementById('f-age-max').value = Math.max(...ages);
  document.getElementById('f-usage').value = 0;
  document.getElementById('f-name-search').value = '';
  document.getElementById('f-team-search').value = '';
  applyScoutFilters();
}

function applyOBVFilters() {
  const sort = document.getElementById('o-sort').value;
  let filtered = filterData('o-position','o-league-list',null,'o-age-min','o-age-max','o-usage','o-name-search','o-team-search');
  filtered = filtered.sort((a, b) => num(b[sort]) - num(a[sort]));
  obvFiltered = filtered; obvPage = 1; obvSort = { col: sort, dir: 'desc' };
  document.getElementById('obv-count').textContent = filtered.length.toLocaleString();
  document.getElementById('obv-sort-label').textContent = sort;
  renderOBVTable(); updateOBVSummary();
}

function clearOBVFilters() {
  document.getElementById('o-position').value = '';
  clearLeagues('o-league-list','o');
  const ages = rawData.map(r => num(r['Age'])).filter(a => a > 0);
  document.getElementById('o-age-min').value = Math.min(...ages);
  document.getElementById('o-age-max').value = Math.max(...ages);
  document.getElementById('o-usage').value = 0;
  document.getElementById('o-name-search').value = '';
  document.getElementById('o-team-search').value = '';
  applyOBVFilters();
}

// ‚îÄ‚îÄ SORTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sortArr(arr, col, dir) {
  return [...arr].sort((a, b) => {
    const av = a[col], bv = b[col], an = parseFloat(av), bn = parseFloat(bv);
    if (!isNaN(an) && !isNaN(bn)) return dir === 'asc' ? an - bn : bn - an;
    return dir === 'asc' ? String(av ?? '').localeCompare(String(bv ?? '')) : String(bv ?? '').localeCompare(String(av ?? ''));
  });
}
function handleScoutSort(col) {
  scoutSort.dir = (scoutSort.col === col && scoutSort.dir === 'desc') ? 'asc' : 'desc';
  scoutSort.col = col; scoutFiltered = sortArr(scoutFiltered, col, scoutSort.dir); scoutPage = 1; renderScoutTable();
}
function handleOBVSort(col) {
  obvSort.dir = (obvSort.col === col && obvSort.dir === 'desc') ? 'asc' : 'desc';
  obvSort.col = col; obvFiltered = sortArr(obvFiltered, col, obvSort.dir); obvPage = 1; renderOBVTable();
}

// ‚îÄ‚îÄ TABLE RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rankClass(v) { return v >= 70 ? 'rank-high' : v >= 40 ? 'rank-mid' : 'rank-low'; }

function posBadge(pos) {
  const map = { Striker:'pos-striker', Winger:'pos-winger', Midfielder:'pos-midfielder', Fullback:'pos-fullback', Defender:'pos-defender' };
  const cls = map[pos] || 'pos-unknown';
  return `<span class="pos-badge ${cls}">${pos||'‚Äî'}</span>`;
}

function thHTML(label, col, sortState, handler) {
  if (!col) return `<th>#</th>`;
  const s = sortState.col === col;
  const arrow = s ? (sortState.dir === 'desc' ? '‚ñº' : '‚ñ≤') : '‚áÖ';
  return `<th class="${s ? 'sorted' : ''}" onclick="${handler}('${col.replace(/'/g, "\\'")}')">${label}<span class="sort-arrow">${arrow}</span></th>`;
}

// ‚îÄ‚îÄ CONDITIONAL FORMATTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns a colour based on a 0-100 rank percentile
function cfCol(rankVal) {
  const r = num(rankVal);
  if (r >= 70) return 'var(--green)';
  if (r >= 45) return 'var(--amber)';
  if (r >= 25) return '#E09450';
  return 'var(--crimson)';
}
function cfCell(raw, rankVal) {
  const col = cfCol(rankVal);
  return `<td style="color:${col};font-weight:600">${raw}</td>`;
}

function renderScoutTable() {
  const model = document.getElementById('f-archetype').value;
  const rankCol = `${model} Rank`;
  const cols = [
    {l:'#',c:null},{l:'Player',c:'Player Name'},{l:'Team',c:'Team'},{l:'League',c:'League'},
    {l:'Competition',c:'Competition'},{l:'Position',c:'Position'},{l:'Age',c:'Age'},
    {l:'Usage %',c:'Usage'},{l:'Archetype Rank',c:rankCol},{l:'Touches p90',c:'Touches per 90'}
  ];
  document.getElementById('scout-thead').innerHTML = '<tr>' + cols.map(d => thHTML(d.l, d.c, scoutSort, 'handleScoutSort')).join('') + '</tr>';
  const start = (scoutPage - 1) * PAGE_SIZE;
  document.getElementById('scout-tbody').innerHTML = scoutFiltered.slice(start, start + PAGE_SIZE).map((r, i) => {
    const rank    = num(r[rankCol]);
    const pKey    = playerKey(r);
    const hasNote = notes[pKey] ? 'has-note' : '';
    const hasReport = reports[reportKey(r['Player Name'], r['Team'])] ? 'has-report' : '';
    const onSL    = shortlist.some(s => s.key === pKey);
    const onWL    = watchlist.some(s => s.key === pKey);
    const listInd = onSL ? ' <span title="On Shortlist" style="font-size:0.65rem;color:var(--amber)">‚≠ê</span>'
                  : onWL ? ' <span title="On Watchlist" style="font-size:0.65rem;color:var(--amber)">üëÅ</span>' : '';
    const noteText = notes[pKey] ? notes[pKey].trim() : '';
    const noteRow  = noteText
      ? `<tr class="note-preview-row" onclick="openProfile(${rawData.indexOf(r)})">
           <td colspan="10" style="padding:0.25rem 0.9rem 0.5rem 2.5rem;font-size:0.76rem;color:var(--muted);font-style:italic;border-bottom:none;">${noteText.slice(0,160)}${noteText.length>160?'‚Ä¶':''}</td>
         </tr>`
      : '';
    const touchRank = num(r['Touches per 90_BarRank']);
    return `<tr onclick="openProfile(${rawData.indexOf(r)})">
      <td class="muted">${start + i + 1}</td>
      <td class="player-name ${hasNote} ${hasReport}">${r['Player Name'] || '‚Äî'}${listInd}</td>
      <td class="muted">${r['Team'] || '‚Äî'}</td>
      <td class="muted">${r['League'] || '‚Äî'}</td>
      <td class="muted">${r['Competition'] || '‚Äî'}</td>
      <td>${posBadge(r['Position'])}</td>
      <td class="muted">${r['Age'] || '‚Äî'}</td>
      ${cfCell(num(r['Usage']).toFixed(1)+'%', rank)}
      <td><span class="rank-badge ${rankClass(rank)}">${rank.toFixed(1)}</span></td>
      ${cfCell(num(r['Touches per 90']).toFixed(1), touchRank)}
    </tr>${noteRow}`;
  }).join('');
  renderPagination('scout-pagination', scoutFiltered.length, scoutPage, p => { scoutPage = p; renderScoutTable(); });
}

function renderOBVTable() {
  const cols = [
    {l:'#',c:null},{l:'Player',c:'Player Name'},{l:'Team',c:'Team'},{l:'League',c:'League'},
    {l:'Position',c:'Position'},{l:'Age',c:'Age'},{l:'Usage %',c:'Usage'},{l:'Touches p90',c:'Touches per 90'},
    {l:'OBV Rank',c:'OBV Rank'},{l:'Pass OBV Rank',c:'Pass OBV Rank'},
    {l:'D&C OBV Rank',c:'Dribble & Carry OBV Rank'},{l:'Shot OBV Rank',c:'Shot OBV Rank'}
  ];
  document.getElementById('obv-thead').innerHTML = '<tr>' + cols.map(d => thHTML(d.l, d.c, obvSort, 'handleOBVSort')).join('') + '</tr>';
  const start = (obvPage - 1) * PAGE_SIZE;
  document.getElementById('obv-tbody').innerHTML = obvFiltered.slice(start, start + PAGE_SIZE).map((r, i) => {
    const obv = num(r['OBV Rank']), pass = num(r['Pass OBV Rank']), drib = num(r['Dribble & Carry OBV Rank']), shot = num(r['Shot OBV Rank']);
    const pKey = playerKey(r);
    const hasNote   = notes[pKey] ? 'has-note' : '';
    const hasReport = reports[reportKey(r['Player Name'], r['Team'])] ? 'has-report' : '';
    const onSL  = shortlist.some(s => s.key === pKey);
    const onWL  = watchlist.some(s => s.key === pKey);
    const listInd = onSL ? ' <span title="On Shortlist" style="font-size:0.65rem;color:var(--amber)">‚≠ê</span>'
                  : onWL ? ' <span title="On Watchlist" style="font-size:0.65rem;color:var(--amber)">üëÅ</span>' : '';
    const touchRank = num(r['Touches per 90_BarRank']);
    return `<tr onclick="openProfile(${rawData.indexOf(r)})">
      <td class="muted">${start + i + 1}</td>
      <td class="player-name ${hasNote} ${hasReport}">${r['Player Name'] || '‚Äî'}${listInd}</td>
      <td class="muted">${r['Team'] || '‚Äî'}</td>
      <td class="muted">${r['League'] || '‚Äî'}</td>
      <td>${posBadge(r['Position'])}</td>
      <td class="muted">${r['Age'] || '‚Äî'}</td>
      ${cfCell(num(r['Usage']).toFixed(1)+'%', obv)}
      ${cfCell(num(r['Touches per 90']).toFixed(1), touchRank)}
      <td><span class="rank-badge ${rankClass(obv)}">${obv.toFixed(1)}</span></td>
      <td><span class="rank-badge ${rankClass(pass)}">${pass.toFixed(1)}</span></td>
      <td><span class="rank-badge ${rankClass(drib)}">${drib.toFixed(1)}</span></td>
      <td><span class="rank-badge ${rankClass(shot)}">${shot.toFixed(1)}</span></td>
    </tr>`;
  }).join('');
  renderPagination('obv-pagination', obvFiltered.length, obvPage, p => { obvPage = p; renderOBVTable(); });
}

function updateOBVSummary() {
  const avg = (arr, key) => arr.length ? arr.reduce((s, r) => s + num(r[key]), 0) / arr.length : 0;
  document.getElementById('sum-touches').textContent = avg(obvFiltered, 'Touches per 90').toFixed(1);
  document.getElementById('sum-obv').textContent     = avg(obvFiltered, 'OBV Rank').toFixed(1);
  document.getElementById('sum-pass').textContent    = avg(obvFiltered, 'Pass OBV Rank').toFixed(1);
  document.getElementById('sum-shot').textContent    = avg(obvFiltered, 'Shot OBV Rank').toFixed(1);
}

function renderPagination(id, total, current, onPage) {
  const pages = Math.ceil(total / PAGE_SIZE);
  const el = document.getElementById(id);
  if (pages <= 1) { el.innerHTML = ''; return; }
  el.innerHTML = `<button class="page-btn" onclick="(${onPage.toString()})(${current - 1})" ${current===1?'disabled':''}>‚Äπ Prev</button>
    <span class="page-info">Page ${current} of ${pages}</span>
    <button class="page-btn" onclick="(${onPage.toString()})(${current + 1})" ${current===pages?'disabled':''}>Next ‚Ä∫</button>`;
}

// ‚îÄ‚îÄ POSITION BAR CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pbarColour(pct) {
  if (pct >= 70) return 'green';
  if (pct >= 45) return 'yellow';
  if (pct >= 25) return 'orange';
  return 'red';
}

function pbarRawDisplay(row, m) {
  const rawVal = num(row[m.col]);
  // Percentage columns are stored as 0‚Äì1 decimals in the CSV
  if (m.pct) return Math.round(rawVal * 100) + '%';
  return rawVal.toFixed(m.decimals ?? 2);
}

function renderPositionBars(r) {
  const pos = r['Position'];
  const sections = POSITION_BARS[pos];
  const el = document.getElementById('modal-position-bars');
  if (!el) return;
  if (!sections) { el.innerHTML = ''; return; }

  const nineties = num(r['90s Played']);
  const isLowSample = nineties < minNineties;
  const banner = isLowSample
    ? `<div class="pbar-sample-banner">‚ö† ${nineties.toFixed(1)} 90s played ‚Äî rankings are indicative only (threshold: ${minNineties} 90s). Adjust in filters.</div>`
    : '';

  el.innerHTML = banner + sections.map(({ section, metrics }) => {
    const rowsHtml = metrics.map(m => {
      const key = m.col + (m.invert ? '_inv' : '');
      const pct  = Math.round(num(r[`${key}_BarRank`]));
      const col  = pbarColour(pct);
      const raw  = pbarRawDisplay(r, m);
      return `<div class="pbar-row">
        <div class="pbar-label">${m.label}</div>
        <div class="pbar-raw">${raw}</div>
        <div class="pbar-track"><div class="pbar-fill pbar-${col}" style="width:${pct}%"></div></div>
        <div class="pbar-pct pbar-${col}-txt">${pct}%</div>
      </div>`;
    }).join('');
    return `<div class="pbar-section">
      <div class="pbar-section-title">${section}</div>
      ${rowsHtml}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ AGE CURVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Default metrics to pre-select per position (up to 4)
const AGE_CURVE_DEFAULTS = {
  Defender:   ['Pass OBV','Defensive Action OBV','Aerial Win%','Dribble & Carry OBV'],
  Fullback:   ['Pass OBV','Dribble & Carry OBV','Defensive Action OBV','Open Play xG Assisted'],
  Midfielder: ['Pass OBV','xGBuildup','Shot OBV','Defensive Action OBV'],
  Winger:     ['Dribble & Carry OBV','Shot OBV','Open Play xG Assisted','Successful Crosses'],
  Striker:    ['xG','Shot OBV','Over/Underperformance','Open Play xG Assisted'],
};

const CURVE_COLORS = ['#D71920','#3CB371','#5B8FD4','#E8A020','#9B59B6','#E67E22'];

function populateAgeCurveMetrics(pos) {
  const wrap = document.getElementById('age-curve-metric-list');
  if (!wrap) return;
  const sections = POSITION_BARS[pos] || [];
  const metrics  = sections.flatMap(s => s.metrics);
  const defaults = AGE_CURVE_DEFAULTS[pos] || [];

  wrap.innerHTML = metrics.map((m, i) => {
    const checked = defaults.includes(m.col) ? 'checked' : '';
    const color   = CURVE_COLORS[defaults.indexOf(m.col)] || '#888';
    return `<label style="display:flex;align-items:center;gap:0.3rem;font-size:0.72rem;color:var(--text);background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:0.2rem 0.5rem;cursor:pointer;">
      <input type="checkbox" value="${m.col}|${m.invert?'1':'0'}|${m.pct?'1':'0'}|${m.decimals??2}" ${checked} onchange="drawAgeCurve()" style="accent-color:${color};width:12px;height:12px;">
      ${m.label}
    </label>`;
  }).join('');
}

function drawAgeCurve() {
  const el = document.getElementById('modal-age-curve');
  if (!el) return;
  if (!currentProfileKey) { el.innerHTML = ''; return; }
  const r = rawData.find(row => playerKey(row) === currentProfileKey);
  if (!r) { el.innerHTML = ''; return; }

  const pos       = r['Position'];
  const playerAge = num(r['Age']);

  // Collect checked metrics
  const checks = document.querySelectorAll('#age-curve-metric-list input[type=checkbox]:checked');
  if (!checks.length) { el.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;padding:0.5rem 0;">Select at least one metric above.</div>'; return; }

  const selectedMetrics = Array.from(checks).slice(0, 6).map((cb, ci) => {
    const [col, invertStr, pctStr, decimalsStr] = cb.value.split('|');
    return { col, invert: invertStr==='1', isPct: pctStr==='1', decimals: +decimalsStr, color: CURVE_COLORS[ci] };
  });

  const peers = rawData.filter(row => row['Position'] === pos && num(row['90s Played']) >= minNineties);

  function pctile(arr, p) {
    const sorted = [...arr].sort((a,b) => a-b);
    const idx = p/100 * (sorted.length - 1);
    const lo = Math.floor(idx), hi = Math.ceil(idx);
    return sorted[lo] + (sorted[hi]-sorted[lo])*(idx-lo);
  }

  // SVG dimensions
  const W = 560, H = 200, ML = 32, MR = 12, MT = 16, MB = 28;
  const PW = W - ML - MR, PH = H - MT - MB;

  // Collect all ages across all metrics
  const allAges = new Set();
  peers.forEach(row => allAges.add(Math.round(num(row['Age']))));
  const ages = [...allAges].filter(a => a >= 16 && a <= 35).sort((a,b) => a-b);
  if (ages.length < 3) { el.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;padding:0.5rem 0;">Not enough age data.</div>'; return; }

  const ageMin = Math.min(...ages), ageMax = Math.max(...ages);
  const xScale = age  => ML + (age - ageMin) / (ageMax - ageMin) * PW;
  const yScale = rank => MT + (1 - rank / 100) * PH;

  // Grid
  const gridLines = [0, 25, 50, 75, 100].map(v => {
    const y = yScale(v).toFixed(1);
    return `<line x1="${ML}" y1="${y}" x2="${W-MR}" y2="${y}" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
            <text x="${ML-4}" y="${+y+3}" text-anchor="end" font-size="8" fill="#555">${v}</text>`;
  }).join('');
  const xLabels = ages.filter((a,i) => i%2===0 || a===playerAge).map(age =>
    `<text x="${xScale(age).toFixed(1)}" y="${H-4}" text-anchor="middle" font-size="8" fill="#555">${age}</text>`
  ).join('');

  // Player age line
  const ageLine = `<line x1="${xScale(playerAge).toFixed(1)}" y1="${MT}" x2="${xScale(playerAge).toFixed(1)}" y2="${MT+PH}" stroke="rgba(255,255,255,0.12)" stroke-width="1" stroke-dasharray="3 2"/>`;

  // Build paths for each metric
  let metricPaths = '';
  const legendItems = [];
  const playerDots  = [];

  selectedMetrics.forEach(({ col, invert, isPct, decimals, color }) => {
    const metricKey = col + (invert ? '_inv' : '');
    const byAge = {};
    peers.forEach(row => {
      const age = Math.round(num(row['Age']));
      if (!byAge[age]) byAge[age] = [];
      byAge[age].push(num(row[`${metricKey}_BarRank`]));
    });

    const ageStats = ages.filter(a => byAge[a]?.length >= 2).map(age => ({
      age, median: pctile(byAge[age], 50),
      p25: pctile(byAge[age], 25), p75: pctile(byAge[age], 75)
    }));
    if (ageStats.length < 2) return;

    const bandTop    = ageStats.map((d,i) => `${i===0?'M':'L'}${xScale(d.age).toFixed(1)},${yScale(d.p75).toFixed(1)}`).join(' ');
    const bandBottom = [...ageStats].reverse().map(d => `L${xScale(d.age).toFixed(1)},${yScale(d.p25).toFixed(1)}`).join(' ');
    const medPath    = ageStats.map((d,i) => `${i===0?'M':'L'}${xScale(d.age).toFixed(1)},${yScale(d.median).toFixed(1)}`).join(' ');

    metricPaths += `<path d="${bandTop} ${bandBottom} Z" fill="${color}" fill-opacity="0.07" stroke="none"/>`;
    metricPaths += `<path d="${medPath}" fill="none" stroke="${color}" stroke-width="1.5" stroke-opacity="0.45" stroke-dasharray="4 2"/>`;

    // Player dot
    const playerRank = num(r[`${metricKey}_BarRank`]);
    const playerRaw  = num(r[col]);
    const rawDisplay = isPct ? Math.round(playerRaw*100)+'%' : playerRaw.toFixed(decimals);
    const px = xScale(playerAge), py = yScale(playerRank);

    playerDots.push(`<circle cx="${px.toFixed(1)}" cy="${py.toFixed(1)}" r="5" fill="${color}" stroke="#111" stroke-width="1.5"/>`);
    playerDots.push(`<text x="${(px+8).toFixed(1)}" y="${(py-7).toFixed(1)}" font-size="9" font-weight="700" fill="${color}">${playerRank.toFixed(0)}%</text>`);

    // Find label from POSITION_BARS
    const allMetrics = (POSITION_BARS[pos]||[]).flatMap(s => s.metrics);
    const metricDef = allMetrics.find(m => m.col === col);
    const label = metricDef?.label || col;
    legendItems.push(`<div class="age-curve-legend-item"><div class="age-curve-legend-dot" style="background:${color};"></div>${label} ‚Äî ${rawDisplay} ¬∑ ${playerRank.toFixed(0)}%ile</div>`);
  });

  el.innerHTML = `<div class="age-curve-wrap">
    <svg viewBox="0 0 ${W} ${H}" style="height:${H}px;">
      ${gridLines}${xLabels}${ageLine}${metricPaths}${playerDots.join('')}
    </svg>
    <div class="age-curve-legend">${legendItems.join('')}</div>
  </div>`;
}

// ‚îÄ‚îÄ PLAYER PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openProfile(idx) {
  const r = rawData[idx];
  if (!r) return;
  currentProfileKey = playerKey(r);

  // Capture the active filtered list for prev/next navigation
  const activePage = document.querySelector('.page.active')?.id;
  if (activePage === 'page-scout')    currentProfileList = scoutFiltered;
  else if (activePage === 'page-obv') currentProfileList = obvFiltered;
  else currentProfileList = currentProfileList.length ? currentProfileList : rawData;

  // Update nav buttons
  const listIdx = currentProfileList.indexOf(r);
  const prevBtn = document.getElementById('modal-prev-btn');
  const nextBtn = document.getElementById('modal-next-btn');
  const navPos  = document.getElementById('modal-nav-pos');
  if (prevBtn) prevBtn.disabled = listIdx <= 0;
  if (nextBtn) nextBtn.disabled = listIdx < 0 || listIdx >= currentProfileList.length - 1;
  if (navPos)  navPos.textContent = listIdx >= 0 ? `${listIdx + 1} / ${currentProfileList.length}` : '';

  // Reset to Stats tab
  showModalTab('stats');

  // Position colour for header and section titles
  const pos = r['Position'] || '';
  const POS_COLORS = { Defender:'var(--pos-defender)', Fullback:'var(--pos-fullback)', Midfielder:'var(--pos-midfielder)', Winger:'var(--pos-winger)', Striker:'var(--pos-striker)' };
  const posCol = POS_COLORS[pos] || 'var(--red)';
  // Apply position colour to modal header gradient
  const header = document.querySelector('.modal-header');
  if (header) header.style.background = `linear-gradient(135deg, #1a1a2e, ${posCol}88)`;
  // Apply to section title left-borders
  document.querySelectorAll('.modal-section-title').forEach(el => el.style.borderLeftColor = posCol);

  document.getElementById('modal-name').textContent = r['Player Name'] || '‚Äî';
  document.getElementById('modal-meta').textContent = [
    r['Position'], r['Team'], r['League'],
    `Age ${r['Age']}`, `${num(r['Usage']).toFixed(1)}% Usage`
  ].filter(Boolean).join(' ¬∑ ');

  // Key stats with rank-coloured top borders
  const obvR  = num(r['OBV Rank']);
  const passR = num(r['Pass OBV Rank']);
  const shotR = num(r['Shot OBV Rank']);
  const touchR = num(r['Touches per 90_BarRank']);
  function statBorder(rankVal) {
    const v = num(rankVal);
    return v >= 70 ? 'var(--green)' : v >= 45 ? 'var(--amber)' : v >= 25 ? '#E09450' : 'var(--crimson)';
  }
  const keyStats = [
    { l:'Age',           v: r['Age'] || '‚Äî',                      border: posCol },
    { l:'Usage %',       v: num(r['Usage']).toFixed(1) + '%',      border: posCol },
    { l:'Minutes',       v: (r['Minutes Played']||0).toLocaleString(), border: posCol },
    { l:'Appearances',   v: r['Appearances'] || '‚Äî',               border: posCol },
    { l:'Touches p90',   v: num(r['Touches per 90']).toFixed(1),   border: statBorder(touchR) },
    { l:'OBV Rank',      v: obvR.toFixed(1),                       border: statBorder(obvR) },
    { l:'Pass OBV Rank', v: passR.toFixed(1),                      border: statBorder(passR) },
    { l:'Shot OBV Rank', v: shotR.toFixed(1),                      border: statBorder(shotR) },
  ];
  document.getElementById('modal-stats').innerHTML = keyStats.map(s =>
    `<div class="profile-stat" style="border-top-color:${s.border}"><div class="profile-stat-val">${s.v}</div><div class="profile-stat-lbl">${s.l}</div></div>`
  ).join('');

  // Position bar charts
  renderPositionBars(r);

  // Age curve ‚Äî populate metric selector but don't draw until tab opened
  populateAgeCurveMetrics(r['Position']);

  // Archetype ranks ‚Äî filtered to position-relevant archetypes, sorted best firstlback, Midfielder, Winger, Striker)
  const relevantArchetypes = POSITION_ARCHETYPES[pos] || Object.keys(MODELS);
  const archetypeRanks = relevantArchetypes
    .map(m => ({ name: m, rank: num(r[`${m} Rank`]) }))
    .sort((a, b) => b.rank - a.rank);

  // Best archetype badge
  const bestArchetype = archetypeRanks[0];
  const badgeWrap = document.getElementById('modal-archetype-badge-wrap');
  if (badgeWrap) {
    if (bestArchetype) {
      badgeWrap.innerHTML = `
        <span class="archetype-badge arch-${pos}">
          <span class="archetype-badge-label">Best Archetype</span>
          ‚òÖ ${bestArchetype.name}
          <span style="opacity:0.6;font-weight:400;font-size:0.72rem;">${bestArchetype.rank.toFixed(0)}</span>
        </span>`;
    } else {
      badgeWrap.innerHTML = '';
    }
  }

  document.getElementById('modal-model-ranks').innerHTML = archetypeRanks.map(({ name, rank }) => `
    <div class="model-rank-row">
      <span class="model-rank-name">${name}</span>
      <div class="model-rank-bar-wrap"><div class="model-rank-bar" style="width:${rank}%"></div></div>
      <span class="rank-badge ${rankClass(rank)}" style="min-width:38px;font-size:0.82rem;">${rank.toFixed(0)}</span>
    </div>`).join('');

  // Similar players ‚Äî 8 results, respects U23 toggle
  renderSimilarPlayers(r);

  // Notes
  document.getElementById('modal-notes').value = notes[currentProfileKey] || '';
  document.getElementById('notes-saved-msg').classList.remove('show');
  updateShortlistBtn();
  updateWatchlistBtn();
  const rKey = reportKey(r['Player Name'], r['Team']);
  const rep = reports[rKey];
  const conclusionWrap = document.getElementById('modal-conclusion-wrap');
  const conclusionEl   = document.getElementById('modal-conclusion');
  if (rep?.conclusion?.trim()) {
    conclusionEl.textContent = `"${rep.conclusion}"`;
    conclusionWrap.style.display = 'block';
  } else {
    conclusionWrap.style.display = 'none';
  }

  document.getElementById('profile-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function findSimilarPlayers(target, n, u23Only) {
  const targetPos = target['Position'];
  const targetKey = playerKey(target);
  const posModels = POSITION_ARCHETYPES[targetPos] || Object.keys(MODELS);
  const modelKeys = posModels.map(m => `${m} Rank`);
  const targetVals = modelKeys.map(k => num(target[k]));

  return rawData
    .filter(r => {
      if (r['Position'] !== targetPos) return false;
      if (playerKey(r) === targetKey) return false;
      if (num(r['90s Played']) < minNineties) return false;
      if (u23Only && num(r['Age']) > 23) return false;
      return true;
    })
    .map(r => {
      const vals = modelKeys.map(k => num(r[k]));
      const dist = Math.sqrt(modelKeys.reduce((s, _, i) => s + (targetVals[i] - vals[i]) ** 2, 0));
      const maxDist = Math.sqrt(modelKeys.length) * 100;
      const score = Math.max(0, 100 - (dist / maxDist) * 100);
      return { row: r, score };
    })
    .sort((a, b) => b.score - a.score)
    .slice(0, n);
}

function renderSimilarPlayers(r) {
  if (!r) {
    const rr = rawData.find(row => playerKey(row) === currentProfileKey);
    if (!rr) return;
    r = rr;
  }
  const u23Only = document.getElementById('similar-u23-toggle')?.checked || false;
  const similar = findSimilarPlayers(r, 8, u23Only);
  document.getElementById('modal-similar').innerHTML = similar.length
    ? similar.map(s => `
      <div class="similar-row" onclick="closeProfileModal();setTimeout(()=>openProfile(${rawData.indexOf(s.row)}),50)">
        <div>
          <span class="similar-name">${s.row['Player Name']}</span>
          <span class="similar-meta"> ¬∑ ${s.row['Team']} ¬∑ ${s.row['League']} ¬∑ Age ${s.row['Age']}</span>
        </div>
        <span class="rank-badge ${rankClass(s.score)}" style="white-space:nowrap;">${s.score.toFixed(0)}% match</span>
      </div>`).join('')
    : `<div style="color:var(--muted);font-size:0.85rem;padding:0.5rem 0;">No similar players found${u23Only ? ' in U23' : ''}. Try removing the U23 filter.</div>`;
}

function refreshSimilarPlayers() {
  if (!currentProfileKey) return;
  const r = rawData.find(row => playerKey(row) === currentProfileKey);
  if (r) renderSimilarPlayers(r);
}

function closeProfileModal() {
  document.getElementById('profile-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function navigateProfile(dir) {
  if (!currentProfileKey || !currentProfileList.length) return;
  const cur = currentProfileList.findIndex(r => playerKey(r) === currentProfileKey);
  if (cur < 0) return;
  const next = cur + dir;
  if (next < 0 || next >= currentProfileList.length) return;
  openProfile(rawData.indexOf(currentProfileList[next]));
}

function handleModalClick(e) {
  if (e.target === document.getElementById('profile-modal')) closeProfileModal();
}

// ‚îÄ‚îÄ PRINT HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _pc(pct) { // bar colour for print
  return pct >= 70 ? '#3CB371' : pct >= 45 ? '#C8B840' : pct >= 25 ? '#E09450' : '#D06060';
}

function _printPlayerBlock(r, pageBreak) {
  var pos      = r['Position'] || '';
  var sections = POSITION_BARS[pos] || [];
  var archs    = (POSITION_ARCHETYPES[pos] || Object.keys(MODELS))
    .map(function(m){ return { name:m, rank:num(r[m+' Rank']) }; })
    .sort(function(a,b){ return b.rank-a.rank; });
  var best = archs[0];
  var pKey = playerKey(r);
  var rKey = reportKey(r['Player Name'], r['Team']);
  var rep  = reports[rKey];
  var scoutNotes = notes[pKey] || '';
  var posColors = { Defender:'#8B5CF6', Fullback:'#3B82F6', Midfielder:'#10B981', Winger:'#F59E0B', Striker:'#EF4444' };
  var accent = posColors[pos] || '#D71920';
  var printDate = new Date().toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' });

  // Bars
  var barsHtml = sections.map(function(sec) {
    var rows = sec.metrics.map(function(m) {
      var key = m.col + (m.invert ? '_inv' : '');
      var pct = Math.round(num(r[key+'_BarRank']));
      var raw = pbarRawDisplay(r, m);
      var col = _pc(pct);
      return '<div style="display:grid;grid-template-columns:160px 46px 1fr 34px;align-items:center;gap:5px;padding:2px 0">' +
        '<div style="font-size:8px;color:#bbb;text-align:right">' + m.label + '</div>' +
        '<div style="font-size:8px;color:#777;text-align:right">' + raw + '</div>' +
        '<div style="height:7px;background:#2a2a2a;border-radius:3px;overflow:hidden"><div style="width:' + pct + '%;height:100%;background:' + col + ';border-radius:3px"></div></div>' +
        '<div style="font-size:8px;font-weight:700;color:' + col + ';text-align:right">' + pct + '%</div>' +
      '</div>';
    }).join('');
    return '<div style="margin-bottom:9px"><div style="font-size:7px;letter-spacing:1.5px;color:#555;text-transform:uppercase;padding:3px 0 3px;border-bottom:1px solid #2a2a2a;margin-bottom:4px">' + sec.section + '</div>' + rows + '</div>';
  }).join('');

  // Archetype bars
  var archHtml = archs.map(function(d) {
    var col = _pc(d.rank);
    return '<div style="display:grid;grid-template-columns:1fr 80px 28px;align-items:center;gap:4px;padding:2px 0">' +
      '<div style="font-size:8px;color:#bbb">' + d.name + '</div>' +
      '<div style="height:5px;background:#2a2a2a;border-radius:2px;overflow:hidden"><div style="width:' + d.rank + '%;height:100%;background:' + col + ';border-radius:2px"></div></div>' +
      '<div style="font-size:8px;font-weight:700;color:' + col + ';text-align:right">' + d.rank.toFixed(0) + '</div>' +
    '</div>';
  }).join('');

  // Key stats
  var stats = [
    { l:'Position', v:pos||'\u2014' }, { l:'Age', v:r['Age']||'\u2014' },
    { l:'Club', v:r['Team']||'\u2014' }, { l:'League', v:r['League']||'\u2014' },
    { l:'90s', v:num(r['90s Played']).toFixed(1) }, { l:'Usage', v:num(r['Usage']).toFixed(0)+'%' }
  ];
  var statsHtml = stats.map(function(s) {
    return '<div style="background:#1c1c1c;border:1px solid #2e2e2e;border-top:2px solid ' + accent + ';border-radius:3px;padding:6px;text-align:center">' +
      '<div style="font-size:12px;font-weight:700;color:white;line-height:1">' + s.v + '</div>' +
      '<div style="font-size:7px;color:#555;text-transform:uppercase;letter-spacing:0.7px;margin-top:2px">' + s.l + '</div>' +
    '</div>';
  }).join('');

  var badgeHtml = best
    ? '<span style="font-size:8px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.2)">\u2605 ' + best.name + ' \u00b7 ' + best.rank.toFixed(0) + '</span>'
    : '';
  var stageHtml = (rep && rep.trackingStage)
    ? '<span style="font-size:8px;font-weight:700;padding:2px 7px;border-radius:10px;background:rgba(215,25,32,0.15);color:#F05060;border:1px solid rgba(215,25,32,0.3)">' + rep.trackingStage + '</span>'
    : '';
  var conclHtml = (rep && rep.conclusion && rep.conclusion.trim())
    ? '<div style="margin-top:10px;padding:8px 12px;background:rgba(232,160,32,0.07);border:1px solid rgba(232,160,32,0.25);border-radius:4px"><div style="font-size:7px;letter-spacing:1.5px;color:#666;text-transform:uppercase;margin-bottom:4px">Scout Conclusion</div><div style="font-size:9px;color:#E8A020;font-style:italic;line-height:1.5">\u201c' + rep.conclusion + '\u201d</div></div>'
    : '';
  var notesHtml = scoutNotes.trim()
    ? '<div style="margin-top:8px;padding:8px 12px;background:#1c1c1c;border:1px solid #2e2e2e;border-radius:4px"><div style="font-size:7px;letter-spacing:1.5px;color:#666;text-transform:uppercase;margin-bottom:4px">Scout Notes</div><div style="font-size:9px;color:#ccc;line-height:1.5;white-space:pre-wrap">' + scoutNotes + '</div></div>'
    : '';

  var pbStyle = pageBreak ? 'page-break-after:always;' : '';
  return '<div style="' + pbStyle + 'padding:14px 0 18px">' +
    '<div style="background:linear-gradient(135deg,#9E1117,#D71920);border-radius:5px;padding:14px 18px;margin-bottom:11px;display:flex;align-items:flex-start;justify-content:space-between">' +
      '<div><div style="font-size:20px;font-weight:800;color:white;line-height:1.1">' + r['Player Name'] + '</div>' +
      '<div style="font-size:9px;color:rgba(255,255,255,0.7);margin-top:3px">' + [r['Team'],r['League']].filter(Boolean).join(' \u00b7 ') + '</div>' +
      '<div style="margin-top:6px;display:flex;gap:6px;align-items:center">' + badgeHtml + ' ' + stageHtml + '</div></div>' +
      '<div style="text-align:right;font-size:7.5px;color:rgba(255,255,255,0.4)">Saints Scout<br>Southampton FC<br>' + printDate + '</div>' +
    '</div>' +
    '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:11px">' + statsHtml + '</div>' +
    '<div style="display:grid;grid-template-columns:1fr 195px;gap:10px;margin-bottom:9px">' +
      '<div style="background:#1c1c1c;border:1px solid #2e2e2e;border-radius:4px;padding:11px">' +
        '<div style="font-size:7px;letter-spacing:1.5px;color:#555;text-transform:uppercase;margin-bottom:7px;padding-bottom:5px;border-bottom:1px solid #2a2a2a">Player Profile \u00b7 vs ' + pos + 's in ' + (r['League']||'same league') + '</div>' +
        (barsHtml || '<div style="color:#444;font-size:9px">No profile data for this position.</div>') +
      '</div>' +
      '<div style="background:#1c1c1c;border:1px solid #2e2e2e;border-radius:4px;padding:11px">' +
        '<div style="font-size:7px;letter-spacing:1.5px;color:#555;text-transform:uppercase;margin-bottom:7px;padding-bottom:5px;border-bottom:1px solid #2a2a2a">Archetype Ranks</div>' +
        archHtml +
      '</div>' +
    '</div>' +
    conclHtml + notesHtml +
    '<div style="margin-top:10px;padding-top:7px;border-top:1px solid #1e1e1e;display:flex;justify-content:space-between">' +
      '<div style="font-size:7px;color:#333">Saints Scout \u00b7 Southampton FC Player Intelligence</div>' +
      '<div style="font-size:7px;color:#333">Data: Statsbomb \u00b7 ' + printDate + '</div>' +
    '</div>' +
  '</div>';
}

function buildPrintDoc(players, coverHtml) {
  var body = (coverHtml || '') + players.map(function(r, i) {
    return _printPlayerBlock(r, i < players.length - 1);
  }).join('');
  var T = ['sty','le','scri','pt','hea','d','bo','dy','htm','l'];
  var style=T[0]+T[1], script=T[2]+T[3], head=T[4]+T[5], body2=T[6]+T[7], html=T[8]+T[9];
  return '<!DOCTYPE html><'+html+'><'+head+'><meta charset="UTF-8">' +
    '<'+style+'>@page{size:A4;margin:12mm 13mm}*{box-sizing:border-box;margin:0;padding:0}' +
    'body{font-family:-apple-system,"Helvetica Neue",Arial,sans-serif;background:#111;color:#f0f0f0;-webkit-print-color-adjust:exact;print-color-adjust:exact}</'+style+'>' +
    '</'+head+'><'+body2+'><div style="max-width:720px;margin:0 auto">' + body +
    '</div><'+script+'>window.onload=function(){window.print()}</'+script+'></'+body2+'></'+html+'>';
}


function exportProfilePNG() {
  if (!currentProfileKey) return;
  const r = rawData.find(row => playerKey(row) === currentProfileKey);
  if (!r) return;

  const overlay = document.getElementById('profile-modal');
  const modal   = document.getElementById('profile-modal-inner');
  if (!modal) return;

  showKbdToast('üì∏ Capturing‚Ä¶');

  // Switch to Stats tab so we get a clean top
  showModalTab('stats');

  // Save original overlay styles
  const origOverlayBg      = overlay.style.background;
  const origOverlayPad     = overlay.style.padding;
  const origOverlayAlign   = overlay.style.alignItems;
  const origOverlayDisplay = overlay.style.display;
  const origModalAnim      = modal.style.animation;
  const origModalShadow    = modal.style.boxShadow;
  const origModalScroll    = modal.style.overflow;

  // Restyle overlay to solid background, no dark tint
  overlay.style.background  = '#1C1C1C';
  overlay.style.padding     = '0';
  overlay.style.alignItems  = 'flex-start';
  overlay.style.display     = 'flex';

  // Remove animation and scroll cap from modal
  modal.style.animation  = 'none';
  modal.style.boxShadow  = 'none';
  modal.style.overflow   = 'visible';
  modal.style.maxHeight  = 'none';

  // Hide close button and sticky footer
  const closeBtn = modal.querySelector('.modal-close');
  const footer   = modal.querySelector('.modal-sticky-footer');
  if (closeBtn) closeBtn.style.visibility = 'hidden';
  if (footer)   footer.style.display      = 'none';

  // Scroll overlay to top
  overlay.scrollTop = 0;

  // Small delay to let layout settle
  setTimeout(() => {
    html2canvas(modal, {
      backgroundColor: '#1C1C1C',
      scale: 2,
      useCORS: true,
      logging: false,
      width:  modal.offsetWidth,
      height: modal.scrollHeight,
      windowWidth:  modal.offsetWidth,
      windowHeight: modal.scrollHeight,
      x: 0,
      y: 0,
    }).then(canvas => {
      // Restore everything
      overlay.style.background  = origOverlayBg;
      overlay.style.padding     = origOverlayPad;
      overlay.style.alignItems  = origOverlayAlign;
      overlay.style.display     = origOverlayDisplay;
      modal.style.animation     = origModalAnim;
      modal.style.boxShadow     = origModalShadow;
      modal.style.overflow      = origModalScroll;
      modal.style.maxHeight     = '';
      if (closeBtn) closeBtn.style.visibility = '';
      if (footer)   footer.style.display      = '';

      const safeName = (r['Player Name'] || 'player').replace(/[^a-z0-9]/gi, '_').toLowerCase();
      const a = document.createElement('a');
      a.download = 'saints_scout_' + safeName + '.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
      showKbdToast('‚úì PNG saved');
    }).catch(() => {
      overlay.style.background  = origOverlayBg;
      overlay.style.padding     = origOverlayPad;
      overlay.style.alignItems  = origOverlayAlign;
      overlay.style.display     = origOverlayDisplay;
      modal.style.animation     = origModalAnim;
      modal.style.boxShadow     = origModalShadow;
      modal.style.overflow      = origModalScroll;
      modal.style.maxHeight     = '';
      if (closeBtn) closeBtn.style.visibility = '';
      if (footer)   footer.style.display      = '';
      showKbdToast('‚ö† Export failed');
    });
  }, 80);
}


function printProfile() {
  if (!currentProfileKey) return;
  const r = rawData.find(row => playerKey(row) === currentProfileKey);
  if (!r) return;
  const win = window.open('', '_blank');
  if (!win) return;
  win.document.write(buildPrintDoc([r]));
  win.document.close();
}

// ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveNote() {
  if (!currentProfileKey) return;
  notes[currentProfileKey] = document.getElementById('modal-notes').value;
  persistNotes();
  const msg = document.getElementById('notes-saved-msg');
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 2000);
  if (scoutFiltered.length) renderScoutTable();
  if (obvFiltered.length) renderOBVTable();
}

// ‚îÄ‚îÄ SHORTLIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let slPosFilter = 'All';
let slViewTab   = 'shortlist';

function setSlViewTab(tab) {
  slViewTab = tab;
  document.getElementById('slvtab-shortlist').classList.toggle('active', tab === 'shortlist');
  document.getElementById('slvtab-watchlist').classList.toggle('active', tab === 'watchlist');
  document.getElementById('sl-panel-shortlist').style.display = tab === 'shortlist' ? '' : 'none';
  document.getElementById('sl-panel-watchlist').style.display = tab === 'watchlist' ? '' : 'none';
}

function toggleShortlist() {
  if (!currentProfileKey) return;
  const idx = shortlist.findIndex(s => s.key === currentProfileKey);
  if (idx === -1) {
    const r = rawData.find(row => playerKey(row) === currentProfileKey);
    if (r) shortlist.push({ key: currentProfileKey, name: r['Player Name'], team: r['Team'], league: r['League'], position: r['Position'], age: r['Age'] });
  } else {
    shortlist.splice(idx, 1);
  }
  persistShortlist();
  updateShortlistBtn();
  updateShortlistBadge();
}

function updateShortlistBtn() {
  const btn = document.getElementById('modal-shortlist-btn');
  if (!btn || !currentProfileKey) return;
  const inList = shortlist.some(s => s.key === currentProfileKey);
  btn.textContent = inList ? '‚≠ê Remove from Shortlist' : '‚≠ê Add to Shortlist';
  btn.classList.toggle('added', inList);
}

function updateShortlistBadge() {
  const badge = document.getElementById('shortlist-badge');
  badge.textContent = shortlist.length;
  badge.classList.toggle('visible', shortlist.length > 0);
}

function setSlPosFilter(pos) {
  slPosFilter = pos;
  document.querySelectorAll('.sl-pos-tab').forEach(t => t.classList.toggle('active', t.dataset.pos === pos));
  renderShortlistRows();
}

function renderShortlist() {
  const empty   = document.getElementById('shortlist-no-data');
  const content = document.getElementById('shortlist-content');
  if (shortlist.length === 0 && watchlist.length === 0) {
    empty.style.display = 'block'; content.style.display = 'none'; return;
  }
  empty.style.display = 'none'; content.style.display = 'block';

  // Update tab counts
  const slCount = document.getElementById('slvtab-sl-count');
  const wlCount = document.getElementById('slvtab-wl-count');
  if (slCount) slCount.textContent = shortlist.length ? `(${shortlist.length})` : '';
  if (wlCount) wlCount.textContent = watchlist.length ? `(${watchlist.length})` : '';

  // Build position filter tabs with counts
  const positions = ['All', ...['Defender','Fullback','Midfielder','Winger','Striker'].filter(p => shortlist.some(s => s.position === p))];
  const tabsEl = document.getElementById('sl-pos-tabs');
  tabsEl.innerHTML = positions.map(p => {
    const count = p === 'All' ? shortlist.length : shortlist.filter(s => s.position === p).length;
    return `<button class="sl-pos-tab${slPosFilter === p ? ' active' : ''}" data-pos="${p}" onclick="setSlPosFilter('${p}')">${p} <span style="font-size:0.7rem;opacity:0.65">(${count})</span></button>`;
  }).join('');

  renderShortlistRows();
  renderWatchlist();
}

function renderShortlistRows() {
  const list = document.getElementById('shortlist-list');
  const filtered = slPosFilter === 'All' ? shortlist : shortlist.filter(s => s.position === slPosFilter);

  if (filtered.length === 0) {
    list.innerHTML = `<div style="color:var(--muted);font-size:0.84rem;padding:0.5rem 0;">No ${slPosFilter === 'All' ? '' : slPosFilter + ' '}players on shortlist.</div>`;
    return;
  }

  // Group by position when showing All
  if (slPosFilter === 'All') {
    const POS_ORDER = ['Defender','Fullback','Midfielder','Winger','Striker'];
    const groups = {};
    filtered.forEach(s => { if (!groups[s.position]) groups[s.position] = []; groups[s.position].push(s); });
    list.innerHTML = POS_ORDER.filter(p => groups[p]).map(p =>
      `<div class="sl-section-title">${p}s</div>` +
      groups[p].map(s => shortlistRowHtml(s)).join('')
    ).join('');
  } else {
    list.innerHTML = filtered.map(s => shortlistRowHtml(s)).join('');
  }
}

function shortlistRowHtml(s) {
  const i = shortlist.indexOf(s);
  const rKey = reportKey(s.name, s.team);
  const inPipeline = !!reports[rKey];
  const pipelineBtn = inPipeline
    ? `<button class="btn btn-sm" style="font-size:0.62rem;padding:0.18rem 0.5rem;background:rgba(60,180,113,0.15);border:1px solid var(--green);color:var(--green);border-radius:3px;cursor:pointer;white-space:nowrap;" onclick="event.stopPropagation();openPipelineFromShortlist('${s.key.replace(/'/g,"\\'")}')" title="Open in Pipeline">‚úì In Pipeline</button>`
    : `<button class="btn btn-sm btn-outline" style="font-size:0.62rem;padding:0.18rem 0.5rem;border-radius:3px;cursor:pointer;white-space:nowrap;" onclick="event.stopPropagation();addToPipelineFromShortlist('${s.key.replace(/'/g,"\\'")}')" title="Add to Pipeline at Track stage">+ Pipeline</button>`;

  // Top archetype badge ‚Äî look up raw data
  let archBadge = '';
  const rawRow = rawData.find(r => playerKey(r) === s.key);
  if (rawRow) {
    const pos   = rawRow['Position'];
    const archs = POSITION_ARCHETYPES[pos] || Object.keys(MODELS);
    const best  = archs
      .map(a => ({ name: a, rank: Math.round(num(rawRow[`${a} Rank`])) }))
      .sort((a, b) => b.rank - a.rank)[0];
    if (best) {
      const col = best.rank >= 70 ? 'var(--green)' : best.rank >= 45 ? 'var(--amber)' : best.rank >= 25 ? '#E09450' : 'var(--crimson)';
      archBadge = `<div style="font-size:0.65rem;color:${col};margin-top:0.15rem;font-weight:500;">${best.name} <span style="font-weight:700;">${best.rank}</span></div>`;
    }
  }

  return `<div class="shortlist-row" onclick="openProfileByKey('${s.key}')">
    <div class="shortlist-row-info">
      <div class="shortlist-row-name">${s.name}${notes[s.key] ? ' üìù' : ''}</div>
      <div class="shortlist-row-meta">${[s.position, s.team, s.league, `Age ${s.age}`].filter(Boolean).join(' ¬∑ ')}</div>
      ${archBadge}
    </div>
    <div style="display:flex;align-items:center;gap:0.4rem;flex-shrink:0;">
      ${pipelineBtn}
      <button class="shortlist-remove" onclick="event.stopPropagation();removeFromShortlist(${i})" title="Remove">‚úï</button>
    </div>
  </div>`;
}

function addToPipelineFromShortlist(pKey) {
  const r = rawData.find(row => playerKey(row) === pKey);
  if (!r) return;
  const key = reportKey(r['Player Name'], r['Team']);
  if (!reports[key]) {
    reports[key] = {
      name: r['Player Name'], team: r['Team']||'', league: r['League']||'',
      position: r['Position']||'', age: r['Age']||'',
      conclusion: '', sections: {}, trackingStage: 'Track',
      stageHistory: { 'Track': Date.now() },
      createdAt: Date.now(), updatedAt: Date.now()
    };
    persistReports();
    updateReportsBadge();
  }
  renderShortlist(); // refresh button states
  showKbdToast('Added to Pipeline ‚Üí Track');
}

function openPipelineFromShortlist(pKey) {
  const r = rawData.find(row => playerKey(row) === pKey);
  if (!r) return;
  const key = reportKey(r['Player Name'], r['Team']);
  if (!reports[key]) return;
  showPage('pipeline');
  setTimeout(() => {
    const card = document.getElementById(`pipe-card-${CSS.escape(key)}`);
    if (card) { card.scrollIntoView({ behavior:'smooth', block:'center' }); card.style.outline = '2px solid var(--green)'; setTimeout(() => card.style.outline = '', 1500); }
  }, 200);
}

function removeFromShortlist(idx) {
  shortlist.splice(idx, 1);
  persistShortlist();
  updateShortlistBadge();
  renderShortlist();
}

// ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleWatchlist() {
  if (!currentProfileKey) return;
  const idx = watchlist.findIndex(s => s.key === currentProfileKey);
  if (idx === -1) {
    const r = rawData.find(row => playerKey(row) === currentProfileKey);
    if (r) watchlist.push({ key: currentProfileKey, name: r['Player Name'], team: r['Team'], league: r['League'], position: r['Position'], age: r['Age'] });
  } else {
    watchlist.splice(idx, 1);
  }
  persistWatchlist();
  updateWatchlistBtn();
}

function updateWatchlistBtn() {
  const btn = document.getElementById('modal-watchlist-btn');
  if (!btn || !currentProfileKey) return;
  const inList = watchlist.some(s => s.key === currentProfileKey);
  btn.textContent = inList ? 'üëÅ Remove from Watchlist' : 'üëÅ Watchlist';
  btn.classList.toggle('added', inList);
}

function renderWatchlist() {
  const list = document.getElementById('watchlist-list');
  if (!list) return;
  if (watchlist.length === 0) {
    list.innerHTML = '<div style="color:var(--muted);font-size:0.84rem;padding:1rem 0;">No players on watchlist yet. Open a player profile and tap üëÅ Watchlist.</div>';
    return;
  }
  list.innerHTML = watchlist.map((s, i) => {
    // Top archetype badge ‚Äî look up raw data
    let archBadge = '';
    const rawRow = rawData.find(r => playerKey(r) === s.key);
    if (rawRow) {
      const pos   = rawRow['Position'];
      const archs = POSITION_ARCHETYPES[pos] || Object.keys(MODELS);
      const best  = archs
        .map(a => ({ name: a, rank: Math.round(num(rawRow[`${a} Rank`])) }))
        .sort((a, b) => b.rank - a.rank)[0];
      if (best) {
        const col = best.rank >= 70 ? 'var(--green)' : best.rank >= 45 ? 'var(--amber)' : best.rank >= 25 ? '#E09450' : 'var(--crimson)';
        archBadge = `<div style="font-size:0.65rem;color:${col};margin-top:0.15rem;font-weight:500;">${best.name} <span style="font-weight:700;">${best.rank}</span></div>`;
      }
    }
    return `
    <div class="shortlist-row watchlist-row" onclick="openProfileByKey('${s.key}')">
      <div class="shortlist-row-info">
        <div class="shortlist-row-name" style="color:var(--amber)">${s.name}</div>
        <div class="shortlist-row-meta">${[s.position, s.team, s.league, `Age ${s.age}`].filter(Boolean).join(' ¬∑ ')}</div>
        ${archBadge}
      </div>
      <div style="display:flex;gap:0.4rem;align-items:center;flex-shrink:0">
        <button class="btn btn-sm btn-outline" style="font-size:0.65rem;padding:0.2rem 0.55rem;letter-spacing:0.5px;border-color:var(--green);color:var(--green);"
          onclick="event.stopPropagation();promoteToShortlist(${i})" title="Move to Shortlist">‚≠ê Promote</button>
        <button class="shortlist-remove" onclick="event.stopPropagation();removeFromWatchlist(${i})" title="Remove">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

function removeFromWatchlist(idx) {
  watchlist.splice(idx, 1);
  persistWatchlist();
  renderWatchlist();
  const slCount = document.getElementById('slvtab-wl-count');
  if (slCount) slCount.textContent = watchlist.length ? `(${watchlist.length})` : '';
  if (shortlist.length === 0 && watchlist.length === 0) {
    document.getElementById('shortlist-no-data').style.display = 'block';
    document.getElementById('shortlist-content').style.display = 'none';
  }
}

function promoteToShortlist(wlIdx) {
  const s = watchlist[wlIdx];
  if (!s) return;
  // Add to shortlist if not already there
  if (!shortlist.some(sl => sl.key === s.key)) {
    shortlist.push(s);
    persistShortlist();
    updateShortlistBadge();
  }
  // Remove from watchlist
  watchlist.splice(wlIdx, 1);
  persistWatchlist();
  renderShortlist(); // re-renders both shortlist and watchlist
  showKbdToast('‚≠ê Promoted to Shortlist');
}

function openProfileByKey(key) {
  const idx = rawData.findIndex(r => playerKey(r) === key);
  if (idx !== -1) openProfile(idx);
}

function exportShortlist() {
  if (!shortlist.length) return;

  // Build per-player rows; determine the union of top-3 archetypes across all positions
  const rows = shortlist.map(s => {
    const r = rawData.find(row => playerKey(row) === s.key);
    return { s, r };
  }).filter(({ r }) => r);

  // For each row get the top 3 position-relevant archetype ranks
  const getTop3Archetypes = (r) => {
    const pos = r['Position'];
    const archs = POSITION_ARCHETYPES[pos] || Object.keys(MODELS);
    return archs
      .map(a => ({ name: a, rank: num(r[`${a} Rank`]) }))
      .sort((a, b) => b.rank - a.rank)
      .slice(0, 3);
  };

  // Fixed base columns
  const base = ['Player Name','Team','League','Position','Age','90s Played','OBV Rank','Scout Notes','Recommendation'];

  // Build CSV
  const lines = [];

  rows.forEach(({ s, r }) => {
    const top3 = getTop3Archetypes(r);
    const rowCols = [
      ...base,
      ...top3.map(a => a.name + ' Rank'),
    ];
    // Header row per position group? No ‚Äî just output player rows with inline archetype labels
    const vals = rowCols.map(c => {
      if (c === 'Scout Notes') {
        const n = notes[s.key] || ''; return `"${n.replace(/"/g,'""')}"`;
      }
      if (c === 'Recommendation') {
        const rKey = reportKey(r['Player Name'], r['Team']);
        const rep = reports[rKey];
        return rep?.recommendation || '';
      }
      if (c.endsWith(' Rank') && !['OBV Rank','Pass OBV Rank','Shot OBV Rank','Dribble & Carry OBV Rank'].includes(c)) {
        return Math.round(num(r[c]));
      }
      const v = r[c]; return (typeof v === 'string' && v.includes(',')) ? `"${v}"` : (v ?? '');
    });
    lines.push(rowCols.join(',') + '\n' + vals.join(','));
  });

  // Build output: group by position, with a header row per block
  const POS_ORDER = ['Defender','Fullback','Midfielder','Winger','Striker'];
  const grouped = {};
  rows.forEach(({ s, r }) => {
    const pos = r['Position'] || 'Unknown';
    if (!grouped[pos]) grouped[pos] = [];
    grouped[pos].push({ s, r });
  });

  const csvLines = [];
  POS_ORDER.filter(p => grouped[p]).forEach(pos => {
    csvLines.push(`# ${pos.toUpperCase()}S`);
    const header = ['Player Name','Team','League','Age','90s Played','OBV Rank',
      'Archetype 1','Rank 1','Archetype 2','Rank 2','Archetype 3','Rank 3',
      'Recommendation','Scout Notes'];
    csvLines.push(header.join(','));
    grouped[pos].forEach(({ s, r }) => {
      const top3 = getTop3Archetypes(r);
      const rKey = reportKey(r['Player Name'], r['Team']);
      const rep  = reports[rKey];
      const rec  = rep?.recommendation || '';
      const note = notes[s.key] || '';
      const row  = [
        r['Player Name'], r['Team'], r['League'], r['Age'],
        num(r['90s Played']).toFixed(1), Math.round(num(r['OBV Rank'])),
        top3[0]?.name||'', Math.round(top3[0]?.rank||0),
        top3[1]?.name||'', Math.round(top3[1]?.rank||0),
        top3[2]?.name||'', Math.round(top3[2]?.rank||0),
        rec, `"${note.replace(/"/g,'""')}"`
      ];
      csvLines.push(row.join(','));
    });
    csvLines.push('');
  });

  const blob = new Blob([csvLines.join('\n')], { type:'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `saints_scout_shortlist_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

function printSquadReport() {
  if (!shortlist.length) { alert('No players on your shortlist.'); return; }
  const POS_ORDER = { Defender:0, Fullback:1, Midfielder:2, Winger:3, Striker:4 };
  const players = shortlist
    .map(s => rawData.find(row => playerKey(row) === s.key))
    .filter(Boolean)
    .sort((a, b) => (POS_ORDER[a['Position']] ?? 9) - (POS_ORDER[b['Position']] ?? 9));

  const printDate = new Date().toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' });

  // Build TOC
  const groups = {};
  players.forEach(r => { const p = r['Position']||'Unknown'; if (!groups[p]) groups[p]=[]; groups[p].push(r['Player Name']); });
  const tocHtml = Object.entries(groups).map(([pos, names]) =>
    '<div style="margin-bottom:14px">' +
    '<div style="font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#888;margin-bottom:6px">' + pos + '</div>' +
    names.map(n => '<div style="font-size:11px;color:#ddd;padding:3px 0;border-bottom:1px solid #1e1e1e">' + n + '</div>').join('') +
    '</div>'
  ).join('');

  const coverHtml =
    '<div style="page-break-after:always;min-height:90vh;display:flex;flex-direction:column;justify-content:center;padding:40px 0">' +
      '<div style="background:linear-gradient(135deg,#9E1117,#D71920);border-radius:8px;padding:40px 36px;margin-bottom:28px">' +
        '<div style="font-size:32px;font-weight:900;color:white;letter-spacing:1px;margin-bottom:6px">Squad Scout Report</div>' +
        '<div style="font-size:13px;color:rgba(255,255,255,0.7)">Southampton FC \u00b7 Player Intelligence</div>' +
        '<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px">' + printDate + '</div>' +
      '</div>' +
      '<div style="background:#1c1c1c;border:1px solid #2e2e2e;border-radius:6px;padding:24px 28px">' +
        '<div style="font-size:9px;letter-spacing:2px;color:#555;text-transform:uppercase;margin-bottom:16px">Shortlisted Players (' + players.length + ')</div>' +
        tocHtml +
      '</div>' +
    '</div>';

  const win = window.open('', '_blank');
  if (!win) return;
  win.document.write(buildPrintDoc(players, coverHtml));
  win.document.close();
}

// ‚îÄ‚îÄ NOTES PERSISTENCE (file-based backup) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportNotesFile() {
  const data = { notes, shortlist, reports };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `saints_scout_notes_${Date.now()}.json`; a.click();
}

function loadNotesFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.notes)     { notes = data.notes; persistNotes(); }
      if (data.shortlist) { shortlist = data.shortlist; persistShortlist(); }
      if (data.reports)   { reports = data.reports; persistReports(); }
      updateShortlistBadge();
      updateReportsBadge();
      if (scoutFiltered.length) renderScoutTable();
      if (obvFiltered.length) renderOBVTable();
      alert(`‚úì Loaded ${Object.keys(notes).length} notes and ${shortlist.length} shortlisted players.`);
    } catch(err) { alert('Could not read notes file. Please use a valid Saints Scout notes export.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV(which) {
  const data = which === 'scout' ? scoutFiltered : obvFiltered;
  if (!data.length) return;
  const model = document.getElementById('f-archetype')?.value || '';
  const cols = which === 'scout'
    ? ['Player Name','Team','League','Competition','Position','Age','Usage','Touches per 90',`${model} Rank`,'Scout Notes']
    : ['Player Name','Team','League','Position','Age','Usage','Touches per 90','OBV Rank','Pass OBV Rank','Dribble & Carry OBV Rank','Shot OBV Rank','Scout Notes'];
  const lines = [cols.join(',')];
  data.forEach(r => {
    lines.push(cols.map(c => {
      if (c === 'Scout Notes') { const n = notes[playerKey(r)] || ''; return `"${n.replace(/"/g,'""')}"` ; }
      const v = r[c];
      return (typeof v === 'string' && v.includes(',')) ? `"${v}"` : (v ?? '');
    }).join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = `saints_scout_${which}_${Date.now()}.csv`; a.click();
}

// ‚îÄ‚îÄ SCATTER CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let scHighlighted = []; // array of player names to highlight

// Skip non-metric columns
const SCATTER_SKIP_COLS = new Set([
  'Player Name','Team','Competition','Competition Id','Primary Position','Position',
  'Season','League','Nation','Available Minutes'
]);

function initScatter() {
  document.getElementById('scatter-no-data').style.display = 'none';
  document.getElementById('scatter-content').style.display = 'block';

  const sample = rawData[0] || {};
  const numericCols = Object.keys(sample).filter(col => {
    if (SCATTER_SKIP_COLS.has(col)) return false;
    const v = sample[col];
    return typeof v === 'number' || (typeof v === 'string' && v !== '' && !isNaN(+v));
  }).sort((a, b) => a.localeCompare(b));

  const fill = (id, includeBlank) => {
    const sel = document.getElementById(id); sel.innerHTML = '';
    if (includeBlank) { const o = document.createElement('option'); o.value = ''; o.textContent = 'Fixed size'; sel.appendChild(o); }
    numericCols.forEach(c => { const o = document.createElement('option'); o.value = o.textContent = c; sel.appendChild(o); });
  };
  fill('sc-x', false); fill('sc-y', false); fill('sc-size', true);

  const xDef = numericCols.includes('Dribble & Carry OBV Rank') ? 'Dribble & Carry OBV Rank' : numericCols[0];
  const yDef = numericCols.includes('OBV Rank') ? 'OBV Rank' : numericCols[1] || numericCols[0];
  document.getElementById('sc-x').value = xDef;
  document.getElementById('sc-y').value = yDef;
  populatePresetSelect();
}

function getScatterData() {
  const pos    = document.getElementById('sc-position').value;
  const ageMin = +document.getElementById('sc-age-min').value || 0;
  const ageMax = +document.getElementById('sc-age-max').value || 999;
  const usage  = +document.getElementById('sc-usage').value  || 0;
  const leagues = getCheckedLeagues('sc-league-list');
  const xCol = document.getElementById('sc-x').value;
  const yCol = document.getElementById('sc-y').value;
  return rawData.filter(r => {
    if (pos && r['Position'] !== pos) return false;
    if (leagues.length && !leagues.includes(r['League'])) return false;
    if (num(r['Age']) < ageMin || num(r['Age']) > ageMax) return false;
    if (num(r['Usage']) < usage) return false;
    if (r[xCol] === null || r[xCol] === undefined || r[yCol] === null || r[yCol] === undefined) return false;
    return true;
  });
}

function drawScatter() {
  const xCol    = document.getElementById('sc-x').value;
  const yCol    = document.getElementById('sc-y').value;
  const sizeCol = document.getElementById('sc-size').value;
  const title   = document.getElementById('sc-title').value || `${yCol} vs ${xCol}`;
  const qTL     = document.getElementById('sc-q-tl').value;
  const qTR     = document.getElementById('sc-q-tr').value;
  const qBL     = document.getElementById('sc-q-bl').value;
  const qBR     = document.getElementById('sc-q-br').value;
  const data    = getScatterData();
  if (!data.length) return;

  const svgEl    = document.getElementById('scatter-svg');
  const container = svgEl.parentElement;
  const W = container.clientWidth - 32;
  const H = Math.max(520, Math.round(W * 0.72));
  const margin = { top: 55, right: sizeCol ? 110 : 30, bottom: 65, left: 65 };
  const innerW = W - margin.left - margin.right;
  const innerH = H - margin.top - margin.bottom;

  d3.select('#scatter-svg').selectAll('*').remove();
  d3.select('#scatter-svg').attr('viewBox', `0 0 ${W} ${H}`).attr('height', H);

  const svg = d3.select('#scatter-svg').append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  const xVals = data.map(d => num(d[xCol]));
  const yVals = data.map(d => num(d[yCol]));
  const xPad  = (d3.max(xVals) - d3.min(xVals)) * 0.05 || 1;
  const yPad  = (d3.max(yVals) - d3.min(yVals)) * 0.05 || 1;

  const xScale = d3.scaleLinear().domain([d3.min(xVals) - xPad, d3.max(xVals) + xPad]).range([0, innerW]);
  const yScale = d3.scaleLinear().domain([d3.min(yVals) - yPad, d3.max(yVals) + yPad]).range([innerH, 0]);
  const xMed   = d3.median(xVals);
  const yMed   = d3.median(yVals);

  // Size scale
  const MIN_R = 4, MAX_R = 16;
  let rScale = () => 5;
  if (sizeCol) {
    const sVals = data.map(d => num(d[sizeCol]));
    const sMin = d3.min(sVals), sMax = d3.max(sVals);
    rScale = d => sMin === sMax ? 8 : MIN_R + ((num(d[sizeCol]) - sMin) / (sMax - sMin)) * (MAX_R - MIN_R);
  }

  // Grid lines
  svg.append('g').attr('class','scatter-grid').call(d3.axisLeft(yScale).ticks(6).tickSize(-innerW).tickFormat('')).select('.domain').remove();
  svg.append('g').attr('class','scatter-grid').attr('transform',`translate(0,${innerH})`).call(d3.axisBottom(xScale).ticks(6).tickSize(-innerH).tickFormat('')).select('.domain').remove();
  svg.selectAll('.scatter-grid line').style('stroke','rgba(255,255,255,0.04)');

  // Axes
  svg.append('g').attr('class','scatter-axis').attr('transform',`translate(0,${innerH})`).call(d3.axisBottom(xScale).ticks(6)).selectAll('text').style('fill','#888').style('font-size','11px');
  svg.append('g').attr('class','scatter-axis').call(d3.axisLeft(yScale).ticks(6)).selectAll('text').style('fill','#888').style('font-size','11px');
  svg.selectAll('.scatter-axis path, .scatter-axis line').style('stroke','#2E2E2E');

  // Axis labels
  svg.append('text').attr('x', innerW/2).attr('y', innerH + 48).attr('text-anchor','middle').style('fill','#888').style('font-size','12px').text(xCol);
  svg.append('text').attr('transform','rotate(-90)').attr('x',-innerH/2).attr('y',-50).attr('text-anchor','middle').style('fill','#888').style('font-size','12px').text(yCol);

  // Quadrant lines
  const qxPos = xScale(xMed), qyPos = yScale(yMed);
  svg.append('line').attr('x1',qxPos).attr('x2',qxPos).attr('y1',0).attr('y2',innerH).attr('stroke','rgba(255,255,255,0.18)').attr('stroke-width',1).attr('stroke-dasharray','5,4');
  svg.append('line').attr('x1',0).attr('x2',innerW).attr('y1',qyPos).attr('y2',qyPos).attr('stroke','rgba(255,255,255,0.18)').attr('stroke-width',1).attr('stroke-dasharray','5,4');

  // Quadrant labels
  const qStyle = { fill:'#D71920','font-family':'DM Sans,sans-serif','font-size':'12px','font-weight':'500',opacity:'0.72','text-anchor':'middle' };
  const applyQ = (el, s) => Object.entries(s).forEach(([k,v]) => el.style(k,v));
  if (qTL) { const el = svg.append('text').attr('x',qxPos/2).attr('y',qyPos/2-10).text(qTL); applyQ(el,qStyle); wrapText(el,qxPos-20); }
  if (qTR) { const el = svg.append('text').attr('x',qxPos+(innerW-qxPos)/2).attr('y',qyPos/2-10).text(qTR); applyQ(el,qStyle); wrapText(el,innerW-qxPos-20); }
  if (qBL) { const el = svg.append('text').attr('x',qxPos/2).attr('y',qyPos+(innerH-qyPos)/2+10).text(qBL); applyQ(el,qStyle); wrapText(el,qxPos-20); }
  if (qBR) { const el = svg.append('text').attr('x',qxPos+(innerW-qxPos)/2).attr('y',qyPos+(innerH-qyPos)/2+10).text(qBR); applyQ(el,qStyle); wrapText(el,innerW-qxPos-20); }

  // Size legend
  if (sizeCol) {
    const sVals = data.map(d => num(d[sizeCol]));
    const sMin = d3.min(sVals), sMax = d3.max(sVals);
    const lx = innerW + 15, ly = 20;
    svg.append('text').attr('x',lx).attr('y',ly).style('fill','#888').style('font-size','10px').style('font-family','DM Sans,sans-serif').text(sizeCol.length > 14 ? sizeCol.slice(0,13)+'‚Ä¶' : sizeCol);
    [[sMax, MAX_R,'Max'],[d3.median(sVals),(MIN_R+MAX_R)/2,'Med'],[sMin,MIN_R,'Min']].forEach(([val,r,lbl],i) => {
      svg.append('circle').attr('cx',lx+r).attr('cy',ly+28+i*36).attr('r',r).attr('fill','rgba(215,25,32,0.3)').attr('stroke','rgba(215,25,32,0.5)').attr('stroke-width',1);
      svg.append('text').attr('x',lx+r*2+6).attr('y',ly+28+i*36+4).style('fill','#888').style('font-size','10px').style('font-family','DM Sans,sans-serif').text(val.toFixed(1));
    });
  }

  // Persistent info panel (replaces tooltip)
  const infoPanel = document.getElementById('scatter-info-panel');
  const showTT = (event, d) => {
    if (!infoPanel) return;
    infoPanel.classList.add('has-data');
    // Top archetype for this player
    const pos   = d['Position'];
    const archs = POSITION_ARCHETYPES[pos] || Object.keys(MODELS);
    const best  = archs
      .map(a => ({ name: a, rank: Math.round(num(d[`${a} Rank`])) }))
      .sort((a, b) => b.rank - a.rank)[0];
    const archCol  = best ? (best.rank >= 70 ? 'var(--green)' : best.rank >= 45 ? 'var(--amber)' : best.rank >= 25 ? '#E09450' : 'var(--crimson)') : 'var(--muted)';
    const archLine = best
      ? `<div style="font-size:0.72rem;margin-top:0.3rem;"><span style="color:var(--muted);">Best fit:</span> <span style="color:${archCol};font-weight:600;">${best.name}</span> <span style="color:${archCol};font-weight:700;">${best.rank}</span></div>`
      : '';
    infoPanel.innerHTML = `
      <div class="scatter-info-name">${d['Player Name']||'‚Äî'}</div>
      <div class="scatter-info-meta">${d['Team']||''} ¬∑ ${d['League']||''} ¬∑ Age ${d['Age']||''}</div>
      <div class="scatter-info-vals">
        ${xCol}: <strong>${num(d[xCol]).toFixed(2)}</strong> &nbsp;¬∑&nbsp;
        ${yCol}: <strong>${num(d[yCol]).toFixed(2)}</strong>
        ${sizeCol ? ` &nbsp;¬∑&nbsp; ${sizeCol}: <strong>${num(d[sizeCol]).toFixed(2)}</strong>` : ''}
      </div>
      ${archLine}`;
  };
  const moveTT = event => {}; // no-op, panel is fixed position
  const hideTT = () => {}; // keep panel visible on mouseout

  // Background dots
  const u23On = document.getElementById('sc-u23-toggle').checked;
  const highlightNames = new Set(scHighlighted.map(n => n.toLowerCase()));
  const slKeys = new Set(shortlist.map(s => s.key));
  const wlKeys = new Set(watchlist.map(s => s.key));
  const isHighlighted = d => highlightNames.has((d['Player Name']||'').toLowerCase()) || (u23On && num(d['Age']) <= 23);
  const isShortlisted = d => slKeys.has(playerKey(d));
  const isWatchlisted = d => wlKeys.has(playerKey(d));
  const bgData = data.filter(d => !isHighlighted(d) && !isShortlisted(d) && !isWatchlisted(d));
  const slData = data.filter(d => !isHighlighted(d) && isShortlisted(d));
  const wlData = data.filter(d => !isHighlighted(d) && !isShortlisted(d) && isWatchlisted(d));
  const hiData = data.filter(d =>  isHighlighted(d));

  svg.selectAll('.dot-bg').data(bgData).enter().append('circle')
    .attr('cx', d => xScale(num(d[xCol]))).attr('cy', d => yScale(num(d[yCol])))
    .attr('r', d => rScale(d))
    .attr('fill','rgba(215,25,32,0.22)').attr('stroke','none')
    .style('animation', (d, i) => `dotIn ${0.3 + Math.random()*0.3}s cubic-bezier(0.34,1.56,0.64,1) ${i * 0.002}s both`)
    .on('mouseover', function(event, d) { d3.select(this).attr('fill','rgba(215,25,32,0.65)'); showTT(event, d); })
    .on('mousemove', moveTT).on('mouseout', function(event, d) { d3.select(this).attr('fill','rgba(215,25,32,0.22)'); hideTT(); })
    .on('click', (event, d) => { event.stopPropagation(); openProfileByKey(playerKey(d)); });

  // Watchlist dots ‚Äî amber outline
  wlData.forEach(d => {
    const cx = xScale(num(d[xCol])), cy = yScale(num(d[yCol])), r = sizeCol ? rScale(d) : 6;
    svg.append('circle').datum(d).attr('cx',cx).attr('cy',cy).attr('r',r)
      .attr('fill','rgba(232,160,32,0.3)').attr('stroke','var(--amber)').attr('stroke-width',1.5)
      .on('mouseover', function(event) { d3.select(this).attr('r',r+2); showTT(event, d); })
      .on('mousemove', moveTT).on('mouseout', function() { d3.select(this).attr('r',r); hideTT(); })
      .on('click', event => { event.stopPropagation(); openProfileByKey(playerKey(d)); });
    svg.append('text').attr('x',cx + r + 3).attr('y',cy - 3).text(formatName(d['Player Name']||''))
      .style('fill','var(--amber)').style('font-family','DM Sans,sans-serif').style('font-size','10px').style('font-weight','500').style('pointer-events','none');
  });

  // Shortlist dots ‚Äî green outline
  slData.forEach(d => {
    const cx = xScale(num(d[xCol])), cy = yScale(num(d[yCol])), r = sizeCol ? rScale(d) : 6;
    svg.append('circle').datum(d).attr('cx',cx).attr('cy',cy).attr('r',r)
      .attr('fill','rgba(60,180,113,0.3)').attr('stroke','var(--green)').attr('stroke-width',1.5)
      .on('mouseover', function(event) { d3.select(this).attr('r',r+2); showTT(event, d); })
      .on('mousemove', moveTT).on('mouseout', function() { d3.select(this).attr('r',r); hideTT(); })
      .on('click', event => { event.stopPropagation(); openProfileByKey(playerKey(d)); });
    svg.append('text').attr('x',cx + r + 3).attr('y',cy - 3).text(formatName(d['Player Name']||''))
      .style('fill','var(--green)').style('font-family','DM Sans,sans-serif').style('font-size','10px').style('font-weight','500').style('pointer-events','none');
  });

  // Highlighted dots
  hiData.forEach(d => {
    const cx = xScale(num(d[xCol])), cy = yScale(num(d[yCol])), r = sizeCol ? rScale(d) : 7;
    svg.append('circle').datum(d).attr('cx',cx).attr('cy',cy).attr('r',r)
      .attr('fill','white').attr('stroke','#D71920').attr('stroke-width',1.5)
      .style('filter','drop-shadow(0 0 5px rgba(215,25,32,0.7))')
      .on('mouseover', function(event) { d3.select(this).attr('r',r+2); showTT(event, d); })
      .on('mousemove', moveTT).on('mouseout', function() { d3.select(this).attr('r',r); hideTT(); })
      .on('click', event => { event.stopPropagation(); openProfileByKey(playerKey(d)); });
    svg.append('text').attr('x',cx + r + 3).attr('y',cy - 3).text(formatName(d['Player Name']||''))
      .style('fill','white').style('font-family','DM Sans,sans-serif').style('font-size','11px').style('font-weight','500').style('pointer-events','none');
  });

  // Title
  svg.append('text').attr('x',innerW/2).attr('y',-28).attr('text-anchor','middle')
    .style('fill','white').style('font-family','Bebas Neue,sans-serif').style('font-size','18px').style('letter-spacing','2px').text(title);

  // Footnote
  const pos = document.getElementById('sc-position').value;
  const ageMin = document.getElementById('sc-age-min').value;
  const ageMax = document.getElementById('sc-age-max').value;
  const usage  = document.getElementById('sc-usage').value;
  const u23Label = u23On ? ' ¬∑ U23 auto-highlighted' : '';
  const sizeLbl  = sizeCol ? ` ¬∑ Size = ${sizeCol}` : '';
  const slWlLabel = (slData.length || wlData.length) ? ` ¬∑ ‚≠ê${slData.length} shortlisted ¬∑ üëÅ${wlData.length} watchlisted` : '';
  const footnote = [pos||'All Positions', `Age ${ageMin}‚Äì${ageMax}`, `Min ${usage}% Usage`, `n=${data.length} ¬∑ highlighted n=${hiData.length}${u23Label}${slWlLabel}${sizeLbl}`].join(' | ');
  svg.append('text').attr('x',innerW/2).attr('y',innerH+62).attr('text-anchor','middle')
    .style('fill','#555').style('font-family','DM Sans,sans-serif').style('font-size','10px').text(footnote);
}

function wrapText(textEl, maxWidth) {
  const words = textEl.text().split(/[\s,]+/);
  const lines = [];
  let line = [];
  // approximate: 7px per char
  words.forEach(w => {
    line.push(w);
    if (line.join(' ').length * 7 > maxWidth) { lines.push(line.slice(0,-1).join(' ')); line = [w]; }
  });
  lines.push(line.join(' '));
  textEl.text('');
  lines.forEach((l, i) => textEl.append('tspan').attr('x', textEl.attr('x')).attr('dy', i === 0 ? 0 : 16).text(l));
}

function formatName(name) {
  const parts = (name || '').trim().split(' ');
  if (parts.length <= 1) return name;
  return parts[0][0] + '. ' + parts.slice(1).join(' ');
}

// Highlight player search
function scHighlightSearch() {
  const q = document.getElementById('sc-highlight-input').value.toLowerCase().trim();
  const box = document.getElementById('sc-highlight-suggestions');
  if (!q || !rawData.length) { box.style.display = 'none'; return; }
  const matches = [...new Set(rawData.map(r => r['Player Name']).filter(n => n && n.toLowerCase().includes(q)))].slice(0, 8);
  if (!matches.length) { box.style.display = 'none'; return; }
  box.style.display = 'block';
  box.innerHTML = matches.map(n =>
    `<div style="padding:0.4rem 0.75rem;cursor:pointer;font-size:0.84rem;transition:background 0.1s;" onmouseover="this.style.background='rgba(215,25,32,0.12)'" onmouseout="this.style.background=''" onclick="addHighlight('${n.replace(/'/g,"\\'")}')">
      ${n}
    </div>`
  ).join('');
}

function addHighlight(name) {
  if (!scHighlighted.includes(name)) scHighlighted.push(name);
  document.getElementById('sc-highlight-input').value = '';
  document.getElementById('sc-highlight-suggestions').style.display = 'none';
  renderHighlightTags();
}

function removeHighlight(name) {
  scHighlighted = scHighlighted.filter(n => n !== name);
  renderHighlightTags();
}

function renderHighlightTags() {
  document.getElementById('sc-highlight-tags').innerHTML = scHighlighted.map(n =>
    `<span class="highlight-tag">${formatName(n)}<button onclick="removeHighlight('${n.replace(/'/g,"\\'")}')">‚úï</button></span>`
  ).join('');
}

// Close suggestion box when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('#sc-highlight-input') && !e.target.closest('#sc-highlight-suggestions')) {
    const box = document.getElementById('sc-highlight-suggestions');
    if (box) box.style.display = 'none';
  }
});

let scatterView = 'scatter'; // 'scatter' | 'table'

function setScatterView(v) {
  scatterView = v;
  document.getElementById('sc-view-scatter').classList.toggle('active', v === 'scatter');
  document.getElementById('sc-view-table').classList.toggle('active', v === 'table');
  document.getElementById('scatter-chart-panel').style.display = v === 'scatter' ? '' : 'none';
  document.getElementById('scatter-table-panel').style.display = v === 'table' ? '' : 'none';
  document.getElementById('sc-export-btn').style.display       = v === 'scatter' ? '' : 'none';
  document.getElementById('sc-table-png-btn').style.display    = v === 'table'   ? '' : 'none';
  if (v === 'table') drawRankTable();
  if (v === 'scatter' && document.getElementById('scatter-svg').children.length === 0) drawScatter();
}

function exportRankTablePNG() {
  const el = document.getElementById('scatter-table-panel');
  if (!el || !el.innerHTML.trim()) { showKbdToast('‚ö† Draw table first'); return; }
  showKbdToast('üì∏ Capturing‚Ä¶');
  html2canvas(el, {
    backgroundColor: '#111111',
    scale: 2,
    useCORS: true,
    logging: false,
  }).then(canvas => {
    const a = document.createElement('a');
    const title = (document.getElementById('sc-title').value || 'rank_table').replace(/[^a-z0-9]/gi,'_').toLowerCase();
    a.download = 'saints_scout_' + title + '.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
    showKbdToast('‚úì PNG saved');
  }).catch(() => showKbdToast('‚ö† Export failed'));
}

function drawRankTable() {
  const el = document.getElementById('scatter-table-panel');
  if (!el) return;

  const xCol  = document.getElementById('sc-x').value;
  const title = document.getElementById('sc-title').value || xCol;
  const data  = getScatterData();

  if (!data.length) {
    el.innerHTML = '<div style="color:var(--muted);padding:2rem;text-align:center;">No data ‚Äî adjust filters and draw chart first.</div>';
    return;
  }

  const sorted = [...data].sort((a, b) => num(b[xCol]) - num(a[xCol]));
  const maxVal = num(sorted[0][xCol]);
  const minVal = num(sorted[sorted.length - 1][xCol]);
  const range  = maxVal - minVal || 1;

  // Auto-detect percentage columns (stored as 0‚Äì1 decimals)
  const sampleVals = sorted.slice(0, 20).map(r => num(r[xCol]));
  const isPct = sampleVals.every(v => v <= 1) && sampleVals.some(v => v > 0);
  const fmt = v => isPct ? (v * 100).toFixed(1) + '%' : v.toFixed(3);
  const colHeader = isPct ? xCol + ' (%)' : xCol;

  const COMP_ABBR = {
    'Premier League':'ENG1','La Liga':'ESP1','Serie A':'ITA1',
    'Bundesliga':'GER1','Ligue 1':'FRA1','Eredivisie':'NED1',
    'Primeira Liga':'POR1','S√ºper Lig':'TUR1','Premiership':'SCO1',
    'Jupiler Pro League':'BEL1','Ekstraklasa':'POL1','Super League':'SUI1',
    'Czech Liga':'CZE1','Superliga':'DEN1','NB I':'HUN1',
  };

  const u23On = document.getElementById('sc-u23-toggle').checked;
  const highlightNames = new Set(scHighlighted.map(n => n.toLowerCase()));

  const pos    = document.getElementById('sc-position').value;
  const ageMin = document.getElementById('sc-age-min').value;
  const ageMax = document.getElementById('sc-age-max').value;
  const usage  = document.getElementById('sc-usage').value;
  const sub    = [
    pos || 'All Positions',
    ageMin || ageMax ? `Age ${ageMin||'?'}‚Äì${ageMax||'?'}` : null,
    `Min ${usage}% Usage`,
    `n = ${sorted.length}`,
  ].filter(Boolean).join('  ¬∑  ');

  const rows = sorted.map((r, i) => {
    const rank   = i + 1;
    const val    = num(r[xCol]);
    const barW   = ((val - minVal) / range * 100).toFixed(1);
    const barCol = val >= minVal + range * 0.7  ? '#3CB371' :
                   val >= minVal + range * 0.45 ? '#C8B840' :
                   val >= minVal + range * 0.25 ? '#E09450' : '#D06060';
    const comp   = r['Competition'] || r['League'] || '';
    const abbr   = COMP_ABBR[comp] || comp.slice(0, 4);
    const mins   = Math.round(num(r['90s Played']) * 90).toLocaleString();
    const age    = r['Age'] || '‚Äî';
    const key    = playerKey(r);
    const isHL   = highlightNames.has((r['Player Name']||'').toLowerCase()) || (u23On && num(r['Age']) <= 23);

    return `<tr onclick="openProfileByKey('${key.replace(/'/g,"\\'")}')">
      <td class="rank-num${rank <= 3 ? ' top3' : ''}">${rank}</td>
      <td>
        <div class="rank-player-name${isHL ? ' highlighted' : ''}">${r['Player Name'] || '‚Äî'}</div>
        <div class="rank-player-meta">${r['Team'] || ''}</div>
      </td>
      <td class="rank-age">${age}</td>
      <td class="rank-comp">${abbr}</td>
      <td class="rank-mins">${mins}</td>
      <td class="rank-val-cell">
        <div class="rank-val-num">${fmt(val)}</div>
        <div class="rank-val-bar" style="width:${barW}%;background:${barCol};"></div>
      </td>
    </tr>`;
  }).join('');

  el.innerHTML = `
    <div class="rank-table-header">
      <div>
        <div class="rank-table-title">${title}</div>
        <div class="rank-table-sub">${sub}</div>
      </div>
    </div>
    <div class="rank-table-wrap">
      <table class="rank-table">
        <thead><tr>
          <th style="width:2.5rem;">#</th>
          <th>Player</th>
          <th class="num">Age</th>
          <th class="num">Comp</th>
          <th class="num">Mins</th>
          <th class="num">${colHeader}</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

function exportScatterPNG() {
  const svgEl = document.getElementById('scatter-svg');
  if (!svgEl) return;
  const svgData = new XMLSerializer().serializeToString(svgEl);
  const canvas  = document.createElement('canvas');
  const scale   = 2;
  canvas.width  = svgEl.viewBox.baseVal.width  * scale;
  canvas.height = svgEl.viewBox.baseVal.height * scale;
  const ctx = canvas.getContext('2d');
  ctx.scale(scale, scale);
  ctx.fillStyle = '#111111';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  const img = new Image();
  const blob = new Blob([svgData], { type:'image/svg+xml;charset=utf-8' });
  img.onload = () => {
    ctx.drawImage(img, 0, 0);
    const a = document.createElement('a');
    a.download = `saints_scout_scatter_${Date.now()}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
    URL.revokeObjectURL(img.src);
  };
  img.src = URL.createObjectURL(blob);
}

// ‚îÄ‚îÄ CHART PRESETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let scPresets = JSON.parse(localStorage.getItem('saints_scout_presets') || '{}');

function getScatterState() {
  return {
    x: document.getElementById('sc-x').value,
    y: document.getElementById('sc-y').value,
    size: document.getElementById('sc-size').value,
    title: document.getElementById('sc-title').value,
    qTL: document.getElementById('sc-q-tl').value,
    qTR: document.getElementById('sc-q-tr').value,
    qBL: document.getElementById('sc-q-bl').value,
    qBR: document.getElementById('sc-q-br').value,
    pos: document.getElementById('sc-position').value,
    ageMin: document.getElementById('sc-age-min').value,
    ageMax: document.getElementById('sc-age-max').value,
    usage: document.getElementById('sc-usage').value,
    u23: document.getElementById('sc-u23-toggle').checked,
    leagues: getCheckedLeagues('sc-league-list'),
    highlighted: [...scHighlighted]
  };
}

function applyScatterState(s) {
  if (!s) return;
  const set = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined) el.value = v; };
  set('sc-x', s.x); set('sc-y', s.y); set('sc-size', s.size||'');
  set('sc-title', s.title||''); set('sc-q-tl', s.qTL||''); set('sc-q-tr', s.qTR||'');
  set('sc-q-bl', s.qBL||''); set('sc-q-br', s.qBR||'');
  set('sc-position', s.pos||''); set('sc-age-min', s.ageMin); set('sc-age-max', s.ageMax); set('sc-usage', s.usage);
  document.getElementById('sc-u23-toggle').checked = !!s.u23;
  document.querySelectorAll('#sc-league-list input').forEach(cb => { cb.checked = (s.leagues||[]).includes(cb.value); });
  updateLeagueTrigger('sc');
  scHighlighted = [...(s.highlighted||[])];
  renderHighlightTags();
}

function populatePresetSelect() {
  const sel = document.getElementById('sc-preset-select');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Load a preset ‚Äî</option>';
  Object.keys(scPresets).sort().forEach(name => {
    const o = document.createElement('option'); o.value = o.textContent = name; sel.appendChild(o);
  });
  if (cur && scPresets[cur]) sel.value = cur;
}

function savePreset() {
  const name = document.getElementById('sc-preset-name').value.trim();
  if (!name) { alert('Enter a name for the preset first.'); return; }
  scPresets[name] = getScatterState();
  try { localStorage.setItem('saints_scout_presets', JSON.stringify(scPresets)); } catch(e){}
  document.getElementById('sc-preset-name').value = '';
  populatePresetSelect();
  document.getElementById('sc-preset-select').value = name;
}

function loadPreset() {
  const name = document.getElementById('sc-preset-select').value;
  if (!name || !scPresets[name]) return;
  applyScatterState(scPresets[name]);
  drawScatter();
}

function deletePreset() {
  const name = document.getElementById('sc-preset-select').value;
  if (!name || !scPresets[name]) return;
  if (!confirm(`Delete preset "${name}"?`)) return;
  delete scPresets[name];
  try { localStorage.setItem('saints_scout_presets', JSON.stringify(scPresets)); } catch(e){}
  populatePresetSelect();
}

// ‚îÄ‚îÄ PLAYER COMPARE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let comparePlayerA = null;
let comparePlayerB = null;

const COMPARE_SECTIONS = {
  'Key Stats':  ['Age','Usage','Minutes Played','Touches per 90'],
  'OBV':        ['OBV Rank','Pass OBV Rank','Dribble & Carry OBV Rank','Shot OBV Rank'],
  'Attacking':  ['Advanced Striker Rank','Creative Striker Rank','Box Crasher Rank','Inverted Winger Rank','Creative Winger Rank','Half Space Creator Rank','Zone Mover Rank','Game Breaker Rank','Flyer Rank','Number 10 Rank'],
  'Midfield':   ['Ball Progressor Rank','Holding Midfielder Rank','Possession Rank','Progression Rank','Penetration Rank','Ground Eaters Rank','Disruptor Rank','Pressure Rank'],
  'Defending':  ['Dominant Defender Rank','Ball Playing Defender Rank','Defensive Fullback Rank','Attacking Fullback Rank','Prevention Rank'],
};

function openCompare() {
  if (!currentProfileKey) return;
  comparePlayerA = rawData.findIndex(r => playerKey(r) === currentProfileKey);
  comparePlayerB = null;
  document.getElementById('compare-search-input').value = '';
  document.getElementById('compare-suggestions').style.display = 'none';
  document.getElementById('compare-body').innerHTML = '<div style="text-align:center;padding:3rem;color:var(--muted);font-size:0.88rem;">Search for a second player above to begin the comparison</div>';
  const rA = rawData[comparePlayerA];
  document.getElementById('compare-subtitle').textContent = `Comparing ${rA['Player Name']} against...`;
  closeProfileModal();
  document.getElementById('compare-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeCompareModal() {
  document.getElementById('compare-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function handleCompareModalClick(e) {
  if (e.target === document.getElementById('compare-modal')) closeCompareModal();
}

function compareSearch() {
  const q = document.getElementById('compare-search-input').value.toLowerCase().trim();
  const box = document.getElementById('compare-suggestions');
  if (!q || !rawData.length) { box.style.display='none'; return; }
  const rA = rawData[comparePlayerA];
  const matches = rawData.filter(r => r['Player Name'] && r['Player Name'].toLowerCase().includes(q) && playerKey(r) !== playerKey(rA)).slice(0, 10);
  if (!matches.length) { box.style.display='none'; return; }
  box.style.display = 'block';
  box.innerHTML = matches.map(r => {
    const idx = rawData.indexOf(r);
    return `<div class="compare-sugg-item" onclick="selectCompareB(${idx})">
      <strong style="color:white">${r['Player Name']}</strong>
      <span style="color:var(--muted);font-size:0.76rem;margin-left:0.5rem">${r['Team']||''} ¬∑ ${r['League']||''} ¬∑ ${r['Position']||''} ¬∑ Age ${r['Age']||''}</span>
    </div>`;
  }).join('');
}

function selectCompareB(idx) {
  comparePlayerB = idx;
  document.getElementById('compare-suggestions').style.display = 'none';
  document.getElementById('compare-search-input').value = rawData[idx]['Player Name'];
  renderCompare();
}

function renderCompare() {
  if (comparePlayerA === null || comparePlayerB === null) return;
  const rA = rawData[comparePlayerA], rB = rawData[comparePlayerB];
  document.getElementById('compare-subtitle').textContent = `${rA['Player Name']} vs ${rB['Player Name']}`;

  // Win count across all bar metrics both players share
  const posA = rA['Position'], posB = rB['Position'];
  const sectionsA = POSITION_BARS[posA] || [];
  const sectionsB = POSITION_BARS[posB] || [];
  // Find shared metrics by column name
  const keysA = new Set(sectionsA.flatMap(s => s.metrics.map(m => m.col + (m.invert?'_inv':''))));
  const keysB = new Set(sectionsB.flatMap(s => s.metrics.map(m => m.col + (m.invert?'_inv':''))));
  const sharedKeys = [...keysA].filter(k => keysB.has(k));
  let aWins = 0, bWins = 0;
  sharedKeys.forEach(k => {
    const vA = num(rA[`${k}_BarRank`]), vB = num(rB[`${k}_BarRank`]);
    if (vA > vB) aWins++; else if (vB > vA) bWins++;
  });
  const total = aWins + bWins || 1;

  // Summary bar
  let html = `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:1rem 1.25rem;margin-bottom:1.25rem;display:flex;align-items:center;gap:1.25rem;">
    <div style="text-align:center;min-width:64px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--green);line-height:1">${aWins}</div>
      <div style="font-size:0.7rem;color:var(--muted);margin-top:0.2rem">${rA['Player Name'].split(' ').pop()} leads</div>
    </div>
    <div style="flex:1">
      <div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden;display:flex">
        <div style="width:${Math.round(aWins/total*100)}%;background:var(--green);transition:width 0.4s"></div>
        <div style="width:${Math.round(bWins/total*100)}%;background:var(--crimson)"></div>
      </div>
      <div style="text-align:center;font-size:0.72rem;color:var(--muted);margin-top:0.35rem">${sharedKeys.length} shared metrics</div>
    </div>
    <div style="text-align:center;min-width:64px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--crimson);line-height:1">${bWins}</div>
      <div style="font-size:0.7rem;color:var(--muted);margin-top:0.2rem">${rB['Player Name'].split(' ').pop()} leads</div>
    </div>
  </div>`;

  // Side-by-side bar charts
  // If same position: use shared sections. If different: show each player's own sections
  const samePosition = posA === posB;

  function compareBarsCol(r, sections, oppR) {
    const nineties = num(r['90s Played']);
    const isLow = nineties < minNineties;
    const lowBanner = isLow ? `<div class="pbar-sample-banner" style="font-size:0.68rem;padding:0.25rem 0.5rem;margin-bottom:0.5rem;">‚ö† ${nineties.toFixed(1)} 90s ‚Äî small sample</div>` : '';
    return `<div>
      <div class="compare-bars-col-header">${r['Player Name']}</div>
      <div class="compare-bars-col-meta">${[r['Team'],r['League'],r['Position'],`Age ${r['Age']}`].filter(Boolean).join(' ¬∑ ')}</div>
      ${lowBanner}
      ${sections.map(({section, metrics}) => {
        const rowsHtml = metrics.map(m => {
          const key = m.col + (m.invert ? '_inv' : '');
          const pct = Math.round(num(r[`${key}_BarRank`]));
          const oppPct = Math.round(num(oppR[`${key}_BarRank`]));
          const col = pbarColour(pct);
          const raw = pbarRawDisplay(r, m);
          // Highlight if winning vs opponent on shared metric
          const winning = keysB.has(key) && keysA.has(key) && pct > oppPct;
          const txtStyle = winning ? 'font-weight:700;' : '';
          return `<div class="compare-pbar-row">
            <div class="compare-pbar-label">${m.label}</div>
            <div class="compare-pbar-raw">${raw}</div>
            <div class="compare-pbar-track"><div class="compare-pbar-fill pbar-${col}" style="width:${pct}%;height:100%;border-radius:4px;"></div></div>
            <div class="compare-pbar-pct pbar-${col}-txt" style="${txtStyle}">${pct}%</div>
          </div>`;
        }).join('');
        return `<div class="compare-bars-section-title">${section}</div>${rowsHtml}`;
      }).join('')}
    </div>`;
  }

  html += `<div class="compare-bars-grid">
    ${compareBarsCol(rA, sectionsA, rB)}
    ${compareBarsCol(rB, sectionsB, rA)}
  </div>`;

  if (!samePosition) {
    html += `<div style="margin-top:0.75rem;font-size:0.74rem;color:var(--muted);text-align:center;">Players are in different positions ‚Äî each column shows their own position metrics. Bold % = winning on a shared metric.</div>`;
  }

  // ‚îÄ‚îÄ Archetype Rank Comparison ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Union of position-relevant archetypes for both players, sorted by combined rank
  const archsA = POSITION_ARCHETYPES[posA] || Object.keys(MODELS);
  const archsB = POSITION_ARCHETYPES[posB] || Object.keys(MODELS);
  const allArchs = [...new Set([...archsA, ...archsB])];

  // Sort by whichever player has the higher rank for that archetype
  const ranked = allArchs.map(a => ({
    name: a,
    rA: Math.round(num(rA[`${a} Rank`])),
    rB: Math.round(num(rB[`${a} Rank`])),
  })).sort((x, y) => Math.max(y.rA, y.rB) - Math.max(x.rA, x.rB))
    .slice(0, 10); // top 10 most relevant archetypes

  const archRows = ranked.map(({ name, rA: ra, rB: rb }) => {
    const colA = ra >= 70 ? 'var(--green)' : ra >= 45 ? 'var(--amber)' : ra >= 25 ? '#E09450' : 'var(--crimson)';
    const colB = rb >= 70 ? 'var(--green)' : rb >= 45 ? 'var(--amber)' : rb >= 25 ? '#E09450' : 'var(--crimson)';
    const boldA = ra > rb ? 'font-weight:700;' : '';
    const boldB = rb > ra ? 'font-weight:700;' : '';
    const inA = archsA.includes(name), inB = archsB.includes(name);
    const tag = (!inA || !inB) ? `<span style="font-size:0.6rem;color:var(--muted);margin-left:0.3rem;">(${inA?posA:posB} only)</span>` : '';
    return `<div style="display:grid;grid-template-columns:1fr auto auto auto 1fr;align-items:center;gap:0.5rem;padding:0.3rem 0;border-bottom:1px solid var(--border);">
      <div style="text-align:right;font-size:0.82rem;font-weight:700;color:${colA};${boldA}">${ra}<span style="font-size:0.65rem;font-weight:400;opacity:0.6;">%ile</span></div>
      <div style="width:32px;height:6px;background:var(--border);border-radius:3px;overflow:hidden;"><div style="width:${ra}%;height:100%;background:${colA};border-radius:3px;"></div></div>
      <div style="text-align:center;font-size:0.75rem;color:var(--text);white-space:nowrap;">${name}${tag}</div>
      <div style="width:32px;height:6px;background:var(--border);border-radius:3px;overflow:hidden;"><div style="width:${rb}%;height:100%;background:${colB};border-radius:3px;margin-left:auto;"></div></div>
      <div style="text-align:left;font-size:0.82rem;font-weight:700;color:${colB};${boldB}">${rb}<span style="font-size:0.65rem;font-weight:400;opacity:0.6;">%ile</span></div>
    </div>`;
  }).join('');

  html += `<div style="margin-top:1.5rem;">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:0.82rem;letter-spacing:2px;color:var(--muted);padding-bottom:0.5rem;border-bottom:1px solid var(--border);margin-bottom:0.5rem;display:grid;grid-template-columns:1fr auto auto auto 1fr;gap:0.5rem;align-items:center;">
      <div style="text-align:right;font-size:0.75rem;color:var(--text);">${rA['Player Name'].split(' ').pop()}</div>
      <div></div><div style="text-align:center;">ARCHETYPE RANKS</div><div></div>
      <div style="font-size:0.75rem;color:var(--text);">${rB['Player Name'].split(' ').pop()}</div>
    </div>
    ${archRows}
  </div>`;

  document.getElementById('compare-body').innerHTML = html;
}

document.addEventListener('keydown', e => {
  const tag = document.activeElement?.tagName;
  const inText = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
  const modals = document.querySelector('.modal-overlay.open');

  // Escape ‚Äî close any open modal
  if (e.key === 'Escape') {
    closeProfileModal();
    closeCompareModal();
    return;
  }

  // Arrow keys ‚Äî navigate between players when profile modal is open
  if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && document.getElementById('profile-modal')?.classList.contains('open') && !inText) {
    e.preventDefault();
    navigateProfile(e.key === 'ArrowLeft' ? -1 : 1);
    return;
  }

  // Cmd/Ctrl+S ‚Äî save current report
  if ((e.metaKey || e.ctrlKey) && e.key === 's') {
    e.preventDefault();
    if (currentReportKey) {
      saveReport(currentReportKey);
      showKbdToast('Report saved');
    }
    return;
  }

  // / ‚Äî jump to the visible search bar (not when already typing)
  if (e.key === '/' && !inText && !modals) {
    e.preventDefault();
    const activePage = document.querySelector('.page.active')?.id;
    const targets = {
      'page-scout':    'f-name-search',
      'page-obv':      'f-name-search',
      'page-reports':  'report-list-filter',
      'page-pipeline': null,
      'page-targets':  null,
      'page-shortlist': null,
    };
    const targetId = targets[activePage];
    if (targetId) {
      const el = document.getElementById(targetId);
      if (el) { el.focus(); el.select(); showKbdToast('Search focused'); }
    }
    return;
  }
});

document.addEventListener('click', e => {
  if (!e.target.closest('#compare-search-input') && !e.target.closest('#compare-suggestions')) {
    const box = document.getElementById('compare-suggestions');
    if (box) box.style.display = 'none';
  }
});

// ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REPORT_SECTIONS = ['Physical and Athletic', 'ATB', 'WTB', 'Summary'];
const RECOMMENDATION_OPTIONS = ['', 'Recommended', 'Monitor', 'Not Recommended'];
const RECOMMENDATION_COLORS  = { 'Recommended':'var(--green)', 'Monitor':'var(--amber)', 'Not Recommended':'var(--crimson)', ''  :'var(--muted)' };
const TRACKING_STAGES = ['Track', 'Video Scout', 'Senior Viewing', 'Shortlist', 'Push'];
const SQUAD_POSITIONS = ['','1','2a','2b','3','4','5a','5b','6','8a','8b','7a','7b','11a','11b','10','9a','9b'];
let currentReportKey = null;
let reportView = 'cards'; // 'cards' | 'list'
let stageFilter = '';
let recFilter   = '';

function updateReportsBadge() {
  const count = Object.keys(reports).length;
  const badge = document.getElementById('reports-badge');
  if (!badge) return;
  badge.textContent = count;
  badge.classList.toggle('visible', count > 0);
}

function reportKey(name, team) { return `${name}|||${team||''}`; }

function setReportView(v) {
  reportView = v;
  document.getElementById('view-btn-cards').classList.toggle('active', v==='cards');
  document.getElementById('view-btn-list').classList.toggle('active', v==='list');
  renderReportList();
}

function setStageFilter(stage) {
  stageFilter = stage;
  document.querySelectorAll('#stage-filter-wrap .stage-filter-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderReportList();
}

function setRecFilter(val) {
  recFilter = val;
  document.querySelectorAll('#rec-filter-wrap .stage-filter-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderReportList();
}

function stagePillHTML(stage) {
  if (!stage) return '';
  const cls = `stage-${CSS.escape(stage)}`;
  return `<span class="stage-pill stage-${stage.replace(/\s/g,'\\ ')}" style="">${stage}</span>`;
}

// Inline stage pill with proper inline styles (avoid CSS escaping issues)
function stagePillInline(stage) {
  if (!stage) return '';
  const colors = {
    'Track':          { bg:'rgba(136,136,136,0.15)', color:'#999',    border:'rgba(136,136,136,0.3)' },
    'Video Scout':    { bg:'rgba(80,140,220,0.15)',  color:'#7DB8F0', border:'rgba(80,140,220,0.3)' },
    'Senior Viewing': { bg:'rgba(232,160,32,0.15)', color:'#E8B84A', border:'rgba(232,160,32,0.3)' },
    'Shortlist':      { bg:'rgba(60,180,130,0.15)', color:'#5ECBA1', border:'rgba(60,180,130,0.3)' },
    'Push':           { bg:'rgba(215,25,32,0.18)',  color:'#F05060', border:'rgba(215,25,32,0.35)' },
  };
  const c = colors[stage] || { bg:'rgba(136,136,136,0.1)', color:'#888', border:'rgba(136,136,136,0.2)' };
  return `<span style="display:inline-flex;align-items:center;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;padding:0.18rem 0.55rem;border-radius:20px;background:${c.bg};color:${c.color};border:1px solid ${c.border};white-space:nowrap;">${stage}</span>`;
}

function getFilteredReportKeys() {
  const filter    = (document.getElementById('report-list-filter')?.value || '').toLowerCase();
  const posFilter = document.getElementById('report-pos-filter')?.value || '';
  return Object.keys(reports).filter(k => {
    const r = reports[k];
    if (filter && !(r.name||'').toLowerCase().includes(filter) && !(r.team||'').toLowerCase().includes(filter)) return false;
    if (posFilter && r.squadPosition !== posFilter) return false;
    if (stageFilter && r.trackingStage !== stageFilter) return false;
    if (recFilter === '__none__' && r.recommendation) return false;
    if (recFilter && recFilter !== '__none__' && r.recommendation !== recFilter) return false;
    return true;
  }).sort((a, b) => {
    // Pinned always first
    if (reports[b].pinned && !reports[a].pinned) return 1;
    if (reports[a].pinned && !reports[b].pinned) return -1;
    return (reports[b].updatedAt||0) - (reports[a].updatedAt||0);
  });
}

function renderReportList() {
  const keys = getFilteredReportKeys();
  const total = Object.keys(reports).length;

  const countEl = document.getElementById('report-count-label');
  if (countEl) countEl.textContent = `${keys.length} of ${total} report${total !== 1 ? 's' : ''}`;

  const wrap = document.getElementById('report-main-view');
  if (!wrap) return;

  if (!total) {
    wrap.innerHTML = `<div style="text-align:center;padding:4rem 2rem;color:var(--muted);">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;margin-bottom:0.5rem;">NO REPORTS YET</div>
      <div style="font-size:0.85rem;">Click <strong style="color:var(--text)">+ New Report</strong> to start writing</div>
    </div>`;
    return;
  }

  if (!keys.length) {
    wrap.innerHTML = `<div style="text-align:center;padding:3rem 2rem;color:var(--muted);font-size:0.85rem;">No reports match your filters.</div>`;
    return;
  }

  if (reportView === 'cards') {
    wrap.innerHTML = `<div class="report-summary-grid">${keys.map(k => reportCardHTML(k)).join('')}</div>`;
  } else {
    wrap.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.4rem;">${keys.map(k => reportListRowHTML(k)).join('')}</div>`;
  }
}

function reportCardHTML(k) {
  const r = reports[k];
  const safeKey = k.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  const date = r.updatedAt ? new Date(r.updatedAt).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'}) : '';
  const posTag = r.squadPosition ? `<span style="background:rgba(215,25,32,0.18);color:#F27070;border:1px solid rgba(215,25,32,0.3);border-radius:3px;font-size:0.64rem;font-weight:700;padding:0.1rem 0.35rem;font-family:'DM Sans',sans-serif;letter-spacing:0.5px;">${r.squadPosition}</span>` : '';
  const stageSelect = `<select onchange="setTrackingStage('${safeKey}',this.value)" onclick="event.stopPropagation()"
    style="background:none;border:none;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;cursor:pointer;padding:0.18rem 0.4rem;border-radius:20px;color:${stageColor(r.trackingStage)};max-width:120px;">
    <option value="" ${!r.trackingStage?'selected':''}>‚Äî Stage ‚Äî</option>
    ${TRACKING_STAGES.map(s=>`<option value="${s}" ${r.trackingStage===s?'selected':''}>${s}</option>`).join('')}
  </select>`;

  return `<div class="report-card" onclick="openReport('${safeKey}')">
    <div class="report-card-top">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.5rem;margin-bottom:0.3rem;">
        <div class="report-card-name">${r.name||'Unknown'}</div>
        <div style="display:flex;align-items:center;gap:0.3rem;flex-shrink:0;">
          ${posTag}
          <button class="pin-btn ${r.pinned?'pinned':''}" onclick="togglePin('${safeKey}');event.stopPropagation();" title="${r.pinned?'Unpin':'Pin to top'}">üìå</button>
        </div>
      </div>
      <div class="report-card-meta">${[r.team,r.league,r.position,r.age?`Age ${r.age}`:''].filter(Boolean).join(' ¬∑ ')}</div>
    </div>
    <div class="report-card-body">
      <div class="report-card-conclusion">${r.conclusion ? `"${r.conclusion}"` : '<span style="color:var(--muted);font-style:normal;font-size:0.76rem;">No conclusion written yet</span>'}</div>
    </div>
    <div class="report-card-footer">
      ${r.trackingStage ? stagePillInline(r.trackingStage) : stageSelect}
      ${r.recommendation ? `<span style="font-size:0.65rem;font-weight:700;color:${RECOMMENDATION_COLORS[r.recommendation]||'var(--muted)'};letter-spacing:0.3px;">${r.recommendation==='Recommended'?'‚úì':r.recommendation==='Not Recommended'?'‚úó':'~'} ${r.recommendation}</span>` : ''}
      <span class="report-card-date">${date}</span>
    </div>
  </div>`;
}

function reportListRowHTML(k) {
  const r = reports[k];
  const safeKey = k.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  const date = r.updatedAt ? new Date(r.updatedAt).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'}) : '';
  const posTag = r.squadPosition ? `<span style="background:rgba(215,25,32,0.18);color:#F27070;border:1px solid rgba(215,25,32,0.3);border-radius:3px;font-size:0.64rem;font-weight:700;padding:0.1rem 0.35rem;font-family:'DM Sans',sans-serif;letter-spacing:0.5px;">${r.squadPosition}</span>` : '';
  return `<div style="display:flex;align-items:center;gap:0.85rem;background:var(--surface);border:1px solid ${r.pinned?'rgba(232,160,32,0.4)':'var(--border)'};border-left:${r.pinned?'3px solid var(--amber)':'1px solid '+(currentReportKey===k?'var(--red)':'var(--border)')};border-radius:4px;padding:0.65rem 1rem;cursor:pointer;transition:border-color 0.15s,background 0.15s;${currentReportKey===k?'background:rgba(215,25,32,0.05);':''}"
    onmouseover="this.style.borderColor='var(--red)'" onmouseout="this.style.borderColor='${r.pinned?'rgba(232,160,32,0.4)':currentReportKey===k?'var(--red)':'var(--border)'}'"
    onclick="openReport('${safeKey}')">
    <button class="pin-btn ${r.pinned?'pinned':''}" onclick="togglePin('${safeKey}');event.stopPropagation();" title="${r.pinned?'Unpin':'Pin to top'}">üìå</button>
    <div style="flex:1;min-width:0;">
      <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.15rem;">
        ${posTag}
        <span style="font-weight:600;color:white;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.name||'Unknown'}</span>
      </div>
      <div style="color:var(--muted);font-size:0.74rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${[r.team,r.league,r.position,r.age?`Age ${r.age}`:''].filter(Boolean).join(' ¬∑ ')}</div>
      ${r.conclusion ? `<div style="color:var(--amber);font-size:0.74rem;font-style:italic;margin-top:0.15rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">"${r.conclusion}"</div>` : ''}
    </div>
    ${r.trackingStage ? stagePillInline(r.trackingStage) : ''}
    ${r.recommendation ? `<span style="font-size:0.65rem;font-weight:700;color:${RECOMMENDATION_COLORS[r.recommendation]||'var(--muted)'};letter-spacing:0.3px;flex-shrink:0;">${r.recommendation==='Recommended'?'‚úì':r.recommendation==='Not Recommended'?'‚úó':'~'} ${r.recommendation}</span>` : ''}
    <span style="color:var(--muted);font-size:0.72rem;flex-shrink:0;">${date}</span>
  </div>`;
}

function stageColor(stage) {
  const map = { 'Track':'#999','Video Scout':'#7DB8F0','Senior Viewing':'#E8B84A','Shortlist':'#5ECBA1','Push':'#F05060' };
  return map[stage] || 'var(--muted)';
}

function setTrackingStage(key, stage) {
  if (!reports[key]) return;
  const prev = reports[key].trackingStage;
  reports[key].trackingStage = stage;
  reports[key].updatedAt = Date.now();
  // Record when player entered this stage (only update if stage actually changed)
  if (stage !== prev) {
    if (!reports[key].stageHistory) reports[key].stageHistory = {};
    if (stage) reports[key].stageHistory[stage] = Date.now();
  }
  persistReports();
  renderReportList();
  // Refresh editor if open
  if (currentReportKey === key) {
    const sel = document.getElementById('rep-tracking-stage');
    if (sel) sel.value = stage;
    const pill = document.getElementById('rep-stage-pill');
    if (pill) pill.innerHTML = stage ? stagePillInline(stage) : '<span style="color:var(--muted);font-size:0.78rem;">Not set</span>';
  }
}

function openReport(key) {
  currentReportKey = key;
  const r = reports[key];
  if (!r) return;
  renderReportList();

  const safeKey = key.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  const wrap = document.getElementById('report-editor-wrap');

  // Scroll editor into view
  setTimeout(() => wrap.scrollIntoView({ behavior:'smooth', block:'nearest' }), 50);

  wrap.innerHTML = `
    <div class="report-editor" style="margin-top:1.5rem;">
      <div class="report-editor-header">
        <div style="flex:1;min-width:0;">
          <div class="report-editor-name">${r.name||'Unknown Player'}</div>
          <div class="report-editor-meta">${[r.team,r.league,r.position,r.age?`Age ${r.age}`:''].filter(Boolean).join(' ¬∑ ')}</div>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end;">

          <!-- Tracking stage -->
          <div style="display:flex;flex-direction:column;gap:0.2rem;align-items:flex-end;">
            <label style="font-size:0.64rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);">Tracking Stage</label>
            <select id="rep-tracking-stage" onchange="setTrackingStage('${safeKey}',this.value)"
              style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:3px;padding:0.35rem 0.65rem;font-family:'DM Sans',sans-serif;font-size:0.82rem;cursor:pointer;min-width:130px;">
              <option value="" ${!r.trackingStage?'selected':''}>‚Äî No stage ‚Äî</option>
              ${TRACKING_STAGES.map(s=>`<option value="${s}" ${r.trackingStage===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </div>

          <!-- Recommendation -->
          <div style="display:flex;flex-direction:column;gap:0.2rem;align-items:flex-end;">
            <label style="font-size:0.64rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);">Recommendation</label>
            <select id="rep-recommendation" onchange="saveRecommendation('${safeKey}')"
              style="background:var(--surface2);border:1px solid var(--border);color:${RECOMMENDATION_COLORS[r.recommendation||'']};border-radius:3px;padding:0.35rem 0.65rem;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;min-width:145px;">
              ${RECOMMENDATION_OPTIONS.map(o=>`<option value="${o}" ${(r.recommendation||'')=== o?'selected':''}>${o||'‚Äî No verdict ‚Äî'}</option>`).join('')}
            </select>
          </div>

          <!-- Squad position -->
          <div style="display:flex;flex-direction:column;gap:0.2rem;align-items:flex-end;">
            <label style="font-size:0.64rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);">Squad Position</label>
            <select id="rep-squad-pos" onchange="saveSquadPosition('${safeKey}')"
              style="background:var(--surface2);border:1px solid var(--red);color:var(--red);border-radius:3px;padding:0.35rem 0.65rem;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1px;width:85px;cursor:pointer;">
              ${SQUAD_POSITIONS.map(p=>`<option value="${p}" ${r.squadPosition===p?'selected':''}>${p||'‚Äî'}</option>`).join('')}
            </select>
          </div>

        <div style="display:flex;gap:0.5rem;align-items:center;">
            <button class="pin-btn ${r.pinned?'pinned':''}" onclick="togglePin('${safeKey}');event.stopPropagation();" title="${r.pinned?'Unpin':'Pin to top'}">üìå</button>
            <button class="btn btn-sm btn-outline" onclick="openCompareFromReport('${safeKey}')">‚öñ Compare</button>
            <button class="btn btn-sm btn-outline" onclick="copyReportText('${safeKey}')">‚éò Copy</button>
            <button class="btn btn-sm btn-outline" style="border-color:var(--crimson);color:var(--crimson);" onclick="deleteReport('${safeKey}')">‚úï</button>
          </div>
        </div>
      </div>

      <div class="report-editor-body">
        <div class="report-section">
          <div class="report-section-label">‚≠ê Conclusion</div>
          <div class="report-section-hint">One-liner ‚Äî the headline take on this player</div>
          <input type="text" class="report-conclusion-input" id="rep-conclusion"
            oninput="scheduleAutoSave('${safeKey}')"
            placeholder="e.g. 9a profile, Championship option. Live viewing recommended."
            value="${(r.conclusion||'').replace(/"/g,'&quot;')}">
        </div>
        <hr style="border:none;border-top:1px solid var(--border);">
        ${REPORT_SECTIONS.map(s => `
        <div class="report-section">
          <div class="report-section-label">${s}</div>
          <textarea class="report-textarea" id="rep-${s.replace(/\s+/g,'-')}" rows="7"
            oninput="scheduleAutoSave('${safeKey}')"
            placeholder="Write your ${s} notes here...">${(r.sections?.[s]||'').replace(/</g,'&lt;')}</textarea>
        </div>`).join('')}
      </div>

      <div class="report-actions">
        <button class="btn" onclick="saveReport('${safeKey}')">Save Report</button>
        <button class="btn btn-outline" onclick="copyReportText('${safeKey}')">‚éò Copy as Plain Text</button>
        <span class="autosave-indicator" id="report-saved-msg"></span>
        <span style="flex:1"></span>
        <span style="font-size:0.72rem;color:var(--muted);opacity:0.6;">
          <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:0.1rem 0.35rem;font-size:0.68rem;color:var(--text);">‚åòS</kbd> to save
        </span>
      </div>
    </div>`;
}

function saveSquadPosition(key) {
  if (!reports[key]) return;
  reports[key].squadPosition = document.getElementById('rep-squad-pos')?.value || '';
  reports[key].updatedAt = Date.now();
  persistReports();
  renderReportList();
}

function saveRecommendation(key) {
  if (!reports[key]) return;
  const val = document.getElementById('rep-recommendation')?.value || '';
  reports[key].recommendation = val;
  reports[key].updatedAt = Date.now();
  // Update the dropdown's text colour immediately
  const sel = document.getElementById('rep-recommendation');
  if (sel) sel.style.color = RECOMMENDATION_COLORS[val] || 'var(--muted)';
  persistReports();
  renderReportList();
  renderPipeline();
}

function saveReport(key, silent) {
  if (!reports[key]) return;
  reports[key].conclusion = document.getElementById('rep-conclusion')?.value || '';
  reports[key].recommendation = document.getElementById('rep-recommendation')?.value || '';
  reports[key].sections = {};
  REPORT_SECTIONS.forEach(s => {
    const el = document.getElementById(`rep-${s.replace(/\s+/g,'-')}`);
    if (el) reports[key].sections[s] = el.value;
  });
  reports[key].updatedAt = Date.now();
  persistReports();
  updateReportsBadge();
  renderReportList();
  // Show indicator
  const msg = document.getElementById('report-saved-msg');
  if (msg) {
    msg.className = 'autosave-indicator saved';
    msg.innerHTML = '‚úì Auto-saved';
    // Force reflow to restart animation
    void msg.offsetWidth;
  }
  if (!silent) {
    if (scoutFiltered.length) renderScoutTable();
    if (obvFiltered.length) renderOBVTable();
  }
}

function deleteReport(key) {
  if (!reports[key] || !confirm(`Delete report for ${reports[key].name}?`)) return;
  delete reports[key];
  persistReports(); updateReportsBadge();
  if (currentReportKey === key) {
    currentReportKey = null;
    document.getElementById('report-editor-wrap').innerHTML = '';
  }
  renderReportList();
  if (scoutFiltered.length) renderScoutTable();
  if (obvFiltered.length) renderOBVTable();
}

function copyReportText(key) {
  const r = reports[key]; if (!r) return;
  const posLabel = r.squadPosition ? ` [${r.squadPosition}]` : '';
  const stageLabel = r.trackingStage ? ` ‚Äî ${r.trackingStage}` : '';
  const recLabel = r.recommendation ? ` | ${r.recommendation}` : '';
  const header = `${r.name}${r.team ? ' - ' + r.team : ''}${posLabel}${stageLabel}${recLabel}`;
  let text = header + '\n' + '‚îÄ'.repeat(Math.min(header.length, 60)) + '\n\n';
  if (r.conclusion) text += `"${r.conclusion}"\n\n`;
  REPORT_SECTIONS.forEach(s => {
    const content = r.sections?.[s];
    if (content?.trim()) text += `${s}\n\n${content.trim()}\n\n`;
  });
  text = text.trimEnd() + '\n\n#Reports';
  navigator.clipboard.writeText(text).then(() => {
    const msg = document.getElementById('report-saved-msg');
    if (msg) {
      msg.className = 'autosave-indicator saved';
      msg.innerHTML = '‚úì Copied!';
      void msg.offsetWidth;
    }
  }).catch(() => alert('Copy failed ‚Äî please select and copy manually.'));
}

function openCompareFromReport(key) {
  const r = reports[key]; if (!r) return;
  // Find this player in rawData to use the existing compare system
  const playerRow = rawData.find(row => (row['Player Name']||'').toLowerCase() === (r.name||'').toLowerCase());
  if (!playerRow) {
    alert(`${r.name} not found in the loaded CSV. Load their data first to use Compare.`);
    return;
  }
  // Set up compare player A
  comparePlayerA = rawData.indexOf(playerRow);
  comparePlayerB = null;
  document.getElementById('compare-search-input').value = '';
  document.getElementById('compare-suggestions').style.display = 'none';
  document.getElementById('compare-body').innerHTML = '<div style="text-align:center;padding:3rem;color:var(--muted);font-size:0.88rem;">Search for a second player above to begin the comparison</div>';
  document.getElementById('compare-subtitle').textContent = `Comparing ${r.name} against...`;
  document.getElementById('compare-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function showNewReportPanel() {
  const panel = document.getElementById('new-report-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  if (panel.style.display === 'block') document.getElementById('new-report-search').focus();
}

function newReportSearch() {
  const q = document.getElementById('new-report-search').value.toLowerCase().trim();
  const box = document.getElementById('new-report-suggestions');
  if (!q) { box.style.display='none'; return; }
  const matches = rawData.length
    ? [...new Map(rawData.filter(r=>(r['Player Name']||'').toLowerCase().includes(q)).map(r=>[playerKey(r),r])).values()].slice(0,8)
    : [];
  if (!matches.length) { box.style.display='none'; return; }
  box.style.display='block';
  box.innerHTML = matches.map(r=>`
    <div class="report-new-sugg-item" onclick="createReportFromPlayer('${playerKey(r).replace(/\\/g,'\\\\').replace(/'/g,"\\'")}')">
      <span class="report-new-sugg-name">${r['Player Name']}</span>
      <span class="report-new-sugg-meta">${[r['Team'],r['League'],r['Position'],r['Age']?`Age ${r['Age']}`:''].filter(Boolean).join(' ¬∑ ')}</span>
    </div>`).join('');
}

function createReportFromPlayer(pKey) {
  const r = rawData.find(row => playerKey(row) === pKey);
  if (!r) return;
  const key = reportKey(r['Player Name'], r['Team']);
  if (!reports[key]) {
    reports[key] = { name:r['Player Name'], team:r['Team']||'', league:r['League']||'', position:r['Position']||'', age:r['Age']||'', conclusion:'', sections:{}, trackingStage:'', createdAt:Date.now(), updatedAt:Date.now() };
    persistReports(); updateReportsBadge();
  }
  document.getElementById('new-report-panel').style.display='none';
  document.getElementById('new-report-search').value='';
  document.getElementById('new-report-suggestions').style.display='none';
  renderReportList(); openReport(key);
}

function createManualReport() {
  const name = document.getElementById('new-report-search').value.trim();
  if (!name) { alert('Enter a player name first.'); return; }
  const key = reportKey(name, '');
  if (!reports[key]) {
    reports[key] = { name, team:'', league:'', position:'', age:'', conclusion:'', sections:{}, trackingStage:'', createdAt:Date.now(), updatedAt:Date.now() };
    persistReports(); updateReportsBadge();
  }
  document.getElementById('new-report-panel').style.display='none';
  document.getElementById('new-report-search').value='';
  renderReportList(); openReport(key);
}

function openReportFromModal() {
  if (!currentProfileKey) return;
  const r = rawData.find(row => playerKey(row) === currentProfileKey);
  if (!r) return;
  closeProfileModal();
  showPage('reports');
  setTimeout(() => {
    const key = reportKey(r['Player Name'], r['Team']);
    if (!reports[key]) {
      reports[key] = { name:r['Player Name'], team:r['Team']||'', league:r['League']||'', position:r['Position']||'', age:r['Age']||'', conclusion:'', sections:{}, trackingStage:'', createdAt:Date.now(), updatedAt:Date.now() };
      persistReports(); updateReportsBadge();
    }
    renderReportList(); openReport(key);
  }, 50);
}

document.addEventListener('click', e => {
  if (!e.target.closest('#new-report-search') && !e.target.closest('#new-report-suggestions')) {
    const box = document.getElementById('new-report-suggestions');
    if (box) box.style.display='none';
  }
});

// ‚îÄ‚îÄ PIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePin(key) {
  if (!reports[key]) return;
  reports[key].pinned = !reports[key].pinned;
  persistReports();
  renderReportList();
  // Update pin button in open editor if it's this report
  if (currentReportKey === key) {
    document.querySelectorAll(`.pin-btn`).forEach(btn => {
      if (btn.closest('#report-editor-wrap')) {
        btn.classList.toggle('pinned', !!reports[key].pinned);
        btn.title = reports[key].pinned ? 'Unpin' : 'Pin to top';
      }
    });
  }
  showKbdToast(reports[key].pinned ? 'üìå Pinned to top' : 'Unpinned');
}

// ‚îÄ‚îÄ AUTO-SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let autoSaveTimer = null;

function scheduleAutoSave(key) {
  // Show "unsaved" indicator immediately
  const msg = document.getElementById('report-saved-msg');
  if (msg) {
    msg.className = 'autosave-indicator unsaved';
    msg.innerHTML = '‚óè Unsaved changes';
    // Cancel the fade-out animation by forcing a reflow
    void msg.offsetWidth;
  }
  // Debounce: save 2s after last keystroke
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    if (reports[key]) {
      saveReport(key, true);
    }
  }, 2000);
}

// ‚îÄ‚îÄ TARGET POSITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let targetNeeds = JSON.parse(localStorage.getItem('saints_scout_targets') || '[]');

function persistTargets() {
  try { localStorage.setItem('saints_scout_targets', JSON.stringify(targetNeeds)); } catch(e) {}
  updateTargetsBadge();
}

function updateTargetsBadge() {
  const badge = document.getElementById('targets-badge');
  if (badge) { badge.textContent = targetNeeds.length; badge.classList.toggle('visible', targetNeeds.length > 0); }
}

function showTargetsPage() {
  if (!rawData.length) {
    document.getElementById('targets-no-data').style.display = 'block';
    document.getElementById('targets-content').style.display = 'none';
  } else {
    document.getElementById('targets-no-data').style.display = 'none';
    document.getElementById('targets-content').style.display = 'block';
    populateTargetLeagues();
    renderTargetNeeds();
    renderAllTargetResults();
  }
}

function populateTargetLeagues() {
  const sel = document.getElementById('t-league');
  if (!sel || sel.options.length > 1) return; // already populated
  const leagues = [...new Set(rawData.map(r => r['League']).filter(Boolean))].sort();
  leagues.forEach(l => {
    const o = document.createElement('option');
    o.value = l; o.textContent = l;
    sel.appendChild(o);
  });
}

function updateTargetArchetypes() {
  const pos = document.getElementById('t-position').value;
  const sel = document.getElementById('t-archetype');
  sel.innerHTML = '';
  if (!pos) { sel.innerHTML = '<option value="">Select position first...</option>'; return; }
  const archetypes = POSITION_ARCHETYPES[pos] || [];
  sel.innerHTML = `<option value="">Best overall for position</option>` +
    archetypes.map(a => `<option value="${a}">${a}</option>`).join('');
}

function addTargetNeed() {
  const pos      = document.getElementById('t-position').value;
  const archetype = document.getElementById('t-archetype').value;
  const league   = document.getElementById('t-league').value;
  const ageMin   = document.getElementById('t-age-min').value ? +document.getElementById('t-age-min').value : null;
  const ageMax   = document.getElementById('t-age-max').value ? +document.getElementById('t-age-max').value : null;
  const min90s   = document.getElementById('t-min90s').value ? +document.getElementById('t-min90s').value : 5;

  if (!pos) { alert('Please select a position'); return; }

  targetNeeds.push({ pos, archetype, league, ageMin, ageMax, min90s, id: Date.now() });
  persistTargets();
  renderTargetNeeds();
  renderAllTargetResults();
}

function removeTargetNeed(id) {
  targetNeeds = targetNeeds.filter(n => n.id !== id);
  persistTargets();
  renderTargetNeeds();
  renderAllTargetResults();
}

function clearTargetNeeds() {
  targetNeeds = [];
  persistTargets();
  renderTargetNeeds();
  renderAllTargetResults();
}

function renderTargetNeeds() {
  updateTargetsBadge();
  const el = document.getElementById('targets-needs-list');
  if (!el) return;
  if (!targetNeeds.length) {
    el.innerHTML = '<div class="targets-needs-empty">No needs defined yet</div>';
    return;
  }
  el.innerHTML = targetNeeds.map(n => {
    const label = n.archetype || `Best ${n.pos}`;
    const meta = [
      n.league || 'Any league',
      n.ageMin && n.ageMax ? `Age ${n.ageMin}‚Äì${n.ageMax}` : n.ageMin ? `Age ${n.ageMin}+` : n.ageMax ? `Under ${n.ageMax}` : null,
      `${n.min90s}+ 90s`
    ].filter(Boolean).join(' ¬∑ ');
    return `<div class="target-need-pill">
      <div class="target-need-pill-info">
        <div class="target-need-pill-archetype">${label}</div>
        <div class="target-need-pill-meta">${n.pos} ¬∑ ${meta}</div>
      </div>
      <button class="target-need-remove" onclick="removeTargetNeed(${n.id})" title="Remove">‚úï</button>
    </div>`;
  }).join('');
}

function renderAllTargetResults() {
  const el = document.getElementById('targets-results');
  if (!el) return;

  if (!targetNeeds.length) {
    el.innerHTML = `<div class="target-empty-results" style="padding:4rem;color:var(--muted);">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;margin-bottom:0.5rem;">NO NEEDS DEFINED</div>
      <div style="font-size:0.82rem;">Use the panel on the left to define a recruitment need.</div>
    </div>`;
    return;
  }

  el.innerHTML = targetNeeds.map(n => renderTargetBlock(n)).join('');
}

function renderTargetBlock(need) {
  // Filter candidates
  let pool = rawData.filter(r => {
    if (r['Position'] !== need.pos) return false;
    if (num(r['90s Played']) < need.min90s) return false;
    if (need.league && r['League'] !== need.league) return false;
    if (need.ageMin && num(r['Age']) < need.ageMin) return false;
    if (need.ageMax && num(r['Age']) > need.ageMax) return false;
    return true;
  });

  // Score: use archetype rank directly (absolute percentile, not relative to pool top)
  const archetypes = need.archetype
    ? [need.archetype]
    : (POSITION_ARCHETYPES[need.pos] || []);

  pool = pool.map(r => {
    const scores = archetypes.map(a => num(r[`${a} Rank`])).filter(v => v > 0);
    const score = scores.length ? scores.reduce((a,b) => a+b,0) / scores.length : 0;
    return { r, score };
  }).sort((a,b) => b.score - a.score);

  const top = pool.slice(0, 15);

  const label = need.archetype || `Best ${need.pos}`;
  const subParts = [
    need.league || 'Any league',
    need.ageMin && need.ageMax ? `Age ${need.ageMin}‚Äì${need.ageMax}` : need.ageMin ? `${need.ageMin}+` : need.ageMax ? `U${need.ageMax}` : null,
    `${need.min90s}+ 90s`,
    `${pool.length} candidates`
  ].filter(Boolean).join(' ¬∑ ');

  const trackedKeys   = new Set(Object.keys(reports));
  const slKeys        = new Set(shortlist.map(s => s.key));
  const wlKeys        = new Set(watchlist.map(s => s.key));

  const cards = top.length ? top.map(({r, score}, i) => {
    const key        = playerKey(r);
    const isTracked  = trackedKeys.has(key);
    const isOnSL     = slKeys.has(key);
    const isOnWL     = wlKeys.has(key);
    const rank       = Math.round(score);  // absolute percentile rank (0‚Äì100)
    const barColor   = rank >= 70 ? '#3CB371' : rank >= 50 ? '#C8B840' : rank >= 30 ? '#E09450' : '#D06060';
    const nineties   = num(r['90s Played']).toFixed(1);
    const idx        = rawData.indexOf(r);

    // Tracking badge ‚Äî shortlist > watchlist > report
    const trackBadge = isOnSL     ? `<span style="font-size:0.6rem;padding:0.1rem 0.35rem;border-radius:8px;background:rgba(60,180,113,0.15);color:var(--green);border:1px solid rgba(60,180,113,0.35);">‚≠ê Shortlist</span>`
                     : isOnWL     ? `<span style="font-size:0.6rem;padding:0.1rem 0.35rem;border-radius:8px;background:rgba(232,160,32,0.15);color:var(--amber);border:1px solid rgba(232,160,32,0.35);">üëÅ Watchlist</span>`
                     : isTracked  ? `<span style="font-size:0.6rem;padding:0.1rem 0.35rem;border-radius:8px;background:rgba(215,25,32,0.12);color:var(--red);border:1px solid rgba(215,25,32,0.25);">üìã Tracked</span>`
                     : '';

    // Secondary context line ‚Äî OBV rank + 90s always visible
    const obvRank  = Math.round(num(r['OBV Rank']));
    const obvCol   = obvRank >= 70 ? 'var(--green)' : obvRank >= 45 ? 'var(--amber)' : obvRank >= 25 ? '#E09450' : 'var(--crimson)';

    // Show secondary archetype ranks: top-2 if no specific archetype; next-best if specific archetype set
    let extraRanks = '';
    if (!need.archetype && archetypes.length > 1) {
      const top2 = archetypes
        .map(a => ({ name: a, rank: Math.round(num(r[`${a} Rank`])) }))
        .sort((a,b) => b.rank - a.rank)
        .slice(0, 2);
      extraRanks = `<div style="font-size:0.62rem;color:var(--muted);margin-top:0.15rem;">${top2.map(a => `${a.name}: <strong style="color:var(--text)">${a.rank}</strong>`).join(' ¬∑ ')}</div>`;
    } else if (need.archetype) {
      // Show next-best archetype from the position set
      const pos = r['Position'];
      const allArchs = POSITION_ARCHETYPES[pos] || Object.keys(MODELS);
      const nextBest = allArchs
        .filter(a => a !== need.archetype)
        .map(a => ({ name: a, rank: Math.round(num(r[`${a} Rank`])) }))
        .sort((a,b) => b.rank - a.rank)[0];
      if (nextBest) {
        extraRanks = `<div style="font-size:0.62rem;color:var(--muted);margin-top:0.15rem;">Also: ${nextBest.name} <strong style="color:var(--text)">${nextBest.rank}</strong></div>`;
      }
    }

    return `<div class="target-player-card" onclick="openProfile(${idx})">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.3rem;margin-bottom:0.2rem;">
        <div class="target-rank-badge">#${i+1}</div>
        <div style="display:flex;gap:0.25rem;flex-wrap:wrap;justify-content:flex-end;">${trackBadge}</div>
      </div>
      <div class="target-player-name">${r['Player Name']}</div>
      <div class="target-player-meta">${[r['Team'], r['League']].filter(Boolean).join(' ¬∑ ')}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;font-size:0.68rem;color:var(--muted);margin:0.3rem 0 0.1rem;">
        <span>Age ${r['Age']} ¬∑ ${nineties} 90s</span>
        <span style="color:${barColor};font-weight:700;font-size:0.82rem;">${rank}<span style="font-size:0.62rem;font-weight:400;opacity:0.7;">%ile</span></span>
      </div>
      <div class="target-score-bar" style="margin-bottom:0.3rem;">
        <div class="target-score-fill" style="width:${rank}%;background:${barColor};"></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;font-size:0.62rem;">
        <span style="color:var(--muted);">OBV <span style="color:${obvCol};font-weight:700;">${obvRank}</span></span>
        ${extraRanks ? extraRanks : ''}
      </div>
    </div>`;
  }).join('')
  : `<div class="target-empty-results">No players match these criteria. Try relaxing the filters.</div>`;

  return `<div class="target-result-block">
    <div class="target-result-header">
      <div>
        <div class="target-result-title">${label}</div>
        <div class="target-result-sub">${subParts}</div>
      </div>
    </div>
    <div class="target-players-grid">${cards}</div>
  </div>`;
}

// ‚îÄ‚îÄ PIPELINE BOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PIPELINE_STAGES = ['Track', 'Video Scout', 'Senior Viewing', 'Shortlist', 'Push'];

const PIPELINE_STAGE_COLORS = {
  'Track':          { accent:'#888',    text:'#999',    bg:'rgba(136,136,136,0.12)' },
  'Video Scout':    { accent:'#5B8FD4', text:'#7DB8F0', bg:'rgba(80,140,220,0.12)'  },
  'Senior Viewing': { accent:'#C89020', text:'#E8B84A', bg:'rgba(232,160,32,0.12)'  },
  'Shortlist':      { accent:'#3CB371', text:'#5ECBA1', bg:'rgba(60,180,130,0.12)'  },
  'Push':           { accent:'#D71920', text:'#F05060', bg:'rgba(215,25,32,0.12)'   },
};

let dragKey = null;
let pipelineRec         = '';
let pipelineSort        = 'updated';
let pipelineStageFilter = ''; // '' = show all columns; set to a stage to collapse to just that column

function setPipelineRec(val) {
  pipelineRec = val;
  ['all','yes','mon','no','none'].forEach(id => {
    document.getElementById(`pipe-rec-${id}`)?.classList.remove('active');
  });
  const map = { '':'all','Recommended':'yes','Monitor':'mon','Not Recommended':'no','__none__':'none' };
  document.getElementById(`pipe-rec-${map[val] || 'all'}`)?.classList.add('active');
  renderPipeline();
}

function togglePipelineStage(stage) {
  pipelineStageFilter = pipelineStageFilter === stage ? '' : stage;
  renderPipeline();
}

function setPipelineSort(val) {
  pipelineSort = val;
  renderPipeline();
}

function pipelinePassesFilter(key) {
  const r = reports[key];
  if (!r) return false;
  if (pipelineRec === '__none__') return !r.recommendation;
  if (pipelineRec) return r.recommendation === pipelineRec;
  return true;
}

function pipelineSortFn(a, b) {
  const rA = reports[a], rB = reports[b];
  // Pinned always first regardless of sort
  if (rB.pinned && !rA.pinned) return 1;
  if (rA.pinned && !rB.pinned) return -1;

  if (pipelineSort === 'name') {
    return (rA.name||'').localeCompare(rB.name||'');
  }
  if (pipelineSort === 'days_asc' || pipelineSort === 'days_desc') {
    const stageA = rA.trackingStage;
    const stageB = rB.trackingStage;
    const tA = rA.stageHistory?.[stageA] || rA.createdAt || 0;
    const tB = rB.stageHistory?.[stageB] || rB.createdAt || 0;
    return pipelineSort === 'days_asc' ? tA - tB : tB - tA;
  }
  // default: recently updated
  return (rB.updatedAt||0) - (rA.updatedAt||0);
}

function renderPipeline() {
  const allKeys = Object.keys(reports);
  const badge = document.getElementById('pipeline-badge');
  if (badge) { badge.textContent = allKeys.length; badge.classList.toggle('visible', allKeys.length > 0); }

  // Summary row ‚Äî always shows totals unfiltered
  const summaryEl = document.getElementById('pipeline-summary');
  if (summaryEl) {
    summaryEl.innerHTML = PIPELINE_STAGES.map(stage => {
      const c        = PIPELINE_STAGE_COLORS[stage];
      const total    = allKeys.filter(k => reports[k].trackingStage === stage).length;
      const visible  = allKeys.filter(k => reports[k].trackingStage === stage && pipelinePassesFilter(k)).length;
      const countLabel = pipelineRec ? `${visible}/${total}` : `${total}`;
      const isActive = pipelineStageFilter === stage;
      const activeCls = isActive ? ' active' : '';
      const hint = isActive ? 'Click to show all stages' : 'Click to focus this stage';
      return `<div class="pipeline-summary-card${activeCls}" style="border-top-color:${c.accent}" onclick="togglePipelineStage('${stage}')" title="${hint}">
        <div class="pipeline-summary-num" style="color:${c.accent}">${countLabel}</div>
        <div class="pipeline-summary-lbl">${stage}</div>
        ${isActive ? `<div style="font-size:0.58rem;color:var(--muted);margin-top:0.3rem;letter-spacing:0.5px;">FOCUSED ‚úï</div>` : ''}
      </div>`;
    }).join('');
  }

  // Kanban columns
  const boardEl = document.getElementById('pipeline-board');
  if (!boardEl) return;

  // When a stage is focused, collapse to single column; otherwise show all 5
  boardEl.style.gridTemplateColumns = pipelineStageFilter ? '1fr' : 'repeat(5,1fr)';

  boardEl.innerHTML = PIPELINE_STAGES
    .filter(stage => !pipelineStageFilter || stage === pipelineStageFilter)
    .map(stage => {
    const c = PIPELINE_STAGE_COLORS[stage];
    const stageKeys = allKeys
      .filter(k => reports[k].trackingStage === stage && pipelinePassesFilter(k))
      .sort(pipelineSortFn);

    const cards = stageKeys.length
      ? stageKeys.map(k => pipelineCardHTML(k, c)).join('')
      : `<div class="pipeline-empty">${pipelineRec ? 'No matching players' : 'Drop players here'}</div>`;

    const safeStage = stage.replace(/\s/g, '_');
    return `<div class="pipeline-col" id="pipe-col-${safeStage}"
        ondragover="pipeDragOver(event,'${stage}')"
        ondragleave="pipeDragLeave(event,'${stage}')"
        ondrop="pipeDrop(event,'${stage}')">
      <div class="pipeline-col-header" style="border-top:3px solid ${c.accent}">
        <span class="pipeline-col-title" style="color:${c.text}">${stage}</span>
        <span class="pipeline-col-count">${stageKeys.length}</span>
      </div>
      <div class="pipeline-col-body" id="pipe-body-${safeStage}">${cards}</div>
    </div>`;
  }).join('');

  // Meta line
  const unassigned = allKeys.filter(k => !reports[k].trackingStage);
  const metaEl = document.getElementById('pipeline-meta');
  if (metaEl) {
    const filterNote = pipelineRec ? ` ¬∑ Filtered to: ${pipelineRec === '__none__' ? 'No verdict' : pipelineRec}` : '';
    const stageNote  = pipelineStageFilter ? ` ¬∑ Focused: ${pipelineStageFilter}` : '';
    metaEl.textContent = unassigned.length
      ? `${allKeys.length} players tracked ¬∑ ${unassigned.length} unassigned${filterNote}${stageNote}`
      : `${allKeys.length} players tracked ¬∑ Drag cards to update stage${filterNote}${stageNote}`;
  }
}

function pipelineCardHTML(key, stageColor) {
  const r = reports[key];
  const pinIcon = r.pinned ? '<span class="pipeline-card-pin">üìå</span>' : '';
  const pos = r.position || '‚Äî';
  const age = r.age ? `Age ${r.age}` : '';
  const archBadge = r.position ? `<span style="font-size:0.62rem;padding:0.1rem 0.4rem;border-radius:10px;background:rgba(215,25,32,0.15);color:var(--red);border:1px solid rgba(215,25,32,0.25);">${pos}</span>` : '';
  const conclusionSnippet = r.conclusion?.trim()
    ? `<div style="font-size:0.68rem;color:var(--amber);font-style:italic;margin-top:0.35rem;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">"${r.conclusion}"</div>`
    : '';

  // Days in current stage
  let daysLabel = '';
  if (r.trackingStage && r.stageHistory?.[r.trackingStage]) {
    const days = Math.floor((Date.now() - r.stageHistory[r.trackingStage]) / 86400000);
    const daysColor = days >= 14 ? 'var(--crimson)' : days >= 7 ? 'var(--amber)' : 'var(--muted)';
    daysLabel = `<span style="font-size:0.62rem;color:${daysColor};" title="Days in this stage">${days === 0 ? 'Today' : days === 1 ? '1 day' : `${days} days`}</span>`;
  } else if (r.createdAt) {
    const days = Math.floor((Date.now() - r.createdAt) / 86400000);
    const daysColor = days >= 14 ? 'var(--crimson)' : days >= 7 ? 'var(--amber)' : 'var(--muted)';
    daysLabel = `<span style="font-size:0.62rem;color:${daysColor};" title="Days tracked">${days === 0 ? 'Today' : days === 1 ? '1 day' : `${days} days`}</span>`;
  }

  // Recommendation badge
  const recColor = RECOMMENDATION_COLORS[r.recommendation||''] || 'var(--muted)';
  const recBadge = r.recommendation
    ? `<div style="font-size:0.6rem;font-weight:700;color:${recColor};letter-spacing:0.3px;margin-top:0.25rem;text-transform:uppercase;">${r.recommendation === 'Recommended' ? '‚úì' : r.recommendation === 'Not Recommended' ? '‚úó' : '~'} ${r.recommendation}</div>`
    : '';

  return `<div class="pipeline-card" draggable="true"
      id="pipe-card-${CSS.escape(key)}"
      ondragstart="pipeDragStart(event,'${key.replace(/'/g,"\\'")}')">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.3rem;">
      <div class="pipeline-card-name">${r.name || '‚Äî'}</div>
      ${pinIcon}
    </div>
    <div class="pipeline-card-meta">${[r.team, r.league].filter(Boolean).join(' ¬∑ ') || '‚Äî'}</div>
    <div class="pipeline-card-footer">
      ${archBadge}
      <span class="pipeline-card-age">${age}</span>
      ${daysLabel}
      <span class="pipeline-card-open" onclick="openPipelineReport('${key.replace(/'/g,"\\'")}')">Open ‚Üí</span>
    </div>
    ${recBadge}
    ${conclusionSnippet}
  </div>`;
}

function pipeDragStart(e, key) {
  dragKey = key;
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => {
    const el = document.getElementById(`pipe-card-${CSS.escape(key)}`);
    if (el) el.classList.add('dragging');
  }, 0);
}

function pipeDragOver(e, stage) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const safeStage = stage.replace(/\s/g,'_');
  document.getElementById(`pipe-body-${safeStage}`)?.classList.add('drag-over');
}

function pipeDragLeave(e, stage) {
  const safeStage = stage.replace(/\s/g,'_');
  document.getElementById(`pipe-body-${safeStage}`)?.classList.remove('drag-over');
}

function pipeDrop(e, stage) {
  e.preventDefault();
  const safeStage = stage.replace(/\s/g,'_');
  document.getElementById(`pipe-body-${safeStage}`)?.classList.remove('drag-over');
  if (!dragKey || !reports[dragKey]) return;
  const prev = reports[dragKey].trackingStage;
  reports[dragKey].trackingStage = stage;
  reports[dragKey].updatedAt = Date.now();
  if (stage !== prev) {
    if (!reports[dragKey].stageHistory) reports[dragKey].stageHistory = {};
    if (stage) reports[dragKey].stageHistory[stage] = Date.now();
  }
  persistReports();
  dragKey = null;
  renderPipeline();
}

function openPipelineReport(key) {
  showPage('reports');
  setTimeout(() => openReport(key), 100);
}

function updatePipelineBadge() {
  const count = Object.keys(reports).length;
  const badge = document.getElementById('pipeline-badge');
  if (badge) { badge.textContent = count; badge.classList.toggle('visible', count > 0); }
}

// ‚îÄ‚îÄ KEYBOARD TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let kbdToastTimer = null;
function showKbdToast(msg) {
  const el = document.getElementById('kbd-toast');
  if (!el) return;
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(kbdToastTimer);
  kbdToastTimer = setTimeout(() => el.classList.remove('show'), 1800);
}

updateShortlistBadge();
updateReportsBadge();
</script>
<!-- COMPARE MODAL -->
<div class="modal-overlay" id="compare-modal" onclick="handleCompareModalClick(event)">
  <div class="modal" id="compare-modal-inner" style="max-width:1100px;">
    <div class="modal-header">
      <div>
        <div class="modal-player-name">PLAYER COMPARISON</div>
        <div class="modal-player-meta" id="compare-subtitle">Select a second player to compare</div>
      </div>
      <button class="modal-close" onclick="closeCompareModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="compare-search-wrap">
        <div style="flex:1;position:relative;">
          <input type="text" id="compare-search-input" placeholder="Search for a player to compare against..." oninput="compareSearch()" style="width:100%;">
          <div class="compare-suggestions" id="compare-suggestions"></div>
        </div>
      </div>
      <div id="compare-body">
        <div style="text-align:center;padding:3rem;color:var(--muted);font-size:0.88rem;">Search for a second player above to begin the comparison</div>
      </div>
    </div>
  </div>
</div>

<div id="kbd-toast"></div>

</body>
</html>
